<h1 id="chapter-10-settings---your-programs-control-panel">Chapter 10: Settings - Your Program’s Control Panel</h1>

<p>Welcome to the final chapter of our introductory DSPy tutorial! In <a href="09_adapter.md">Chapter 9: Adapter</a>, we saw how Adapters act as translators, allowing our DSPy programs to communicate seamlessly with different types of Language Models (LMs).</p>

<p>Throughout the previous chapters, we’ve seen snippets like <code class="language-plaintext highlighter-rouge">dspy.settings.configure(lm=...)</code> and <code class="language-plaintext highlighter-rouge">dspy.settings.configure(rm=...)</code>. We mentioned that modules like <code class="language-plaintext highlighter-rouge">dspy.Predict</code> or <code class="language-plaintext highlighter-rouge">dspy.Retrieve</code> automatically find and use these configured components. But how does this central configuration work? How do we manage these important defaults for our entire project?</p>

<p>That’s where <strong><code class="language-plaintext highlighter-rouge">dspy.settings</code></strong> comes in! It’s the central control panel for your DSPy project.</p>

<p>Think of <code class="language-plaintext highlighter-rouge">dspy.settings</code> like the <strong>Defaults menu</strong> in a software application:</p>
<ul>
  <li>You set your preferred font, theme, or language once in the settings.</li>
  <li>The entire application then uses these defaults unless you specifically choose something different for a particular document or window.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">dspy.settings</code> does the same for your DSPy programs. It holds the default <a href="05_lm__language_model_client_.md">LM (Language Model Client)</a>, <a href="06_rm__retrieval_model_client_.md">RM (Retrieval Model Client)</a>, and <a href="09_adapter.md">Adapter</a> that your modules will use.</p>

<p>In this chapter, you’ll learn:</p>

<ul>
  <li>Why a central settings object is useful.</li>
  <li>How to configure global defaults using <code class="language-plaintext highlighter-rouge">dspy.settings.configure</code>.</li>
  <li>How modules automatically use these settings.</li>
  <li>How to temporarily override settings for specific parts of your code using <code class="language-plaintext highlighter-rouge">dspy.context</code>.</li>
</ul>

<p>Let’s learn how to manage our program’s defaults!</p>

<h2 id="why-use-dspysettings">Why Use <code class="language-plaintext highlighter-rouge">dspy.settings</code>?</h2>

<p>Imagine building a complex DSPy <a href="01_module___program.md">Program</a> with many sub-modules that need to call an LM or an RM. Without a central settings object, you might have to pass the LM and RM instances explicitly to every single module during initialization or when calling them. This would be tedious and make your code harder to manage.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- WITHOUT dspy.settings (Conceptual - DON'T DO THIS) ---
</span><span class="kn">import</span> <span class="nn">dspy</span>

<span class="c1"># Assume lm_instance and rm_instance are created somewhere
</span>
<span class="k">class</span> <span class="nc">GenerateSearchQuery</span><span class="p">(</span><span class="n">dspy</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lm</span><span class="p">):</span> <span class="c1"># Needs LM passed in
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">dspy</span><span class="p">.</span><span class="n">Predict</span><span class="p">(</span><span class="s">'question -&gt; query'</span><span class="p">,</span> <span class="n">lm</span><span class="o">=</span><span class="n">lm</span><span class="p">)</span> <span class="c1"># Pass LM to Predict
</span>    <span class="c1"># ... forward ...
</span>
<span class="k">class</span> <span class="nc">RetrieveContext</span><span class="p">(</span><span class="n">dspy</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm</span><span class="p">):</span> <span class="c1"># Needs RM passed in
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">retriever</span> <span class="o">=</span> <span class="n">dspy</span><span class="p">.</span><span class="n">Retrieve</span><span class="p">(</span><span class="n">rm</span><span class="o">=</span><span class="n">rm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># Pass RM to Retrieve
</span>    <span class="c1"># ... forward ...
</span>
<span class="c1"># ... other modules needing lm or rm ...
</span>
<span class="k">class</span> <span class="nc">ComplexRAG</span><span class="p">(</span><span class="n">dspy</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">rm</span><span class="p">):</span> <span class="c1"># Needs LM and RM passed in
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">gen_query</span> <span class="o">=</span> <span class="n">GenerateSearchQuery</span><span class="p">(</span><span class="n">lm</span><span class="o">=</span><span class="n">lm</span><span class="p">)</span> <span class="c1"># Pass LM down
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">retrieve</span> <span class="o">=</span> <span class="n">RetrieveContext</span><span class="p">(</span><span class="n">rm</span><span class="o">=</span><span class="n">rm</span><span class="p">)</span>    <span class="c1"># Pass RM down
</span>        <span class="c1"># ... other sub-modules needing lm or rm ...
</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">lm</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rm</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="c1"># Maybe pass them here too? Messy!
</span>        <span class="c1"># ... use sub-modules ...
</span></code></pre></div></div>
<p>This gets complicated quickly!</p>

<p><code class="language-plaintext highlighter-rouge">dspy.settings</code> solves this by providing a single, global place to store these configurations. You configure it once, and all DSPy modules can access the defaults they need automatically.</p>

<h2 id="configuring-global-defaults">Configuring Global Defaults</h2>

<p>The primary way to set defaults is using the <code class="language-plaintext highlighter-rouge">dspy.settings.configure</code> method. You typically do this once near the beginning of your script or application.</p>

<p>Let’s set up a default LM and RM:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">dspy</span>

<span class="c1"># 1. Create your LM and RM instances (as seen in Chapters 5 &amp; 6)
# Example using OpenAI and a dummy RM
</span><span class="k">try</span><span class="p">:</span>
    <span class="c1"># Assumes OPENAI_API_KEY is set
</span>    <span class="n">turbo</span> <span class="o">=</span> <span class="n">dspy</span><span class="p">.</span><span class="n">LM</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s">'openai/gpt-3.5-turbo-instruct'</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Note: dspy[openai] not installed. Using dummy LM."</span><span class="p">)</span>
    <span class="c1"># Define a dummy LM if OpenAI isn't available
</span>    <span class="k">class</span> <span class="nc">DummyLM</span><span class="p">(</span><span class="n">dspy</span><span class="p">.</span><span class="n">LM</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s">"dummy"</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">basic_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="s">"choices"</span><span class="p">:</span> <span class="p">[{</span><span class="s">"text"</span><span class="p">:</span> <span class="s">"Dummy LM Response"</span><span class="p">}]}</span>
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="s">"Dummy LM Response"</span><span class="p">]</span>
    <span class="n">turbo</span> <span class="o">=</span> <span class="n">DummyLM</span><span class="p">()</span>


<span class="c1"># Dummy RM for demonstration
</span><span class="k">class</span> <span class="nc">DummyRM</span><span class="p">(</span><span class="n">dspy</span><span class="p">.</span><span class="n">Retrieve</span><span class="p">):</span>
     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span> <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
     <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
         <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="p">.</span><span class="n">k</span>
         <span class="k">return</span> <span class="n">dspy</span><span class="p">.</span><span class="n">Prediction</span><span class="p">(</span><span class="n">passages</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s">"Dummy passage </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s"> for '</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s">'"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)])</span>
<span class="n">my_rm</span> <span class="o">=</span> <span class="n">DummyRM</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># 2. Configure dspy.settings with these instances
</span><span class="n">dspy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">configure</span><span class="p">(</span><span class="n">lm</span><span class="o">=</span><span class="n">turbo</span><span class="p">,</span> <span class="n">rm</span><span class="o">=</span><span class="n">my_rm</span><span class="p">)</span>

<span class="c1"># That's it! Defaults are now set globally.
</span><span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Default LM: </span><span class="si">{</span><span class="n">dspy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">lm</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Default RM: </span><span class="si">{</span><span class="n">dspy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">rm</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Output (example):</strong></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Default LM: LM(model='openai/gpt-3.5-turbo-instruct', temperature=0.0, max_tokens=100, ...) # Or DummyLM
Default RM: Retrieve(k=3) # Or DummyRM
</code></pre></div></div>

<p>Now, any <code class="language-plaintext highlighter-rouge">dspy.Predict</code>, <code class="language-plaintext highlighter-rouge">dspy.ChainOfThought</code>, or <code class="language-plaintext highlighter-rouge">dspy.Retrieve</code> module created <em>after</em> this configuration will automatically use <code class="language-plaintext highlighter-rouge">turbo</code> as the LM and <code class="language-plaintext highlighter-rouge">my_rm</code> as the RM, unless told otherwise explicitly.</p>

<h2 id="how-modules-use-the-settings">How Modules Use the Settings</h2>

<p>Modules like <code class="language-plaintext highlighter-rouge">dspy.Predict</code> and <code class="language-plaintext highlighter-rouge">dspy.Retrieve</code> are designed to look for their required components (LM or RM) in <code class="language-plaintext highlighter-rouge">dspy.settings</code> if they aren’t provided directly.</p>

<p>Consider <code class="language-plaintext highlighter-rouge">dspy.Predict</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">dspy</span>
<span class="c1"># Assume settings were configured as above
</span>
<span class="c1"># Create a Predict module WITHOUT passing 'lm' explicitly
</span><span class="n">simple_predictor</span> <span class="o">=</span> <span class="n">dspy</span><span class="p">.</span><span class="n">Predict</span><span class="p">(</span><span class="s">'input -&gt; output'</span><span class="p">)</span>

<span class="c1"># When we call it, it will automatically use dspy.settings.lm
</span><span class="n">result</span> <span class="o">=</span> <span class="n">simple_predictor</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s">"Tell me a fact."</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">output</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Output (using DummyLM):</strong></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dummy LM Response
</code></pre></div></div>

<p>Inside its <code class="language-plaintext highlighter-rouge">forward</code> method, <code class="language-plaintext highlighter-rouge">dspy.Predict</code> essentially does this (simplified):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified internal logic of dspy.Predict.forward()
</span><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="c1"># ... get signature, demos, config ...
</span>
  <span class="c1"># Get the LM: Use 'lm' passed in kwargs, OR self.lm (if set), OR dspy.settings.lm
</span>  <span class="n">lm_to_use</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">"lm"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">lm</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dspy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">lm</span>
  <span class="k">assert</span> <span class="n">lm_to_use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">"No LM configured!"</span>

  <span class="c1"># ... format prompt using signature/demos/inputs ...
</span>  <span class="c1"># ... call lm_to_use(prompt, ...) ...
</span>  <span class="c1"># ... parse output ...
</span>  <span class="c1"># ... return Prediction ...
</span></code></pre></div></div>

<p>Similarly, <code class="language-plaintext highlighter-rouge">dspy.Retrieve</code> looks for <code class="language-plaintext highlighter-rouge">dspy.settings.rm</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">dspy</span>
<span class="c1"># Assume settings were configured as above
</span>
<span class="c1"># Create a Retrieve module WITHOUT passing 'rm' explicitly
</span><span class="n">retriever</span> <span class="o">=</span> <span class="n">dspy</span><span class="p">.</span><span class="n">Retrieve</span><span class="p">()</span> <span class="c1"># Uses default k=3 from DummyRM initialization
</span>
<span class="c1"># When called, it uses dspy.settings.rm
</span><span class="n">results</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s">"DSPy benefits"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="n">passages</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Output (using DummyRM):</strong></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>["Dummy passage 1 for 'DSPy benefits'", "Dummy passage 2 for 'DSPy benefits'", "Dummy passage 3 for 'DSPy benefits'"]
</code></pre></div></div>

<p>This automatic lookup makes your program code much cleaner, as you don’t need to thread the <code class="language-plaintext highlighter-rouge">lm</code> and <code class="language-plaintext highlighter-rouge">rm</code> objects through every part of your application.</p>

<h2 id="temporary-overrides-with-dspycontext">Temporary Overrides with <code class="language-plaintext highlighter-rouge">dspy.context</code></h2>

<p>Sometimes, you might want to use a <em>different</em> LM or RM for just a specific part of your code, without changing the global default. For example, maybe you want to use a more powerful (and expensive) LM like GPT-4 for a critical reasoning step, while using a cheaper LM like GPT-3.5 for the rest of the program.</p>

<p>You can achieve this using the <code class="language-plaintext highlighter-rouge">dspy.settings.context</code> context manager. Changes made inside a <code class="language-plaintext highlighter-rouge">with dspy.settings.context(...)</code> block are <strong>thread-local</strong> and only last until the block exits.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">dspy</span>

<span class="c1"># Assume global settings have 'turbo' (GPT-3.5 or Dummy) as the LM
# dspy.settings.configure(lm=turbo, rm=my_rm)
</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Outside context: </span><span class="si">{</span><span class="n">dspy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">lm</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Let's create a more powerful (dummy) LM for demonstration
</span><span class="k">class</span> <span class="nc">DummyGPT4</span><span class="p">(</span><span class="n">dspy</span><span class="p">.</span><span class="n">LM</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s">"dummy-gpt4"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">basic_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="s">"choices"</span><span class="p">:</span> <span class="p">[{</span><span class="s">"text"</span><span class="p">:</span> <span class="s">"GPT-4 Dummy Response"</span><span class="p">}]}</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="s">"GPT-4 Dummy Response"</span><span class="p">]</span>
<span class="n">gpt4_dummy</span> <span class="o">=</span> <span class="n">DummyGPT4</span><span class="p">()</span>

<span class="c1"># Use dspy.context to temporarily switch the LM
</span><span class="k">with</span> <span class="n">dspy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="n">lm</span><span class="o">=</span><span class="n">gpt4_dummy</span><span class="p">,</span> <span class="n">rm</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="c1"># Temporarily set lm, unset rm
</span>    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Inside context: </span><span class="si">{</span><span class="n">dspy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">lm</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Inside context (RM): </span><span class="si">{</span><span class="n">dspy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">rm</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="c1"># Modules used inside this block will use the temporary settings
</span>    <span class="n">predictor_in_context</span> <span class="o">=</span> <span class="n">dspy</span><span class="p">.</span><span class="n">Predict</span><span class="p">(</span><span class="s">'input -&gt; output'</span><span class="p">)</span>
    <span class="n">result_in_context</span> <span class="o">=</span> <span class="n">predictor_in_context</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s">"Complex reasoning task"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Prediction in context: </span><span class="si">{</span><span class="n">result_in_context</span><span class="p">.</span><span class="n">output</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="c1"># Trying to use RM here would fail as it's None in this context
</span>    <span class="c1"># retriever_in_context = dspy.Retrieve()
</span>    <span class="c1"># retriever_in_context(query="something") # This would raise an error
</span>
<span class="c1"># Settings revert back automatically outside the block
</span><span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Outside context again: </span><span class="si">{</span><span class="n">dspy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">lm</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Outside context again (RM): </span><span class="si">{</span><span class="n">dspy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">rm</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Output (example):</strong></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Outside context: LM(model='openai/gpt-3.5-turbo-instruct', ...) # Or DummyLM
Inside context: LM(model='dummy-gpt4', ...)
Inside context (RM): None
Prediction in context: GPT-4 Dummy Response
Outside context again: LM(model='openai/gpt-3.5-turbo-instruct', ...) # Or DummyLM
Outside context again (RM): Retrieve(k=3) # Or DummyRM
</code></pre></div></div>

<p>Inside the <code class="language-plaintext highlighter-rouge">with</code> block, <code class="language-plaintext highlighter-rouge">dspy.settings.lm</code> temporarily pointed to <code class="language-plaintext highlighter-rouge">gpt4_dummy</code>, and <code class="language-plaintext highlighter-rouge">dspy.settings.rm</code> was temporarily <code class="language-plaintext highlighter-rouge">None</code>. The <code class="language-plaintext highlighter-rouge">predictor_in_context</code> used the temporary LM. Once the block ended, the settings automatically reverted to the global defaults.</p>

<p>This is crucial for writing clean code where different parts might need different configurations, and also essential for how DSPy’s optimizers (<a href="08_teleprompter___optimizer.md">Chapter 8: Teleprompter / Optimizer</a>) work internally to manage different model configurations during optimization.</p>

<h2 id="how-it-works-under-the-hood">How It Works Under the Hood</h2>

<p><code class="language-plaintext highlighter-rouge">dspy.settings</code> uses a combination of global variables and thread-local storage to manage configurations.</p>

<ol>
  <li><strong>Global Defaults:</strong> There’s a primary configuration dictionary (<code class="language-plaintext highlighter-rouge">main_thread_config</code>) that holds the settings configured by <code class="language-plaintext highlighter-rouge">dspy.settings.configure()</code>.</li>
  <li><strong>Ownership:</strong> To prevent race conditions in multi-threaded applications, only the <em>first</em> thread that calls <code class="language-plaintext highlighter-rouge">configure</code> becomes the “owner” and is allowed to make further global changes using <code class="language-plaintext highlighter-rouge">configure</code>.</li>
  <li><strong>Thread-Local Overrides:</strong> <code class="language-plaintext highlighter-rouge">dspy.settings.context()</code> uses Python’s <code class="language-plaintext highlighter-rouge">threading.local</code> storage. When you enter a <code class="language-plaintext highlighter-rouge">with dspy.settings.context(...)</code> block, it stores the specified overrides (<code class="language-plaintext highlighter-rouge">lm=gpt4_dummy</code>, etc.) in a place specific to the current thread.</li>
  <li><strong>Attribute Access:</strong> When code accesses <code class="language-plaintext highlighter-rouge">dspy.settings.lm</code>, the <code class="language-plaintext highlighter-rouge">Settings</code> object first checks if there’s an override for <code class="language-plaintext highlighter-rouge">lm</code> in the current thread’s local storage.
    <ul>
      <li>If yes, it returns the thread-local override.</li>
      <li>If no, it returns the value from the global <code class="language-plaintext highlighter-rouge">main_thread_config</code>.</li>
    </ul>
  </li>
  <li><strong>Context Exit:</strong> When the <code class="language-plaintext highlighter-rouge">with</code> block finishes, the <code class="language-plaintext highlighter-rouge">context</code> manager restores the thread-local storage to its state <em>before</em> the block was entered, effectively removing the temporary overrides for that thread.</li>
</ol>

<p><strong>Sequence Diagram: Module Accessing Settings</strong></p>

<pre><code class="language-mermaid">sequenceDiagram
    participant User
    participant Module as Your Module (e.g., Predict)
    participant Settings as dspy.settings
    participant ThreadLocalStorage as Thread-Local Storage
    participant GlobalConfig as Global Defaults

    User-&gt;&gt;Module: Call module(input=...)
    Module-&gt;&gt;Settings: Get configured lm (`settings.lm`)
    Settings-&gt;&gt;ThreadLocalStorage: Check for 'lm' override?
    alt Override Exists
        ThreadLocalStorage--&gt;&gt;Settings: Return thread-local lm
        Settings--&gt;&gt;Module: Return thread-local lm
    else No Override
        ThreadLocalStorage--&gt;&gt;Settings: No override found
        Settings-&gt;&gt;GlobalConfig: Get global 'lm'
        GlobalConfig--&gt;&gt;Settings: Return global lm
        Settings--&gt;&gt;Module: Return global lm
    end
    Module-&gt;&gt;Module: Use the returned lm for processing...
    Module--&gt;&gt;User: Return result
</code></pre>

<p>This mechanism ensures that global settings are the default, but thread-specific overrides via <code class="language-plaintext highlighter-rouge">dspy.context</code> take precedence when active, providing both convenience and flexibility.</p>

<p><strong>Relevant Code Files:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">dspy/dsp/utils/settings.py</code>: Defines the <code class="language-plaintext highlighter-rouge">Settings</code> class, the <code class="language-plaintext highlighter-rouge">DEFAULT_CONFIG</code>, manages global state (<code class="language-plaintext highlighter-rouge">main_thread_config</code>, <code class="language-plaintext highlighter-rouge">config_owner_thread_id</code>), uses <code class="language-plaintext highlighter-rouge">threading.local</code> for overrides, and implements the <code class="language-plaintext highlighter-rouge">configure</code> method and the <code class="language-plaintext highlighter-rouge">context</code> context manager.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified view from dspy/dsp/utils/settings.py
</span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="c1"># from dspy.dsp.utils.utils import dotdict # Simplified as dict
</span>
<span class="n">DEFAULT_CONFIG</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lm</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rm</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">adapter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="p">...)</span> <span class="c1"># Default values
</span>
<span class="c1"># Global state
</span><span class="n">main_thread_config</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">DEFAULT_CONFIG</span><span class="p">)</span>
<span class="n">config_owner_thread_id</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">global_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="c1"># Thread-local storage for overrides
</span><span class="k">class</span> <span class="nc">ThreadLocalOverrides</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">local</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">overrides</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">thread_local_overrides</span> <span class="o">=</span> <span class="n">ThreadLocalOverrides</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Settings</span><span class="p">:</span>
    <span class="n">_instance</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span> <span class="c1"># Singleton pattern
</span>        <span class="k">if</span> <span class="n">cls</span><span class="p">.</span><span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">cls</span><span class="p">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">().</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">.</span><span class="n">_instance</span>

    <span class="c1"># When you access settings.lm or settings['lm']
</span>    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># Check thread-local overrides first
</span>        <span class="n">overrides</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">thread_local_overrides</span><span class="p">,</span> <span class="s">"overrides"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">overrides</span><span class="p">:</span> <span class="k">return</span> <span class="n">overrides</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="c1"># Fall back to global config
</span>        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">main_thread_config</span><span class="p">:</span> <span class="k">return</span> <span class="n">main_thread_config</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="nb">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s">"'Settings' object has no attribute '</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__getattr__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># dspy.settings.configure(...)
</span>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">main_thread_config</span><span class="p">,</span> <span class="n">config_owner_thread_id</span>
        <span class="n">current_thread_id</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">get_ident</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span> <span class="c1"># Ensure thread safety for configuration
</span>            <span class="k">if</span> <span class="n">config_owner_thread_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">config_owner_thread_id</span> <span class="o">=</span> <span class="n">current_thread_id</span>
            <span class="k">elif</span> <span class="n">config_owner_thread_id</span> <span class="o">!=</span> <span class="n">current_thread_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">"dspy.settings can only be changed by the thread that initially configured it."</span><span class="p">)</span>

        <span class="c1"># Update global config
</span>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">.</span><span class="n">items</span><span class="p">():</span> <span class="n">main_thread_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1"># with dspy.settings.context(...)
</span>    <span class="o">@</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Save current overrides
</span>        <span class="n">original_overrides</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">thread_local_overrides</span><span class="p">,</span> <span class="s">"overrides"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Create new overrides for this context (combining global + old local + new)
</span>        <span class="n">new_overrides</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">main_thread_config</span><span class="p">,</span> <span class="o">**</span><span class="n">original_overrides</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="c1"># Apply new overrides to thread-local storage
</span>        <span class="n">thread_local_overrides</span><span class="p">.</span><span class="n">overrides</span> <span class="o">=</span> <span class="n">new_overrides</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="c1"># Code inside the 'with' block runs here
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Restore original overrides when exiting the block
</span>            <span class="n">thread_local_overrides</span><span class="p">.</span><span class="n">overrides</span> <span class="o">=</span> <span class="n">original_overrides</span>

<span class="c1"># The global instance you use
</span><span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
</code></pre></div></div>

<p>This structure elegantly handles both global defaults and safe, temporary, thread-specific overrides.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Congratulations! You’ve reached the end of this introductory DSPy tutorial and learned about <code class="language-plaintext highlighter-rouge">dspy.settings</code>, the central control panel.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">dspy.settings</code> holds <strong>global default configurations</strong> like the <a href="05_lm__language_model_client_.md">LM</a>, <a href="06_rm__retrieval_model_client_.md">RM</a>, and <a href="09_adapter.md">Adapter</a>.</li>
  <li>You configure it <strong>once</strong> using <code class="language-plaintext highlighter-rouge">dspy.settings.configure(lm=..., rm=...)</code>.</li>
  <li>DSPy modules like <code class="language-plaintext highlighter-rouge">dspy.Predict</code> and <code class="language-plaintext highlighter-rouge">dspy.Retrieve</code> automatically <strong>use these defaults</strong>, simplifying your code.</li>
  <li><code class="language-plaintext highlighter-rouge">dspy.context</code> allows for <strong>temporary, thread-local overrides</strong>, providing flexibility without affecting the global state.</li>
</ul>

<p>By mastering these 10 chapters, you’ve gained a solid foundation in the core concepts of DSPy:</p>

<ol>
  <li>Structuring programs with <a href="01_module___program.md">Modules and Programs</a>.</li>
  <li>Defining tasks with <a href="02_signature.md">Signatures</a>.</li>
  <li>Representing data with <a href="03_example.md">Examples</a>.</li>
  <li>Making basic LM calls with <a href="04_predict.md">Predict</a>.</li>
  <li>Connecting to AI brains with <a href="05_lm__language_model_client_.md">LM Clients</a>.</li>
  <li>Accessing external knowledge with <a href="06_rm__retrieval_model_client_.md">RM Clients</a>.</li>
  <li>Measuring performance with <a href="07_evaluate.md">Evaluate</a>.</li>
  <li>Automating optimization with <a href="08_teleprompter___optimizer.md">Teleprompters</a>.</li>
  <li>Ensuring compatibility with <a href="09_adapter.md">Adapters</a>.</li>
  <li>Managing configuration with <a href="10_settings.md">Settings</a>.</li>
</ol>

<p>You’re now equipped to start building, evaluating, and optimizing your own sophisticated language model pipelines with DSPy. Happy programming!</p>

<hr />

<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>
