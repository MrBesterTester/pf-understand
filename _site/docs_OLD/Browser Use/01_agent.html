<h1 id="chapter-1-the-agent---your-browser-assistants-brain">Chapter 1: The Agent - Your Browser Assistant‚Äôs Brain</h1>

<p>Welcome to the <code class="language-plaintext highlighter-rouge">Browser Use</code> tutorial! We‚Äôre excited to help you learn how to automate web tasks using the power of Large Language Models (LLMs).</p>

<p>Imagine you want to perform a simple task, like searching Google for ‚Äúcute cat pictures‚Äù and clicking on the very first image result. For a human, this is easy! You open your browser, type in the search, look at the results, and click.</p>

<p>But how do you tell a computer program to do this? It needs to understand the goal, look at the webpage like a human does, decide what to click or type next, and then actually perform those actions. This is where the <strong>Agent</strong> comes in.</p>

<h2 id="what-problem-does-the-agent-solve">What Problem Does the Agent Solve?</h2>

<p>The Agent is the core orchestrator, the ‚Äúbrain‚Äù or ‚Äúproject manager‚Äù of your browser automation task. It connects all the different pieces needed to achieve your goal. Without the Agent, you‚Äôd have a bunch of tools (like a browser controller and an LLM) but no central coordinator telling them what to do and when.</p>

<p>The Agent solves the problem of turning a high-level goal (like ‚Äúfind cat pictures‚Äù) into concrete actions on a webpage, using intelligence to adapt to what it ‚Äúsees‚Äù in the browser.</p>

<h2 id="meet-the-agent-your-project-manager">Meet the Agent: Your Project Manager</h2>

<p>Think of the <code class="language-plaintext highlighter-rouge">Agent</code> like a project manager overseeing a complex task. It doesn‚Äôt do <em>all</em> the work itself, but it coordinates specialists:</p>

<ol>
  <li><strong>Receives the Task:</strong> You give the Agent the overall goal (e.g., ‚ÄúSearch Google for ‚Äòcute cat pictures‚Äô and click the first image result.‚Äù).</li>
  <li><strong>Consults the Planner (LLM):</strong> The Agent shows the current state of the webpage (using the <a href="03_browsercontext.md">BrowserContext</a>) to a Large Language Model (LLM). It asks, ‚ÄúHere‚Äôs the goal, and here‚Äôs what the webpage looks like right now. What should be the very next step?‚Äù The LLM acts as a smart planner, suggesting actions like ‚Äútype ‚Äòcute cat pictures‚Äô into the search bar‚Äù or ‚Äúclick the element with index 5‚Äù. We‚Äôll learn more about how we instruct the LLM in the <a href="02_system_prompt.md">System Prompt</a> chapter.</li>
  <li><strong>Manages History:</strong> The Agent keeps track of everything that has happened so far ‚Äì the actions taken, the results, and the state of the browser at each step. This ‚Äúmemory‚Äù is managed by the <a href="06_message_manager.md">Message Manager</a> and helps the LLM make better decisions.</li>
  <li><strong>Instructs the Doer (Controller):</strong> Once the LLM suggests an action (like ‚Äúclick element 5‚Äù), the Agent tells the <a href="05_action_controller___registry.md">Action Controller &amp; Registry</a> to actually perform that specific action within the browser.</li>
  <li><strong>Observes the Results (BrowserContext):</strong> After the Controller acts, the Agent uses the <a href="03_browsercontext.md">BrowserContext</a> again to see the new state of the webpage (e.g., the Google search results page).</li>
  <li><strong>Repeats:</strong> The Agent repeats steps 2-5, continuously consulting the LLM, instructing the Controller, and observing the results, until the original task is complete or it reaches a stopping point.</li>
</ol>

<h2 id="using-the-agent-a-simple-example">Using the Agent: A Simple Example</h2>

<p>Let‚Äôs see how you might use the Agent in Python code. Don‚Äôt worry about understanding every detail yet; focus on the main idea. We‚Äôre setting up the Agent with our task and the necessary components.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- Simplified Example ---
# We need to import the necessary parts from the browser_use library
</span><span class="kn">from</span> <span class="nn">browser_use</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Browser</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">BrowserConfig</span><span class="p">,</span> <span class="n">BrowserContextConfig</span>
<span class="c1"># Assume 'my_llm' is your configured Large Language Model (e.g., from OpenAI, Anthropic)
</span><span class="kn">from</span> <span class="nn">my_llm_setup</span> <span class="kn">import</span> <span class="n">my_llm</span> <span class="c1"># Placeholder for your specific LLM setup
</span>
<span class="c1"># 1. Define the task for the Agent
</span><span class="n">my_task</span> <span class="o">=</span> <span class="s">"Go to google.com, search for 'cute cat pictures', and click the first image result."</span>

<span class="c1"># 2. Basic browser configuration (we'll learn more later)
</span><span class="n">browser_config</span> <span class="o">=</span> <span class="n">BrowserConfig</span><span class="p">()</span> <span class="c1"># Default settings
</span><span class="n">context_config</span> <span class="o">=</span> <span class="n">BrowserContextConfig</span><span class="p">()</span> <span class="c1"># Default settings
</span>
<span class="c1"># 3. Initialize the components the Agent needs
# The Browser manages the underlying browser application
</span><span class="n">browser</span> <span class="o">=</span> <span class="n">Browser</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">browser_config</span><span class="p">)</span>
<span class="c1"># The Controller knows *how* to perform actions like 'click' or 'type'
</span><span class="n">controller</span> <span class="o">=</span> <span class="n">Controller</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># The BrowserContext represents a single browser tab/window environment
</span>    <span class="c1"># It uses the Browser and its configuration
</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">BrowserContext</span><span class="p">(</span><span class="n">browser</span><span class="o">=</span><span class="n">browser</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">context_config</span><span class="p">)</span> <span class="k">as</span> <span class="n">browser_context</span><span class="p">:</span>

        <span class="c1"># 4. Create the Agent instance!
</span>        <span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
            <span class="n">task</span><span class="o">=</span><span class="n">my_task</span><span class="p">,</span>
            <span class="n">llm</span><span class="o">=</span><span class="n">my_llm</span><span class="p">,</span>                <span class="c1"># The "brain" - the Language Model
</span>            <span class="n">browser_context</span><span class="o">=</span><span class="n">browser_context</span><span class="p">,</span> <span class="c1"># The "eyes" - interacts with the browser tab
</span>            <span class="n">controller</span><span class="o">=</span><span class="n">controller</span>          <span class="c1"># The "hands" - executes actions
</span>            <span class="c1"># Many other settings can be configured here!
</span>        <span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Agent created. Starting task: </span><span class="si">{</span><span class="n">my_task</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="c1"># 5. Run the Agent! This starts the loop.
</span>        <span class="c1"># It will keep taking steps until the task is done or it hits the limit.
</span>        <span class="n">history</span> <span class="o">=</span> <span class="k">await</span> <span class="n">agent</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span> <span class="c1"># Limit steps for safety
</span>
        <span class="c1"># 6. Check the result
</span>        <span class="k">if</span> <span class="n">history</span><span class="p">.</span><span class="n">is_done</span><span class="p">()</span> <span class="ow">and</span> <span class="n">history</span><span class="p">.</span><span class="n">is_successful</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"‚úÖ Agent finished the task successfully!"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Final message from agent: </span><span class="si">{</span><span class="n">history</span><span class="p">.</span><span class="n">final_result</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"‚ö†Ô∏è Agent stopped. Maybe max_steps reached or task wasn't completed successfully."</span><span class="p">)</span>

    <span class="c1"># The 'async with' block automatically cleans up the browser_context
</span>    <span class="k">await</span> <span class="n">browser</span><span class="p">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Close the browser application
</span>
<span class="c1"># Run the asynchronous function
</span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>What happens when you run this?</strong></p>

<ol>
  <li>An <code class="language-plaintext highlighter-rouge">Agent</code> object is created with your task, the LLM, the browser context, and the controller.</li>
  <li>Calling <code class="language-plaintext highlighter-rouge">agent.run(max_steps=15)</code> starts the main loop.</li>
  <li>The Agent gets the initial state of the browser (likely a blank page).</li>
  <li>It asks the LLM what to do. The LLM might say ‚ÄúGo to google.com‚Äù.</li>
  <li>The Agent tells the Controller to execute the ‚Äúgo to URL‚Äù action.</li>
  <li>The browser navigates to Google.</li>
  <li>The Agent gets the new state (Google‚Äôs homepage).</li>
  <li>It asks the LLM again. The LLM says ‚ÄúType ‚Äòcute cat pictures‚Äô into the search bar‚Äù.</li>
  <li>The Agent tells the Controller to type the text.</li>
  <li>This continues step-by-step: pressing Enter, seeing results, asking the LLM, clicking the image.</li>
  <li>Eventually, the LLM will hopefully tell the Agent the task is ‚Äúdone‚Äù.</li>
  <li><code class="language-plaintext highlighter-rouge">agent.run()</code> finishes and returns the <code class="language-plaintext highlighter-rouge">history</code> object containing details of what happened.</li>
</ol>

<h2 id="how-it-works-under-the-hood-the-agent-loop">How it Works Under the Hood: The Agent Loop</h2>

<p>Let‚Äôs visualize the process with a simple diagram:</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant User
    participant Agent
    participant LLM
    participant Controller
    participant BC as BrowserContext

    User-&gt;&gt;Agent: Start task("Search Google for cats...")
    Note over Agent: Agent Loop Starts
    Agent-&gt;&gt;BC: Get current state (e.g., blank page)
    BC--&gt;&gt;Agent: Current Page State
    Agent-&gt;&gt;LLM: What's next? (Task + State + History)
    LLM--&gt;&gt;Agent: Plan: [Action: Type 'cute cat pictures', Action: Press Enter]
    Agent-&gt;&gt;Controller: Execute: type_text(...)
    Controller-&gt;&gt;BC: Perform type action
    Agent-&gt;&gt;Controller: Execute: press_keys('Enter')
    Controller-&gt;&gt;BC: Perform press action
    Agent-&gt;&gt;BC: Get new state (search results page)
    BC--&gt;&gt;Agent: New Page State
    Agent-&gt;&gt;LLM: What's next? (Task + New State + History)
    LLM--&gt;&gt;Agent: Plan: [Action: click_element(index=5)]
    Agent-&gt;&gt;Controller: Execute: click_element(index=5)
    Controller-&gt;&gt;BC: Perform click action
    Note over Agent: Loop continues until done...
    LLM--&gt;&gt;Agent: Plan: [Action: done(success=True, text='Found cat picture!')]
    Agent-&gt;&gt;Controller: Execute: done(...)
    Controller--&gt;&gt;Agent: ActionResult (is_done=True)
    Note over Agent: Agent Loop Ends
    Agent-&gt;&gt;User: Return History (Task Complete)

</code></pre>

<p>The core of the <code class="language-plaintext highlighter-rouge">Agent</code> lives in the <code class="language-plaintext highlighter-rouge">agent/service.py</code> file. The <code class="language-plaintext highlighter-rouge">Agent</code> class manages the overall process.</p>

<ol>
  <li>
    <p><strong>Initialization (<code class="language-plaintext highlighter-rouge">__init__</code>)</strong>: When you create an <code class="language-plaintext highlighter-rouge">Agent</code>, it sets up its internal state, stores the task, the LLM, the controller, and prepares the <a href="06_message_manager.md">Message Manager</a> to keep track of the conversation history. It also figures out the best way to talk to the specific LLM you provided.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- File: agent/service.py (Simplified __init__) ---
</span><span class="k">class</span> <span class="nc">Agent</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span>
        <span class="n">browser_context</span><span class="p">:</span> <span class="n">BrowserContext</span><span class="p">,</span>
        <span class="n">controller</span><span class="p">:</span> <span class="n">Controller</span><span class="p">,</span>
        <span class="c1"># ... other settings like use_vision, max_failures, etc.
</span>        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">browser_context</span> <span class="o">=</span> <span class="n">browser_context</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">controller</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">AgentSettings</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># Store various settings
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">AgentState</span><span class="p">()</span> <span class="c1"># Internal state (step count, failures, etc.)
</span>
        <span class="c1"># Setup message manager for history, using the task and system prompt
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_message_manager</span> <span class="o">=</span> <span class="n">MessageManager</span><span class="p">(</span>
            <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">task</span><span class="p">,</span>
            <span class="n">system_message</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">system_prompt_class</span><span class="p">(...).</span><span class="n">get_system_message</span><span class="p">(),</span>
            <span class="n">settings</span><span class="o">=</span><span class="n">MessageManagerSettings</span><span class="p">(...)</span>
            <span class="c1"># ... more setup ...
</span>        <span class="p">)</span>
        <span class="c1"># ... other initializations ...
</span>        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Agent initialized."</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Running the Task (<code class="language-plaintext highlighter-rouge">run</code>)</strong>: The <code class="language-plaintext highlighter-rouge">run</code> method orchestrates the main loop. It calls the <code class="language-plaintext highlighter-rouge">step</code> method repeatedly until the task is marked as done, an error occurs, or <code class="language-plaintext highlighter-rouge">max_steps</code> is reached.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- File: agent/service.py (Simplified run method) ---
</span><span class="k">class</span> <span class="nc">Agent</span><span class="p">:</span>
    <span class="c1"># ... (init) ...
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentHistoryList</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_log_agent_run</span><span class="p">()</span> <span class="c1"># Log start event
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">step_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_steps</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">stopped</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">consecutive_failures</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">max_failures</span><span class="p">:</span>
                    <span class="k">break</span> <span class="c1"># Stop conditions
</span>
                <span class="c1"># Wait if paused
</span>                <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">paused</span><span class="p">:</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

                <span class="n">step_info</span> <span class="o">=</span> <span class="n">AgentStepInfo</span><span class="p">(</span><span class="n">step_number</span><span class="o">=</span><span class="n">step_num</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">step_info</span><span class="p">)</span> <span class="c1"># &lt;&lt;&lt; Execute one step of the loop
</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">history</span><span class="p">.</span><span class="n">is_done</span><span class="p">():</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">log_completion</span><span class="p">()</span> <span class="c1"># Log success/failure
</span>                    <span class="k">break</span> <span class="c1"># Exit loop if agent signaled 'done'
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Max steps reached."</span><span class="p">)</span> <span class="c1"># Ran out of steps
</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># ... (cleanup, telemetry, potentially save history/gif) ...
</span>            <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">history</span> <span class="c1"># Return the recorded history
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Taking a Step (<code class="language-plaintext highlighter-rouge">step</code>)</strong>: This is the heart of the loop. In each step, the Agent:</p>
    <ul>
      <li>Gets the current browser state (<code class="language-plaintext highlighter-rouge">browser_context.get_state()</code>).</li>
      <li>Adds this state to the history via the <code class="language-plaintext highlighter-rouge">_message_manager</code>.</li>
      <li>Asks the LLM for the next action (<code class="language-plaintext highlighter-rouge">get_next_action()</code>).</li>
      <li>Tells the <code class="language-plaintext highlighter-rouge">Controller</code> to execute the action(s) (<code class="language-plaintext highlighter-rouge">multi_act()</code>).</li>
      <li>Records the outcome in the history.</li>
      <li>Handles any errors that might occur.</li>
    </ul>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- File: agent/service.py (Simplified step method) ---
</span><span class="k">class</span> <span class="nc">Agent</span><span class="p">:</span>
    <span class="c1"># ... (init, run) ...
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgentStepInfo</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"üìç Step </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">n_steps</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">model_output</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ActionResult</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 1. Get current state from the browser
</span>            <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">browser_context</span><span class="p">.</span><span class="n">get_state</span><span class="p">()</span> <span class="c1"># Uses BrowserContext
</span>
            <span class="c1"># 2. Add state (+ previous result) to message history for LLM context
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">_message_manager</span><span class="p">.</span><span class="n">add_state_message</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">last_result</span><span class="p">,</span> <span class="p">...)</span>

            <span class="c1"># 3. Get LLM's decision on the next action(s)
</span>            <span class="n">input_messages</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_message_manager</span><span class="p">.</span><span class="n">get_messages</span><span class="p">()</span>
            <span class="n">model_output</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_next_action</span><span class="p">(</span><span class="n">input_messages</span><span class="p">)</span> <span class="c1"># Calls the LLM
</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">n_steps</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># Increment step counter
</span>
            <span class="c1"># 4. Execute the action(s) using the Controller
</span>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">multi_act</span><span class="p">(</span><span class="n">model_output</span><span class="p">.</span><span class="n">action</span><span class="p">)</span> <span class="c1"># Uses Controller
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">last_result</span> <span class="o">=</span> <span class="n">result</span> <span class="c1"># Store result for next step's context
</span>
            <span class="c1"># 5. Record step details (actions, results, state snapshot)
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">_make_history_item</span><span class="p">(</span><span class="n">model_output</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="p">...)</span>

            <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">consecutive_failures</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Reset failure count on success
</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle errors, increment failure count, maybe retry later
</span>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">_handle_step_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">last_result</span> <span class="o">=</span> <span class="n">result</span>
        <span class="c1"># ... (finally block for logging/telemetry) ...
</span></code></pre></div>    </div>
  </li>
</ol>

<h2 id="conclusion">Conclusion</h2>

<p>You‚Äôve now met the <code class="language-plaintext highlighter-rouge">Agent</code>, the central coordinator in <code class="language-plaintext highlighter-rouge">Browser Use</code>. You learned that it acts like a project manager, taking your high-level task, consulting an LLM for step-by-step planning, managing the history, and instructing a <code class="language-plaintext highlighter-rouge">Controller</code> to perform actions within a <code class="language-plaintext highlighter-rouge">BrowserContext</code>.</p>

<p>The Agent‚Äôs effectiveness heavily relies on how well we instruct the LLM planner. In the next chapter, we‚Äôll dive into exactly that: crafting the <strong>System Prompt</strong> to guide the LLM‚Äôs behavior.</p>

<p><a href="02_system_prompt.md">Next Chapter: System Prompt</a></p>

<hr />

<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>
