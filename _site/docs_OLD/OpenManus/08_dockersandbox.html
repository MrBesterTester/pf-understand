<h1 id="chapter-8-dockersandbox---a-safe-play-area-for-code">Chapter 8: DockerSandbox - A Safe Play Area for Code</h1>

<p>Welcome to Chapter 8! In <a href="07_configuration__config_.md">Chapter 7: Configuration (Config)</a>, we learned how OpenManus manages settings using the <code class="language-plaintext highlighter-rouge">config.toml</code> file and the <code class="language-plaintext highlighter-rouge">Config</code> object. We saw settings for the <a href="01_llm.md">LLM</a>, search tools, and something called <code class="language-plaintext highlighter-rouge">[sandbox]</code>. Now, let’s dive into what that sandbox is!</p>

<h2 id="what-problem-does-dockersandbox-solve">What Problem Does <code class="language-plaintext highlighter-rouge">DockerSandbox</code> Solve?</h2>

<p>Imagine our agent, powered by a smart <a href="01_llm.md">LLM</a>, needs to test a piece of code it just wrote, or run a shell command to check something on the system. For example, the user asks: “Write a Python script that calculates 2 plus 2 and run it.”</p>

<p>The agent might generate the code <code class="language-plaintext highlighter-rouge">print(2 + 2)</code>. But where should it run this code?</p>

<p>Running code generated by an AI, especially one connected to the internet, directly on your own computer is <strong>risky</strong>! What if the AI accidentally (or if tricked) generates harmful code like <code class="language-plaintext highlighter-rouge">delete_all_my_files()</code>? That would be disastrous!</p>

<p>We need a safe, isolated place to run potentially untrusted commands or code – a place where even if something goes wrong, it doesn’t affect our main system.</p>

<p><strong>This is exactly what the <code class="language-plaintext highlighter-rouge">DockerSandbox</code> provides.</strong> Think of it as a <strong>secure laboratory sandbox</strong> or a disposable, locked room. Inside this room, the agent can perform potentially messy or dangerous experiments (like running code) without any risk to the outside environment (your computer).</p>

<p><strong>Use Case:</strong> Our agent needs to execute the Python code <code class="language-plaintext highlighter-rouge">print(2 + 2)</code>. Instead of running it directly, it will ask the <code class="language-plaintext highlighter-rouge">DockerSandbox</code> to run it inside a secure container. The sandbox will execute the code, capture the output (“4”), and report it back, all without giving the code access to the host machine’s files or settings.</p>

<h2 id="key-concepts-secure-execution-with-docker">Key Concepts: Secure Execution with Docker</h2>

<ol>
  <li><strong>Isolation via Docker:</strong> <code class="language-plaintext highlighter-rouge">DockerSandbox</code> uses <strong>Docker containers</strong> to achieve isolation. Docker is a technology that allows packaging applications and their dependencies into lightweight, self-contained units called containers. Crucially, these containers run isolated from the host system and each other. They have their own restricted view of files, network, and processes. It’s like giving the code its own mini-computer to run on, completely separate from yours.</li>
  <li><strong>The Sandbox Container:</strong> When needed, the <code class="language-plaintext highlighter-rouge">DockerSandbox</code> system creates a specific Docker container based on settings in your <code class="language-plaintext highlighter-rouge">config.toml</code>. This container is the actual “sandbox” environment.</li>
  <li><strong>Lifecycle Management:</strong> The <code class="language-plaintext highlighter-rouge">DockerSandbox</code> system handles the entire life of the container:
    <ul>
      <li><strong>Creation:</strong> Starting up a fresh container when needed.</li>
      <li><strong>Command Execution:</strong> Running commands (like <code class="language-plaintext highlighter-rouge">python script.py</code> or <code class="language-plaintext highlighter-rouge">ls</code>) inside the container.</li>
      <li><strong>File Transfers:</strong> Safely copying files into or out of the container if needed (e.g., putting a script file in, getting a result file out).</li>
      <li><strong>Cleanup:</strong> Stopping and removing the container automatically when it’s no longer needed or after a period of inactivity, ensuring no resources are wasted.</li>
    </ul>
  </li>
  <li><strong>Configuration (<code class="language-plaintext highlighter-rouge">config.toml</code>):</strong> As we saw in the <a href="07_configuration__config_.md">previous chapter</a>, the <code class="language-plaintext highlighter-rouge">[sandbox]</code> section in <code class="language-plaintext highlighter-rouge">config.toml</code> controls how the sandbox behaves:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">use_sandbox = true</code>: Turns the sandbox feature on. If <code class="language-plaintext highlighter-rouge">false</code>, code might run directly on the host (less safe!).</li>
      <li><code class="language-plaintext highlighter-rouge">image = "python:3.12-slim"</code>: Specifies which Docker base image to use (e.g., a minimal Python environment).</li>
      <li><code class="language-plaintext highlighter-rouge">memory_limit = "512m"</code>: Restricts how much memory the container can use.</li>
      <li><code class="language-plaintext highlighter-rouge">cpu_limit = 1.0</code>: Restricts how much CPU power the container can use.</li>
      <li><code class="language-plaintext highlighter-rouge">timeout = 300</code>: Sets a default time limit (in seconds) for commands.</li>
      <li><code class="language-plaintext highlighter-rouge">network_enabled = false</code>: Controls whether the container can access the internet (often disabled for extra security).</li>
    </ul>
  </li>
</ol>

<h2 id="how-do-we-use-it-via-tools-and-clients">How Do We Use It? (Via Tools and Clients)</h2>

<p>Typically, you don’t interact with the <code class="language-plaintext highlighter-rouge">DockerSandbox</code> class directly. Instead, <a href="04_tool___toolcollection.md">Tools</a> that need to execute code, like <code class="language-plaintext highlighter-rouge">Bash</code> (<code class="language-plaintext highlighter-rouge">app/tool/bash.py</code>) or <code class="language-plaintext highlighter-rouge">PythonExecute</code> (<code class="language-plaintext highlighter-rouge">app/tool/python_execute.py</code>), often use a helper called a <strong>Sandbox Client</strong> to interact with the sandbox environment <em>if</em> it’s enabled in the configuration.</p>

<p>OpenManus provides a ready-to-use client instance: <code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT</code> (from <code class="language-plaintext highlighter-rouge">app/sandbox/client.py</code>).</p>

<p>Let’s see conceptually how a tool might use <code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT</code> to run our <code class="language-plaintext highlighter-rouge">print(2 + 2)</code> example safely.</p>

<p><strong>1. Check Configuration:</strong>
First, the system checks if the sandbox is enabled.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Check the configuration loaded in Chapter 7
</span><span class="kn">from</span> <span class="nn">app.config</span> <span class="kn">import</span> <span class="n">config</span>

<span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">sandbox</span> <span class="ow">and</span> <span class="n">config</span><span class="p">.</span><span class="n">sandbox</span><span class="p">.</span><span class="n">use_sandbox</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Sandbox is ENABLED. Code will run inside a container."</span><span class="p">)</span>
    <span class="c1"># Proceed with using the sandbox client...
</span><span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Sandbox is DISABLED. Code might run directly on the host (potentially unsafe)."</span><span class="p">)</span>
    <span class="c1"># Fallback or raise an error...
</span></code></pre></div></div>

<p><strong>Explanation:</strong></p>
<ul>
  <li>We import the global <code class="language-plaintext highlighter-rouge">config</code> object.</li>
  <li>We check <code class="language-plaintext highlighter-rouge">config.sandbox</code> (to see if the section exists) and <code class="language-plaintext highlighter-rouge">config.sandbox.use_sandbox</code>. This value comes directly from your <code class="language-plaintext highlighter-rouge">config.toml</code> file.</li>
</ul>

<p><strong>2. Use the Sandbox Client:</strong>
If the sandbox is enabled, a tool would use the shared <code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT</code> to execute the command.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example of using the sandbox client (simplified)
</span><span class="kn">from</span> <span class="nn">app.sandbox.client</span> <span class="kn">import</span> <span class="n">SANDBOX_CLIENT</span>
<span class="kn">import</span> <span class="nn">asyncio</span>

<span class="c1"># Assume sandbox is enabled based on the config check above
</span>
<span class="c1"># The Python code our agent wants to run
</span><span class="n">python_code</span> <span class="o">=</span> <span class="s">"print(2 + 2)"</span>

<span class="c1"># Create a temporary script file content
# We wrap the code to make it executable via 'python script.py'
</span><span class="n">script_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">python_code</span><span class="si">}</span><span class="s">"</span>
<span class="n">script_name</span> <span class="o">=</span> <span class="s">"temp_script.py"</span>

<span class="c1"># Define the command to run inside the sandbox
</span><span class="n">command_to_run</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"python </span><span class="si">{</span><span class="n">script_name</span><span class="si">}</span><span class="s">"</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_in_sandbox</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Asking sandbox to run: </span><span class="si">{</span><span class="n">command_to_run</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="c1"># 1. Create the sandbox container (if not already running)
</span>        <span class="c1"># The client handles this automatically based on config
</span>        <span class="c1"># (Simplified: Actual creation might be handled by a manager)
</span>        <span class="c1"># await SANDBOX_CLIENT.create(config=config.sandbox) # Often implicit
</span>
        <span class="c1"># 2. Write the script file into the sandbox
</span>        <span class="k">await</span> <span class="n">SANDBOX_CLIENT</span><span class="p">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">script_name</span><span class="p">,</span> <span class="n">script_content</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Wrote '</span><span class="si">{</span><span class="n">script_name</span><span class="si">}</span><span class="s">' to sandbox."</span><span class="p">)</span>

        <span class="c1"># 3. Execute the command inside the sandbox
</span>        <span class="n">output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">SANDBOX_CLIENT</span><span class="p">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_to_run</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Sandbox execution output: </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="c1"># finally:
</span>        <span class="c1"># 4. Cleanup (often handled automatically by a manager or context)
</span>        <span class="c1"># await SANDBOX_CLIENT.cleanup()
</span>        <span class="c1"># print("Sandbox cleaned up.")
</span>
<span class="c1"># Run the async function
# asyncio.run(run_in_sandbox()) # Uncomment to run
</span></code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ol>
  <li>We import the pre-configured <code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT</code>.</li>
  <li>We define the Python code and the command (<code class="language-plaintext highlighter-rouge">python temp_script.py</code>) needed to execute it.</li>
  <li><code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT.write_file(script_name, script_content)</code>: This copies our Python code into a file <em>inside</em> the isolated container. The path <code class="language-plaintext highlighter-rouge">script_name</code> refers to a path <em>within</em> the sandbox.</li>
  <li><code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT.run_command(command_to_run)</code>: This is the core step! It tells the Docker container to execute <code class="language-plaintext highlighter-rouge">python temp_script.py</code>. The client waits for the command to finish and captures its output (stdout).</li>
  <li>The <code class="language-plaintext highlighter-rouge">output</code> variable receives the result (“4\n” in this case).</li>
  <li><strong>Crucially</strong>, the actual container creation and cleanup might be managed automatically in the background (by the <code class="language-plaintext highlighter-rouge">SandboxManager</code>, see <code class="language-plaintext highlighter-rouge">app/sandbox/core/manager.py</code>) or handled when the client is used within a specific context, so explicit <code class="language-plaintext highlighter-rouge">create()</code> and <code class="language-plaintext highlighter-rouge">cleanup()</code> calls might not always be needed directly in the tool’s code.</li>
</ol>

<p><strong>Expected Output (High Level):</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sandbox is ENABLED. Code will run inside a container.
Asking sandbox to run: python temp_script.py
Wrote 'temp_script.py' to sandbox.
Sandbox execution output: 4

# (Cleanup messages might appear depending on implementation)
</code></pre></div></div>

<p>The important part is that <code class="language-plaintext highlighter-rouge">print(2 + 2)</code> was executed securely <em>inside</em> the Docker container, managed by the sandbox system, without exposing the host machine.</p>

<h2 id="under-the-hood-how-sandbox-execution-works">Under the Hood: How Sandbox Execution Works</h2>

<p>Let’s trace the simplified journey when a tool uses <code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT.run_command("python script.py")</code>:</p>

<ol>
  <li><strong>Request:</strong> The tool (e.g., <code class="language-plaintext highlighter-rouge">PythonExecute</code>) calls <code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT.run_command(...)</code>.</li>
  <li><strong>Check/Create Container:</strong> The <code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT</code> (likely using <code class="language-plaintext highlighter-rouge">DockerSandbox</code> internally, possibly managed by <code class="language-plaintext highlighter-rouge">SandboxManager</code>) checks if a suitable sandbox container is already running. If not, it creates one based on the <code class="language-plaintext highlighter-rouge">SandboxSettings</code> from the <code class="language-plaintext highlighter-rouge">config</code> object (pulling the image, setting resource limits, etc.). This uses the Docker engine installed on your host machine.</li>
  <li><strong>Execute Command:</strong> The client sends the command (<code class="language-plaintext highlighter-rouge">python script.py</code>) to the running Docker container for execution.</li>
  <li><strong>Docker Runs Command:</strong> The Docker engine runs the command <em>inside</em> the isolated container environment. The script executes.</li>
  <li><strong>Capture Output:</strong> The <code class="language-plaintext highlighter-rouge">DockerSandbox</code> infrastructure captures the standard output (stdout) and standard error (stderr) produced by the command within the container.</li>
  <li><strong>Return Result:</strong> The captured output is sent back to the <code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT</code>.</li>
  <li><strong>Client Returns:</strong> The <code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT</code> returns the output string to the calling tool.</li>
  <li><strong>(Later) Cleanup:</strong> The <code class="language-plaintext highlighter-rouge">SandboxManager</code> or context eventually decides to stop and remove the idle container to free up resources.</li>
</ol>

<p><strong>Sequence Diagram:</strong></p>

<pre><code class="language-mermaid">sequenceDiagram
    participant Tool as Tool (e.g., PythonExecute)
    participant Client as SANDBOX_CLIENT
    participant Sandbox as DockerSandbox
    participant Docker as Docker Engine (Host)
    participant Container as Docker Container

    Tool-&gt;&gt;+Client: run_command("python script.py")
    Client-&gt;&gt;+Sandbox: run_command("python script.py")
    Note over Sandbox: Checks if container exists. Assume No.
    Sandbox-&gt;&gt;+Docker: Create Container Request (using config: image, limits)
    Docker-&gt;&gt;+Container: Creates &amp; Starts Container
    Container--&gt;&gt;-Docker: Container Ready
    Docker--&gt;&gt;-Sandbox: Container Created (ID: abc)
    Sandbox-&gt;&gt;+Docker: Execute Command Request (in Container abc: "python script.py")
    Docker-&gt;&gt;+Container: Runs "python script.py"
    Note over Container: script prints "4"
    Container--&gt;&gt;-Docker: Command Output ("4\n")
    Docker--&gt;&gt;-Sandbox: Command Result ("4\n")
    Sandbox--&gt;&gt;-Client: Returns "4\n"
    Client--&gt;&gt;-Tool: Returns "4\n"

    Note over Tool, Container: ... Later (idle timeout or explicit cleanup) ...
    Client-&gt;&gt;+Sandbox: cleanup() (or Manager does it)
    Sandbox-&gt;&gt;+Docker: Stop Container Request (ID: abc)
    Docker-&gt;&gt;Container: Stops Container
    Container--&gt;&gt;Docker: Stopped
    Sandbox-&gt;&gt;+Docker: Remove Container Request (ID: abc)
    Docker-&gt;&gt;Docker: Removes Container abc
    Docker--&gt;&gt;-Sandbox: Container Removed
    Sandbox--&gt;&gt;-Client: Cleanup Done
</code></pre>

<h2 id="code-glimpse-sandbox-components">Code Glimpse: Sandbox Components</h2>

<p>Let’s look at simplified snippets of the key parts.</p>

<p><strong>1. <code class="language-plaintext highlighter-rouge">SandboxSettings</code> in <code class="language-plaintext highlighter-rouge">app/config.py</code>:</strong>
This Pydantic model defines the structure for the <code class="language-plaintext highlighter-rouge">[sandbox]</code> section in <code class="language-plaintext highlighter-rouge">config.toml</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified snippet from app/config.py
</span><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="k">class</span> <span class="nc">SandboxSettings</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="s">"""Configuration for the execution sandbox"""</span>
    <span class="n">use_sandbox</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"Whether to use the sandbox"</span><span class="p">)</span>
    <span class="n">image</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="s">"python:3.12-slim"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"Base image"</span><span class="p">)</span>
    <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="s">"/workspace"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"Container working directory"</span><span class="p">)</span>
    <span class="n">memory_limit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="s">"512m"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"Memory limit"</span><span class="p">)</span>
    <span class="n">cpu_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"CPU limit"</span><span class="p">)</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"Default command timeout (seconds)"</span><span class="p">)</span>
    <span class="n">network_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"Whether network access is allowed"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Explanation:</strong> This defines the expected settings and their types, which <code class="language-plaintext highlighter-rouge">Config</code> uses to validate <code class="language-plaintext highlighter-rouge">config.toml</code>.</p>

<p><strong>2. <code class="language-plaintext highlighter-rouge">LocalSandboxClient</code> in <code class="language-plaintext highlighter-rouge">app/sandbox/client.py</code>:</strong>
This class provides a convenient interface to the underlying <code class="language-plaintext highlighter-rouge">DockerSandbox</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified snippet from app/sandbox/client.py
</span><span class="kn">from</span> <span class="nn">app.config</span> <span class="kn">import</span> <span class="n">SandboxSettings</span>
<span class="kn">from</span> <span class="nn">app.sandbox.core.sandbox</span> <span class="kn">import</span> <span class="n">DockerSandbox</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">LocalSandboxClient</span><span class="p">:</span> <span class="c1"># Implements BaseSandboxClient
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">sandbox</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DockerSandbox</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SandboxSettings</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="p">...):</span>
        <span class="s">"""Creates a sandbox if one doesn't exist."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">sandbox</span><span class="p">:</span>
            <span class="c1"># Create the actual DockerSandbox instance
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">sandbox</span> <span class="o">=</span> <span class="n">DockerSandbox</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="p">...)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">sandbox</span><span class="p">.</span><span class="n">create</span><span class="p">()</span> <span class="c1"># Start the container
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Runs command in the sandbox."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">sandbox</span><span class="p">:</span>
            <span class="c1"># Simplified: In reality, might auto-create or raise error
</span>            <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">create</span><span class="p">()</span> <span class="c1"># Ensure sandbox exists
</span>
        <span class="c1"># Delegate the command execution to the DockerSandbox instance
</span>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">sandbox</span><span class="p">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""Writes file to the sandbox."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">sandbox</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">create</span><span class="p">()</span>
        <span class="c1"># Delegate writing to the DockerSandbox instance
</span>        <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">sandbox</span><span class="p">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""Cleans up the sandbox resources."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">sandbox</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">sandbox</span><span class="p">.</span><span class="n">cleanup</span><span class="p">()</span> <span class="c1"># Tell DockerSandbox to stop/remove container
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">sandbox</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># Create the shared instance used by tools
</span><span class="n">SANDBOX_CLIENT</span> <span class="o">=</span> <span class="n">LocalSandboxClient</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>Explanation:</strong> The client acts as a middleman. It holds a <code class="language-plaintext highlighter-rouge">DockerSandbox</code> instance and forwards calls like <code class="language-plaintext highlighter-rouge">run_command</code> or <code class="language-plaintext highlighter-rouge">write_file</code> to it, potentially handling creation/cleanup implicitly.</p>

<p><strong>3. <code class="language-plaintext highlighter-rouge">DockerSandbox</code> in <code class="language-plaintext highlighter-rouge">app/sandbox/core/sandbox.py</code>:</strong>
This class interacts directly with the Docker engine.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified snippet from app/sandbox/core/sandbox.py
</span><span class="kn">import</span> <span class="nn">docker</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">app.config</span> <span class="kn">import</span> <span class="n">SandboxSettings</span>
<span class="kn">from</span> <span class="nn">app.sandbox.core.terminal</span> <span class="kn">import</span> <span class="n">AsyncDockerizedTerminal</span> <span class="c1"># For running commands
</span>
<span class="k">class</span> <span class="nc">DockerSandbox</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SandboxSettings</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="p">...):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">SandboxSettings</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">docker</span><span class="p">.</span><span class="n">from_env</span><span class="p">()</span> <span class="c1"># Connect to Docker engine
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">container</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">docker</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">containers</span><span class="p">.</span><span class="n">Container</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">terminal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncDockerizedTerminal</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">"DockerSandbox"</span><span class="p">:</span>
        <span class="s">"""Creates and starts the Docker container."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 1. Prepare container settings (image, limits, etc.) from self.config
</span>            <span class="n">container_config</span> <span class="o">=</span> <span class="p">{...}</span> <span class="c1"># Simplified
</span>
            <span class="c1"># 2. Use Docker client to create the container
</span>            <span class="n">container_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">to_thread</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">create_container</span><span class="p">,</span> <span class="o">**</span><span class="n">container_config</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">containers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">container_data</span><span class="p">[</span><span class="s">"Id"</span><span class="p">])</span>

            <span class="c1"># 3. Start the container
</span>            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="n">start</span><span class="p">)</span>

            <span class="c1"># 4. Initialize a terminal interface to run commands inside
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="n">AsyncDockerizedTerminal</span><span class="p">(</span><span class="n">container_data</span><span class="p">[</span><span class="s">"Id"</span><span class="p">],</span> <span class="p">...)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">terminal</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">cleanup</span><span class="p">()</span> <span class="c1"># Cleanup on failure
</span>            <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to create sandbox: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Runs a command using the container's terminal."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">terminal</span><span class="p">:</span> <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">"Sandbox not initialized"</span><span class="p">)</span>
        <span class="c1"># Use the terminal helper to execute the command and get output
</span>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">terminal</span><span class="p">.</span><span class="n">run_command</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">timeout</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""Writes content to a file inside the container."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">container</span><span class="p">:</span> <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">"Sandbox not initialized"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Simplified: Creates a temporary tar archive with the file
</span>            <span class="c1"># and uses Docker's put_archive to copy it into the container
</span>            <span class="n">tar_stream</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">_create_tar_stream</span><span class="p">(...)</span> <span class="c1"># Helper method
</span>            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">to_thread</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="n">put_archive</span><span class="p">,</span> <span class="s">"/"</span><span class="p">,</span> <span class="n">tar_stream</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to write file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""Stops and removes the Docker container."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">terminal</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">terminal</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">container</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span> <span class="c1"># Ignore errors on stop
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="n">remove</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span> <span class="c1"># Ignore errors on remove
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">container</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></div></div>

<p><strong>Explanation:</strong> This class contains the low-level logic to interact with Docker’s API (via the <code class="language-plaintext highlighter-rouge">docker</code> Python library) to create, start, stop, and remove containers, as well as execute commands and transfer files using Docker’s mechanisms.</p>

<h2 id="wrapping-up-chapter-8">Wrapping Up Chapter 8</h2>

<p>You’ve learned about the <code class="language-plaintext highlighter-rouge">DockerSandbox</code>, a critical security feature in OpenManus. It provides an isolated Docker container environment where agents can safely execute potentially untrusted code or commands generated by the <a href="01_llm.md">LLM</a>, using tools like <code class="language-plaintext highlighter-rouge">Bash</code> or <code class="language-plaintext highlighter-rouge">PythonExecute</code>. By isolating execution, the sandbox protects your host system from accidental or malicious harm. Its behavior is configured in <code class="language-plaintext highlighter-rouge">config.toml</code>, and it’s typically used via the <code class="language-plaintext highlighter-rouge">SANDBOX_CLIENT</code> interface.</p>

<p>Now that we understand the core components – LLMs, Memory, Agents, Tools, Flows, Schemas, Config, and the Sandbox – how does information, especially structured data and context, flow between the user, the agent, and external models or tools in a standardized way?</p>

<p>Let’s move on to the final core concept in <a href="09_mcp__model_context_protocol_.md">Chapter 9: MCP (Model Context Protocol)</a> to explore how OpenManus defines a protocol for rich context exchange.</p>

<hr />

<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>
