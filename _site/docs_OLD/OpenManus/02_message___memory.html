<h1 id="chapter-2-message--memory---remembering-the-conversation">Chapter 2: Message / Memory - Remembering the Conversation</h1>

<p>In <a href="01_llm.md">Chapter 1: The LLM - Your Agent’s Brainpower</a>, we learned how our agent uses the <code class="language-plaintext highlighter-rouge">LLM</code> class to access its “thinking” capabilities. But just like humans, an agent needs to remember what was said earlier in a conversation to make sense of new requests and respond appropriately.</p>

<p>Imagine asking a friend: “What was the first thing I asked you?”. If they have no memory, they can’t answer! Agents face the same problem. They need a way to store the conversation history.</p>

<p>This is where <code class="language-plaintext highlighter-rouge">Message</code> and <code class="language-plaintext highlighter-rouge">Memory</code> come in.</p>

<h2 id="what-problem-do-they-solve">What Problem Do They Solve?</h2>

<p>Think about a simple chat:</p>

<ol>
  <li><strong>You:</strong> “What’s the weather like in London?”</li>
  <li><strong>Agent:</strong> “It’s currently cloudy and 15°C in London.”</li>
  <li><strong>You:</strong> “What about Paris?”</li>
</ol>

<p>For the agent to answer your <em>second</em> question (“What about Paris?”), it needs to remember that the <em>topic</em> of the conversation is “weather”. Without remembering the first question, the second question is meaningless.</p>

<p><code class="language-plaintext highlighter-rouge">Message</code> and <code class="language-plaintext highlighter-rouge">Memory</code> provide the structure to:</p>

<ol>
  <li>Represent each individual turn (like your question or the agent’s answer) clearly.</li>
  <li>Store these turns in order, creating a log of the conversation.</li>
</ol>

<h2 id="the-key-concepts-message-and-memory">The Key Concepts: Message and Memory</h2>

<p>Let’s break these down:</p>

<h3 id="1-message-a-single-turn-in-the-chat">1. Message: A Single Turn in the Chat</h3>

<p>A <code class="language-plaintext highlighter-rouge">Message</code> object is like a single speech bubble in a chat interface. It represents one specific thing said by someone (or something) at a particular point in the conversation.</p>

<p>Every <code class="language-plaintext highlighter-rouge">Message</code> has two main ingredients:</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">role</code></strong>: <em>Who</em> sent this message? This is crucial for the LLM to understand the flow. Common roles are:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">user</code>: A message from the end-user interacting with the agent. (e.g., “What’s the weather?”)</li>
      <li><code class="language-plaintext highlighter-rouge">assistant</code>: A message <em>from</em> the agent/LLM. (e.g., “The weather is sunny.”)</li>
      <li><code class="language-plaintext highlighter-rouge">system</code>: An initial instruction to guide the agent’s overall behavior. (e.g., “You are a helpful weather assistant.”)</li>
      <li><code class="language-plaintext highlighter-rouge">tool</code>: The output or result from a <a href="04_tool___toolcollection.md">Tool / ToolCollection</a> that the agent used. (e.g., The raw data returned by a weather API tool).</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">content</code></strong>: <em>What</em> was said? This is the actual text of the message. (e.g., “What’s the weather like in London?”)</li>
</ul>

<p>There are also optional parts for more advanced uses, like <code class="language-plaintext highlighter-rouge">tool_calls</code> (when the assistant decides to use a tool) or <code class="language-plaintext highlighter-rouge">base64_image</code> (if an image is included in the message), but <code class="language-plaintext highlighter-rouge">role</code> and <code class="language-plaintext highlighter-rouge">content</code> are the basics.</p>

<h3 id="2-memory-the-conversation-log">2. Memory: The Conversation Log</h3>

<p>The <code class="language-plaintext highlighter-rouge">Memory</code> object is simply a container, like a list or a notebook, that holds a sequence of <code class="language-plaintext highlighter-rouge">Message</code> objects.</p>

<ul>
  <li>It keeps track of the entire conversation history (or at least the recent parts).</li>
  <li>It stores messages in the order they occurred.</li>
  <li>Agents look at the <code class="language-plaintext highlighter-rouge">Memory</code> before deciding what to do next, giving them context.</li>
</ul>

<p>Think of <code class="language-plaintext highlighter-rouge">Memory</code> as the agent’s short-term memory for the current interaction.</p>

<h2 id="how-do-we-use-them">How Do We Use Them?</h2>

<p>Let’s see how you’d typically work with <code class="language-plaintext highlighter-rouge">Message</code> and <code class="language-plaintext highlighter-rouge">Memory</code> in OpenManus (often, the agent framework handles some of this automatically, but it’s good to understand the pieces).</p>

<p><strong>1. Creating Messages:</strong></p>

<p>The <code class="language-plaintext highlighter-rouge">Message</code> class in <code class="language-plaintext highlighter-rouge">app/schema.py</code> provides handy shortcuts to create messages with the correct role:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import the Message class
</span><span class="kn">from</span> <span class="nn">app.schema</span> <span class="kn">import</span> <span class="n">Message</span>

<span class="c1"># Create a message from the user
</span><span class="n">user_q</span> <span class="o">=</span> <span class="n">Message</span><span class="p">.</span><span class="n">user_message</span><span class="p">(</span><span class="s">"What's the capital of France?"</span><span class="p">)</span>

<span class="c1"># Create a message from the assistant (agent's response)
</span><span class="n">assistant_a</span> <span class="o">=</span> <span class="n">Message</span><span class="p">.</span><span class="n">assistant_message</span><span class="p">(</span><span class="s">"The capital of France is Paris."</span><span class="p">)</span>

<span class="c1"># Create a system instruction
</span><span class="n">system_instruction</span> <span class="o">=</span> <span class="n">Message</span><span class="p">.</span><span class="n">system_message</span><span class="p">(</span><span class="s">"You are a helpful geography expert."</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"User Message: Role='</span><span class="si">{</span><span class="n">user_q</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">', Content='</span><span class="si">{</span><span class="n">user_q</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Assistant Message: Role='</span><span class="si">{</span><span class="n">assistant_a</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">', Content='</span><span class="si">{</span><span class="n">assistant_a</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ul>
  <li>We import <code class="language-plaintext highlighter-rouge">Message</code> from <code class="language-plaintext highlighter-rouge">app/schema.py</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Message.user_message("...")</code> creates a <code class="language-plaintext highlighter-rouge">Message</code> object with <code class="language-plaintext highlighter-rouge">role</code> set to <code class="language-plaintext highlighter-rouge">user</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Message.assistant_message("...")</code> creates one with <code class="language-plaintext highlighter-rouge">role</code> set to <code class="language-plaintext highlighter-rouge">assistant</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Message.system_message("...")</code> creates one with <code class="language-plaintext highlighter-rouge">role</code> set to <code class="language-plaintext highlighter-rouge">system</code>.</li>
  <li>Each of these returns a <code class="language-plaintext highlighter-rouge">Message</code> object containing the role and the text content you provided.</li>
</ul>

<p><strong>Example Output:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User Message: Role='user', Content='What's the capital of France?'
Assistant Message: Role='assistant', Content='The capital of France is Paris.'
</code></pre></div></div>

<p><strong>2. Storing Messages in Memory:</strong></p>

<p>The <code class="language-plaintext highlighter-rouge">Memory</code> class (<code class="language-plaintext highlighter-rouge">app/schema.py</code>) holds these messages. Agents usually have a <code class="language-plaintext highlighter-rouge">memory</code> attribute.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import Memory and Message
</span><span class="kn">from</span> <span class="nn">app.schema</span> <span class="kn">import</span> <span class="n">Message</span><span class="p">,</span> <span class="n">Memory</span>

<span class="c1"># Create a Memory instance
</span><span class="n">conversation_memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">()</span>

<span class="c1"># Add messages to the memory
</span><span class="n">conversation_memory</span><span class="p">.</span><span class="n">add_message</span><span class="p">(</span>
    <span class="n">Message</span><span class="p">.</span><span class="n">system_message</span><span class="p">(</span><span class="s">"You are a helpful geography expert."</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">conversation_memory</span><span class="p">.</span><span class="n">add_message</span><span class="p">(</span>
    <span class="n">Message</span><span class="p">.</span><span class="n">user_message</span><span class="p">(</span><span class="s">"What's the capital of France?"</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">conversation_memory</span><span class="p">.</span><span class="n">add_message</span><span class="p">(</span>
    <span class="n">Message</span><span class="p">.</span><span class="n">assistant_message</span><span class="p">(</span><span class="s">"The capital of France is Paris."</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">conversation_memory</span><span class="p">.</span><span class="n">add_message</span><span class="p">(</span>
    <span class="n">Message</span><span class="p">.</span><span class="n">user_message</span><span class="p">(</span><span class="s">"What about Spain?"</span><span class="p">)</span>
<span class="p">)</span>


<span class="c1"># See the messages stored
</span><span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Number of messages in memory: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conversation_memory</span><span class="p">.</span><span class="n">messages</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="c1"># Print the last message
</span><span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Last message: </span><span class="si">{</span><span class="n">conversation_memory</span><span class="p">.</span><span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ul>
  <li>We import <code class="language-plaintext highlighter-rouge">Memory</code> and <code class="language-plaintext highlighter-rouge">Message</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">conversation_memory = Memory()</code> creates an empty memory store.</li>
  <li><code class="language-plaintext highlighter-rouge">conversation_memory.add_message(...)</code> adds a <code class="language-plaintext highlighter-rouge">Message</code> object to the end of the internal list.</li>
  <li><code class="language-plaintext highlighter-rouge">conversation_memory.messages</code> gives you access to the list of <code class="language-plaintext highlighter-rouge">Message</code> objects currently stored.</li>
  <li><code class="language-plaintext highlighter-rouge">message.to_dict()</code> converts a <code class="language-plaintext highlighter-rouge">Message</code> object into a simple dictionary format, which is often needed for APIs.</li>
</ul>

<p><strong>Example Output:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Number of messages in memory: 4
Last message: {'role': 'user', 'content': 'What about Spain?'}
</code></pre></div></div>

<p><strong>3. Using Memory for Context:</strong></p>

<p>Now, how does the agent use this? Before calling the <a href="01_llm.md">LLM</a> to figure out the answer to “What about Spain?”, the agent would grab the messages from its <code class="language-plaintext highlighter-rouge">Memory</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># (Continuing from previous example)
</span>
<span class="c1"># Agent prepares to ask the LLM
</span><span class="n">messages_for_llm</span> <span class="o">=</span> <span class="n">conversation_memory</span><span class="p">.</span><span class="n">to_dict_list</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Messages being sent to LLM for context:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages_for_llm</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Simplified: Agent would now pass 'messages_for_llm' to llm.ask(...)
# response = await agent.llm.ask(messages=messages_for_llm)
# print(f"LLM would likely respond about the capital of Spain, e.g., 'The capital of Spain is Madrid.'")
</span></code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">conversation_memory.to_dict_list()</code> converts all stored <code class="language-plaintext highlighter-rouge">Message</code> objects into the list-of-dictionaries format that the <code class="language-plaintext highlighter-rouge">llm.ask</code> method expects (as we saw in Chapter 1).</li>
  <li>By sending this <em>entire history</em>, the LLM sees:
    <ol>
      <li>Its instructions (“You are a helpful geography expert.”)</li>
      <li>The first question (“What’s the capital of France?”)</li>
      <li>Its previous answer (“The capital of France is Paris.”)</li>
      <li>The <em>new</em> question (“What about Spain?”)</li>
    </ol>
  </li>
  <li>With this context, the LLM can correctly infer that “What about Spain?” means “What is the capital of Spain?”.</li>
</ul>

<h2 id="under-the-hood-how-it-works">Under the Hood: How It Works</h2>

<p><code class="language-plaintext highlighter-rouge">Memory</code> is conceptually simple. It’s primarily a wrapper around a standard Python list, ensuring messages are stored correctly and providing convenient methods.</p>

<p>Here’s a simplified flow of how an agent uses memory:</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant User
    participant Agent as BaseAgent (app/agent/base.py)
    participant Mem as Memory (app/schema.py)
    participant LLM as LLM Class (app/llm.py)
    participant LLM_API as Actual LLM API

    User-&gt;&gt;+Agent: Sends message ("What about Spain?")
    Agent-&gt;&gt;+Mem: update_memory(role="user", content="What about Spain?")
    Mem-&gt;&gt;Mem: Adds Message(role='user', ...) to internal list
    Mem--&gt;&gt;-Agent: Memory updated
    Agent-&gt;&gt;Agent: Needs to generate response
    Agent-&gt;&gt;+Mem: Get all messages (memory.messages)
    Mem--&gt;&gt;-Agent: Returns list of Message objects
    Agent-&gt;&gt;Agent: Formats messages to dict list (memory.to_dict_list())
    Agent-&gt;&gt;+LLM: ask(messages=formatted_list)
    LLM-&gt;&gt;LLM_API: Sends request with history
    LLM_API--&gt;&gt;LLM: Receives response ("The capital is Madrid.")
    LLM--&gt;&gt;-Agent: Returns text response
    Agent-&gt;&gt;+Mem: update_memory(role="assistant", content="The capital is Madrid.")
    Mem-&gt;&gt;Mem: Adds Message(role='assistant', ...) to internal list
    Mem--&gt;&gt;-Agent: Memory updated
    Agent-&gt;&gt;-User: Sends response ("The capital is Madrid.")

</code></pre>

<p><strong>Code Glimpse:</strong></p>

<p>Let’s look at the core parts in <code class="language-plaintext highlighter-rouge">app/schema.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified snippet from app/schema.py
</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># (Role enum and other definitions are here)
</span>
<span class="k">class</span> <span class="nc">Message</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="c1"># Simplified: In reality uses ROLE_TYPE Literal
</span>    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># ... other optional fields like tool_calls, name, etc.
</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># Creates a dictionary representation, skipping None values
</span>        <span class="n">message_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">role</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">message_dict</span><span class="p">[</span><span class="s">"content"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">content</span>
        <span class="c1"># ... add other fields if they exist ...
</span>        <span class="k">return</span> <span class="n">message_dict</span>

    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">user_message</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">"Message"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s">"user"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>

    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">assistant_message</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s">"Message"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s">"assistant"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>

    <span class="c1"># ... other classmethods like system_message, tool_message ...
</span>
<span class="k">class</span> <span class="nc">Memory</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">max_messages</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Example limit
</span>
    <span class="k">def</span> <span class="nf">add_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""Add a single message to the list."""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="c1"># Optional: Trim old messages if limit exceeded
</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">max_messages</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="p">.</span><span class="n">max_messages</span> <span class="p">:]</span>

    <span class="k">def</span> <span class="nf">to_dict_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="s">"""Convert all stored messages to dictionaries."""</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">]</span>

    <span class="c1"># ... other methods like clear(), get_recent_messages() ...
</span></code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">Message</code> class uses Pydantic <code class="language-plaintext highlighter-rouge">BaseModel</code> for structure and validation. It clearly defines <code class="language-plaintext highlighter-rouge">role</code> and <code class="language-plaintext highlighter-rouge">content</code>. The classmethods (<code class="language-plaintext highlighter-rouge">user_message</code>, etc.) are just convenient ways to create instances with the role pre-filled. <code class="language-plaintext highlighter-rouge">to_dict</code> prepares it for API calls.</li>
  <li>The <code class="language-plaintext highlighter-rouge">Memory</code> class also uses <code class="language-plaintext highlighter-rouge">BaseModel</code>. Its main part is <code class="language-plaintext highlighter-rouge">messages: List[Message]</code>, which holds the conversation history. <code class="language-plaintext highlighter-rouge">add_message</code> simply appends to this list (and optionally trims it). <code class="language-plaintext highlighter-rouge">to_dict_list</code> iterates through the stored messages and converts each one using its <code class="language-plaintext highlighter-rouge">to_dict</code> method.</li>
</ul>

<p>And here’s how an agent might use its memory attribute (simplified from <code class="language-plaintext highlighter-rouge">app/agent/base.py</code>):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified conceptual snippet inspired by app/agent/base.py
</span>
<span class="kn">from</span> <span class="nn">app.schema</span> <span class="kn">import</span> <span class="n">Memory</span><span class="p">,</span> <span class="n">Message</span><span class="p">,</span> <span class="n">ROLE_TYPE</span> <span class="c1"># Simplified imports
</span><span class="kn">from</span> <span class="nn">app.llm</span> <span class="kn">import</span> <span class="n">LLM</span>

<span class="k">class</span> <span class="nc">SimplifiedAgent</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">()</span> <span class="c1"># Agent holds a Memory instance
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">LLM</span><span class="p">()</span> <span class="c1"># Agent has access to the LLM
</span>
    <span class="k">def</span> <span class="nf">add_user_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="s">"""Adds user input to memory."""</span>
        <span class="n">user_msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">.</span><span class="n">user_message</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">user_msg</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Agent Memory Updated with: </span><span class="si">{</span><span class="n">user_msg</span><span class="p">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">generate_response</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Generates a response based on memory."""</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Agent consulting memory..."</span><span class="p">)</span>
        <span class="n">messages_for_llm</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">to_dict_list</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Sending </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">messages_for_llm</span><span class="p">)</span><span class="si">}</span><span class="s"> messages to LLM..."</span><span class="p">)</span>
        <span class="c1"># The actual call to the LLM
</span>        <span class="n">response_text</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">llm</span><span class="p">.</span><span class="n">ask</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="n">messages_for_llm</span><span class="p">)</span>

        <span class="c1"># Add assistant response to memory
</span>        <span class="n">assistant_msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">.</span><span class="n">assistant_message</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">assistant_msg</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Agent Memory Updated with: </span><span class="si">{</span><span class="n">assistant_msg</span><span class="p">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response_text</span>

<span class="c1"># Example Usage (needs async context)
# agent = SimplifiedAgent()
# agent.add_user_input("What is the capital of France?")
# response = await agent.generate_response() # Gets "Paris"
# agent.add_user_input("What about Spain?")
# response2 = await agent.generate_response() # Gets "Madrid"
</span></code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ul>
  <li>The agent has <code class="language-plaintext highlighter-rouge">self.memory</code>.</li>
  <li>When input arrives (<code class="language-plaintext highlighter-rouge">add_user_input</code>), it creates a <code class="language-plaintext highlighter-rouge">Message</code> and adds it using <code class="language-plaintext highlighter-rouge">self.memory.add_message</code>.</li>
  <li>When generating a response (<code class="language-plaintext highlighter-rouge">generate_response</code>), it retrieves the history using <code class="language-plaintext highlighter-rouge">self.memory.to_dict_list()</code> and passes it to <code class="language-plaintext highlighter-rouge">self.llm.ask</code>.</li>
  <li>It then adds the LLM’s response back into memory as an <code class="language-plaintext highlighter-rouge">assistant</code> message.</li>
</ul>

<h2 id="wrapping-up-chapter-2">Wrapping Up Chapter 2</h2>

<p>You’ve now learned about <code class="language-plaintext highlighter-rouge">Message</code> (a single conversational turn with a role and content) and <code class="language-plaintext highlighter-rouge">Memory</code> (the ordered list storing these messages). Together, they provide the crucial context agents need to understand conversations and respond coherently. They act as the agent’s short-term memory or chat log.</p>

<p>We have the brain (<a href="01_llm.md">LLM</a>) and the memory (<code class="language-plaintext highlighter-rouge">Message</code>/<code class="language-plaintext highlighter-rouge">Memory</code>). Now we need something to orchestrate the process – to receive input, consult memory, use the LLM, potentially use tools, and manage its state. That’s the job of the Agent itself.</p>

<p>Let’s move on to <a href="03_baseagent.md">Chapter 3: BaseAgent</a> to see how agents are structured and how they use these core components.</p>

<hr />

<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>
