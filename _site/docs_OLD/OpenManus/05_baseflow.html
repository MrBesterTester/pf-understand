<h1 id="chapter-5-baseflow---managing-multi-step-projects">Chapter 5: BaseFlow - Managing Multi-Step Projects</h1>

<p>In <a href="04_tool___toolcollection.md">Chapter 4: Tool / ToolCollection</a>, we saw how to give agents specific skills like web searching or running code using Tools. Now, imagine you have a task that requires multiple steps, maybe even using different skills (tools) or agents along the way. How do you coordinate this complex work?</p>

<p>That’s where <strong>Flows</strong> come in!</p>

<h2 id="what-problem-does-baseflow-solve">What Problem Does <code class="language-plaintext highlighter-rouge">BaseFlow</code> Solve?</h2>

<p>Think about a simple agent, maybe one equipped with a web search tool. You could ask it, “What’s the capital of France?” and it could use its tool and answer “Paris.” That’s a single-step task.</p>

<p>But what if you ask something more complex, like: “Research the pros and cons of electric cars and then write a short blog post summarizing them.”</p>

<p>This isn’t a single action. It involves:</p>
<ol>
  <li><strong>Planning:</strong> Figuring out the steps needed (e.g., search for pros, search for cons, structure blog post, write draft, review draft).</li>
  <li><strong>Executing Step 1:</strong> Using a web search tool to find pros.</li>
  <li><strong>Executing Step 2:</strong> Using a web search tool to find cons.</li>
  <li><strong>Executing Step 3:</strong> Maybe using the <a href="01_llm.md">LLM</a> brain to outline the blog post.</li>
  <li><strong>Executing Step 4:</strong> Using the LLM to write the post based on the research and outline.</li>
  <li><strong>Executing Step 5:</strong> Perhaps a final review step.</li>
</ol>

<p>A single <a href="03_baseagent.md">BaseAgent</a> <em>might</em> be able to handle this if it’s very sophisticated, but it’s often clearer and more manageable to have a dedicated <strong>orchestrator</strong> or <strong>project manager</strong> overseeing the process.</p>

<p><strong>This is the job of a <code class="language-plaintext highlighter-rouge">Flow</code>.</strong> Specifically, <code class="language-plaintext highlighter-rouge">BaseFlow</code> is the blueprint for these orchestrators. It defines a structure that can manage multiple agents and coordinate their work to achieve a larger goal according to a specific strategy (like following a pre-defined plan).</p>

<p><strong>Use Case:</strong> Let’s stick with our “Research and Write” task. We need something to manage the overall process: first the research, then the writing. A <code class="language-plaintext highlighter-rouge">PlanningFlow</code> (a specific type of Flow built on <code class="language-plaintext highlighter-rouge">BaseFlow</code>) is perfect for this. It will first create a plan (like the steps above) and then execute each step, potentially assigning different steps to different specialized agents if needed.</p>

<h2 id="key-concepts-flow-agents-and-strategy">Key Concepts: Flow, Agents, and Strategy</h2>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">BaseFlow</code> (<code class="language-plaintext highlighter-rouge">app/flow/base.py</code>):</strong>
    <ul>
      <li>This is the <strong>abstract blueprint</strong> for all flows. Think of it as the job description for a project manager – it says a manager needs to know their team (agents) and have a way to run the project (<code class="language-plaintext highlighter-rouge">execute</code> method), but it doesn’t dictate <em>how</em> they manage.</li>
      <li>It mainly holds a dictionary of available <code class="language-plaintext highlighter-rouge">agents</code> that can be used within the flow.</li>
      <li>You don’t use <code class="language-plaintext highlighter-rouge">BaseFlow</code> directly; you use specific implementations.</li>
    </ul>
  </li>
  <li><strong>Concrete Flows (e.g., <code class="language-plaintext highlighter-rouge">PlanningFlow</code> in <code class="language-plaintext highlighter-rouge">app/flow/planning.py</code>):</strong>
    <ul>
      <li>These are the <strong>specific strategies</strong> for managing the project. They <em>inherit</em> from <code class="language-plaintext highlighter-rouge">BaseFlow</code>.</li>
      <li><code class="language-plaintext highlighter-rouge">PlanningFlow</code> is a key example. Its strategy is:
        <ol>
          <li>Receive the overall goal.</li>
          <li>Use an LLM and a special <code class="language-plaintext highlighter-rouge">PlanningTool</code> to break the goal down into a sequence of steps (the “plan”).</li>
          <li>Execute each step in the plan, one by one, usually by calling the <code class="language-plaintext highlighter-rouge">run()</code> method of an appropriate <a href="03_baseagent.md">BaseAgent</a>.</li>
          <li>Track the status of each step (e.g., not started, in progress, completed).</li>
        </ol>
      </li>
    </ul>
  </li>
  <li><strong>Agents within the Flow:</strong>
    <ul>
      <li>These are the “workers” or “specialists” managed by the flow.</li>
      <li>A flow holds one or more <a href="03_baseagent.md">BaseAgent</a> instances.</li>
      <li>In a <code class="language-plaintext highlighter-rouge">PlanningFlow</code>, one agent might be designated as the primary agent (often responsible for helping create the plan), while others (or maybe the same one) act as “executors” for the plan steps. The flow decides which agent is best suited for each step.</li>
    </ul>
  </li>
</ol>

<p>Think of it like building a house:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">BaseFlow</code> is the concept of a “General Contractor”.</li>
  <li><code class="language-plaintext highlighter-rouge">PlanningFlow</code> is a specific <em>type</em> of General Contractor who always starts by creating a detailed architectural plan and then hires specialists for each phase.</li>
  <li>The <code class="language-plaintext highlighter-rouge">agents</code> are the specialists: the plumber, the electrician, the carpenter, etc.</li>
  <li>The overall goal (“Build a house”) is given to the <code class="language-plaintext highlighter-rouge">PlanningFlow</code> (Contractor).</li>
  <li>The <code class="language-plaintext highlighter-rouge">PlanningFlow</code> creates the plan (foundation, framing, plumbing, electrical…).</li>
  <li>The <code class="language-plaintext highlighter-rouge">PlanningFlow</code> then calls the appropriate <code class="language-plaintext highlighter-rouge">agent</code> (specialist) for each step in the plan.</li>
</ul>

<h2 id="how-do-we-use-flows">How Do We Use Flows?</h2>

<p>You typically use a <code class="language-plaintext highlighter-rouge">FlowFactory</code> to create a specific type of flow, providing it with the agents it needs.</p>

<p>Let’s set up a simple <code class="language-plaintext highlighter-rouge">PlanningFlow</code> with one agent called “Manus” (which is a general-purpose agent in OpenManus).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import necessary classes
</span><span class="kn">from</span> <span class="nn">app.agent.manus</span> <span class="kn">import</span> <span class="n">Manus</span> <span class="c1"># A capable agent
</span><span class="kn">from</span> <span class="nn">app.flow.flow_factory</span> <span class="kn">import</span> <span class="n">FlowFactory</span><span class="p">,</span> <span class="n">FlowType</span>
<span class="kn">import</span> <span class="nn">asyncio</span> <span class="c1"># Needed for async execution
</span>
<span class="c1"># 1. Create the agent(s) we want the flow to manage
# We can give agents specific keys (names) within the flow
</span><span class="n">agents_for_flow</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"research_writer"</span><span class="p">:</span> <span class="n">Manus</span><span class="p">()</span> <span class="c1"># Use Manus agent for all tasks
</span><span class="p">}</span>

<span class="c1"># 2. Create the flow using the factory
# We specify the type (PLANNING) and provide the agents
</span><span class="n">planning_flow_instance</span> <span class="o">=</span> <span class="n">FlowFactory</span><span class="p">.</span><span class="n">create_flow</span><span class="p">(</span>
    <span class="n">flow_type</span><span class="o">=</span><span class="n">FlowType</span><span class="p">.</span><span class="n">PLANNING</span><span class="p">,</span>
    <span class="n">agents</span><span class="o">=</span><span class="n">agents_for_flow</span><span class="p">,</span>
    <span class="c1"># Optional: specify which agent is primary (if not first)
</span>    <span class="c1"># primary_agent_key="research_writer"
</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Created a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">planning_flow_instance</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Primary agent: </span><span class="si">{</span><span class="n">planning_flow_instance</span><span class="p">.</span><span class="n">primary_agent</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># 3. Define the overall goal for the flow
</span><span class="n">overall_goal</span> <span class="o">=</span> <span class="s">"Research the main benefits of solar power and write a short summary."</span>

<span class="c1"># Define an async function to run the flow
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">run_the_flow</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Executing flow with goal: '</span><span class="si">{</span><span class="n">overall_goal</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
    <span class="c1"># 4. Execute the flow with the goal
</span>    <span class="n">final_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">planning_flow_instance</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">overall_goal</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">--- Flow Execution Finished ---"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Final Result:</span><span class="se">\n</span><span class="si">{</span><span class="n">final_result</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Run the async function
# asyncio.run(run_the_flow()) # Uncomment to run
</span></code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ol>
  <li>We import the agent we want to use (<code class="language-plaintext highlighter-rouge">Manus</code>) and the <code class="language-plaintext highlighter-rouge">FlowFactory</code> plus <code class="language-plaintext highlighter-rouge">FlowType</code>.</li>
  <li>We create a dictionary <code class="language-plaintext highlighter-rouge">agents_for_flow</code> mapping a key (“research_writer”) to an instance of our <code class="language-plaintext highlighter-rouge">Manus</code> agent. This tells the flow which workers are available.</li>
  <li>We use <code class="language-plaintext highlighter-rouge">FlowFactory.create_flow()</code> specifying <code class="language-plaintext highlighter-rouge">FlowType.PLANNING</code> and passing our <code class="language-plaintext highlighter-rouge">agents_for_flow</code>. The factory handles constructing the <code class="language-plaintext highlighter-rouge">PlanningFlow</code> object correctly.</li>
  <li>We define the high-level task (<code class="language-plaintext highlighter-rouge">overall_goal</code>).</li>
  <li>We call <code class="language-plaintext highlighter-rouge">await planning_flow_instance.execute(overall_goal)</code>. This is where the magic happens! The <code class="language-plaintext highlighter-rouge">PlanningFlow</code> takes over.</li>
</ol>

<p><strong>Expected Outcome (High Level):</strong></p>

<p>When you run this (if uncommented), you won’t just get an immediate answer. You’ll likely see output indicating:</p>
<ul>
  <li>A plan is being created (e.g., Step 1: Search for benefits, Step 2: Synthesize findings, Step 3: Write summary).</li>
  <li>The agent (“research_writer”) starting to execute Step 1. This might involve output from the agent using its web search tool.</li>
  <li>The agent moving on to Step 2, then Step 3, potentially showing LLM thinking or writing output.</li>
  <li>Finally, the <code class="language-plaintext highlighter-rouge">execute</code> call will return a string containing the results of the steps and possibly a final summary generated by the flow or the agent.</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">PlanningFlow</code> manages this entire multi-step process automatically based on the initial goal.</p>

<h2 id="under-the-hood-how-planningflowexecute-works">Under the Hood: How <code class="language-plaintext highlighter-rouge">PlanningFlow.execute</code> Works</h2>

<p>Let’s peek behind the curtain of the <code class="language-plaintext highlighter-rouge">PlanningFlow</code>’s <code class="language-plaintext highlighter-rouge">execute</code> method. What happens when you call it?</p>

<p><strong>High-Level Walkthrough:</strong></p>

<ol>
  <li><strong>Receive Goal:</strong> The <code class="language-plaintext highlighter-rouge">execute</code> method gets the <code class="language-plaintext highlighter-rouge">input_text</code> (our overall goal).</li>
  <li><strong>Create Plan (<code class="language-plaintext highlighter-rouge">_create_initial_plan</code>):</strong>
    <ul>
      <li>It constructs messages for the <a href="01_llm.md">LLM</a>, including a system message asking it to act as a planner.</li>
      <li>It tells the LLM about the <code class="language-plaintext highlighter-rouge">PlanningTool</code> (a special <a href="04_tool___toolcollection.md">Tool</a> designed for creating and managing plans).</li>
      <li>It calls the LLM’s <code class="language-plaintext highlighter-rouge">ask_tool</code> method, essentially asking: “Please use the PlanningTool to create a plan for this goal: <em>{input_text}</em>”.</li>
      <li>The <code class="language-plaintext highlighter-rouge">PlanningTool</code> (when called by the LLM) stores the generated steps (e.g., [“Search benefits”, “Write summary”]) associated with a unique <code class="language-plaintext highlighter-rouge">plan_id</code>.</li>
    </ul>
  </li>
  <li><strong>Execution Loop:</strong> The flow enters a loop to execute the plan steps.
    <ul>
      <li><strong>Get Next Step (<code class="language-plaintext highlighter-rouge">_get_current_step_info</code>):</strong> It checks the stored plan (using the <code class="language-plaintext highlighter-rouge">PlanningTool</code>) to find the first step that isn’t marked as “completed”. It gets the step’s text and index.</li>
      <li><strong>Check for Completion:</strong> If no non-completed steps are found, the plan is finished! The loop breaks.</li>
      <li><strong>Select Executor (<code class="language-plaintext highlighter-rouge">get_executor</code>):</strong> It determines which agent should perform the current step. In our simple example, it will always select our “research_writer” agent. More complex flows could choose based on step type (e.g., a “[CODE]” step might go to a coding agent).</li>
      <li><strong>Execute Step (<code class="language-plaintext highlighter-rouge">_execute_step</code>):</strong>
        <ul>
          <li>It prepares a prompt for the selected executor agent, including the current plan status and the specific instruction for the current step (e.g., “You are working on step 0: ‘Search benefits’. Please execute this step.”).</li>
          <li>It calls the executor agent’s <code class="language-plaintext highlighter-rouge">run()</code> method with this prompt: <code class="language-plaintext highlighter-rouge">await executor.run(step_prompt)</code>. The agent then does its work (which might involve using its own tools, memory, and LLM).</li>
          <li>It gets the result back from the agent’s <code class="language-plaintext highlighter-rouge">run()</code>.</li>
        </ul>
      </li>
      <li><strong>Mark Step Complete (<code class="language-plaintext highlighter-rouge">_mark_step_completed</code>):</strong> It tells the <code class="language-plaintext highlighter-rouge">PlanningTool</code> to update the status of the current step to “completed”.</li>
      <li><strong>Loop:</strong> Go back to find the next step.</li>
    </ul>
  </li>
  <li><strong>Finalize (<code class="language-plaintext highlighter-rouge">_finalize_plan</code>):</strong> Once the loop finishes, it might generate a final summary of the completed plan (potentially using the LLM again).</li>
  <li><strong>Return Result:</strong> The accumulated results from executing all the steps are returned as a string.</li>
</ol>

<p><strong>Sequence Diagram:</strong></p>

<p>Here’s a simplified view of the process:</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant User
    participant PF as PlanningFlow
    participant LLM_Planner as LLM (for Planning)
    participant PlanTool as PlanningTool
    participant Executor as Executor Agent (e.g., Manus)
    participant AgentLLM as Agent's LLM (for Execution)

    User-&gt;&gt;+PF: execute("Research &amp; Summarize Solar Power")
    PF-&gt;&gt;+LLM_Planner: ask_tool("Create plan...", tools=[PlanTool])
    LLM_Planner-&gt;&gt;+PlanTool: execute(command='create', steps=['Search', 'Summarize'], ...)
    PlanTool--&gt;&gt;-LLM_Planner: Plan created (ID: plan_123)
    LLM_Planner--&gt;&gt;-PF: Plan created successfully
    Note over PF: Start Execution Loop
    loop Plan Steps
        PF-&gt;&gt;+PlanTool: get_next_step(plan_id='plan_123')
        PlanTool--&gt;&gt;-PF: Step 0: "Search"
        PF-&gt;&gt;PF: Select Executor (Manus)
        PF-&gt;&gt;+Executor: run("Execute step 0: 'Search'...")
        Executor-&gt;&gt;+AgentLLM: ask/ask_tool (e.g., use web search)
        AgentLLM--&gt;&gt;-Executor: Search results
        Executor--&gt;&gt;-PF: Step 0 result ("Found benefits X, Y, Z...")
        PF-&gt;&gt;+PlanTool: mark_step(plan_id='plan_123', step=0, status='completed')
        PlanTool--&gt;&gt;-PF: Step marked
        PF-&gt;&gt;+PlanTool: get_next_step(plan_id='plan_123')
        PlanTool--&gt;&gt;-PF: Step 1: "Summarize"
        PF-&gt;&gt;PF: Select Executor (Manus)
        PF-&gt;&gt;+Executor: run("Execute step 1: 'Summarize'...")
        Executor-&gt;&gt;+AgentLLM: ask("Summarize: X, Y, Z...")
        AgentLLM--&gt;&gt;-Executor: Summary text
        Executor--&gt;&gt;-PF: Step 1 result ("Solar power benefits include...")
        PF-&gt;&gt;+PlanTool: mark_step(plan_id='plan_123', step=1, status='completed')
        PlanTool--&gt;&gt;-PF: Step marked
        PF-&gt;&gt;+PlanTool: get_next_step(plan_id='plan_123')
        PlanTool--&gt;&gt;-PF: No more steps
    end
    Note over PF: End Execution Loop
    PF-&gt;&gt;PF: Finalize (optional summary)
    PF--&gt;&gt;-User: Final combined result string

</code></pre>

<p><strong>Code Glimpse:</strong></p>

<p>Let’s look at simplified snippets from the flow files.</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">app/flow/base.py</code>:</strong> The blueprint just holds agents.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified snippet from app/flow/base.py
</span><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">app.agent.base</span> <span class="kn">import</span> <span class="n">BaseAgent</span>

<span class="k">class</span> <span class="nc">BaseFlow</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
    <span class="s">"""Base class for execution flows supporting multiple agents"""</span>
    <span class="n">agents</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseAgent</span><span class="p">]</span> <span class="c1"># Holds the agents
</span>    <span class="n">primary_agent_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># Key for the main agent
</span>
    <span class="c1"># ... __init__ handles setting up the agents dictionary ...
</span>
    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">primary_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseAgent</span><span class="p">]:</span>
        <span class="s">"""Get the primary agent for the flow"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">agents</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">primary_agent_key</span><span class="p">)</span>

    <span class="o">@</span><span class="n">abstractmethod</span> <span class="c1"># Subclasses MUST implement execute
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Execute the flow with given input"""</span>
        <span class="k">pass</span>
</code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">app/flow/flow_factory.py</code>:</strong> Creates the specific flow.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified snippet from app/flow/flow_factory.py
</span><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">app.agent.base</span> <span class="kn">import</span> <span class="n">BaseAgent</span>
<span class="kn">from</span> <span class="nn">app.flow.base</span> <span class="kn">import</span> <span class="n">BaseFlow</span>
<span class="kn">from</span> <span class="nn">app.flow.planning</span> <span class="kn">import</span> <span class="n">PlanningFlow</span> <span class="c1"># Import specific flows
</span>
<span class="k">class</span> <span class="nc">FlowType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">PLANNING</span> <span class="o">=</span> <span class="s">"planning"</span> <span class="c1"># Add other flow types here
</span>
<span class="k">class</span> <span class="nc">FlowFactory</span><span class="p">:</span>
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">create_flow</span><span class="p">(</span><span class="n">flow_type</span><span class="p">:</span> <span class="n">FlowType</span><span class="p">,</span> <span class="n">agents</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseFlow</span><span class="p">:</span>
        <span class="n">flows</span> <span class="o">=</span> <span class="p">{</span> <span class="c1"># Maps type enum to the actual class
</span>            <span class="n">FlowType</span><span class="p">.</span><span class="n">PLANNING</span><span class="p">:</span> <span class="n">PlanningFlow</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">flow_class</span> <span class="o">=</span> <span class="n">flows</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">flow_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flow_class</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Unknown flow type: </span><span class="si">{</span><span class="n">flow_type</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="c1"># Creates an instance of PlanningFlow(agents, **kwargs)
</span>        <span class="k">return</span> <span class="n">flow_class</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">app/flow/planning.py</code>:</strong> The core planning and execution logic.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified snippets from app/flow/planning.py
</span><span class="kn">from</span> <span class="nn">app.flow.base</span> <span class="kn">import</span> <span class="n">BaseFlow</span>
<span class="kn">from</span> <span class="nn">app.tool</span> <span class="kn">import</span> <span class="n">PlanningTool</span>
<span class="kn">from</span> <span class="nn">app.agent.base</span> <span class="kn">import</span> <span class="n">BaseAgent</span>
<span class="kn">from</span> <span class="nn">app.schema</span> <span class="kn">import</span> <span class="n">Message</span> <span class="c1"># Assuming Message is imported
</span>
<span class="k">class</span> <span class="nc">PlanningFlow</span><span class="p">(</span><span class="n">BaseFlow</span><span class="p">):</span>
    <span class="n">planning_tool</span><span class="p">:</span> <span class="n">PlanningTool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">PlanningTool</span><span class="p">)</span>
    <span class="c1"># ... other fields like llm, active_plan_id ...
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Execute the planning flow with agents."""</span>
        <span class="c1"># 1. Create the plan if input is provided
</span>        <span class="k">if</span> <span class="n">input_text</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">_create_initial_plan</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
            <span class="c1"># Check if plan exists...
</span>
        <span class="n">result_accumulator</span> <span class="o">=</span> <span class="s">""</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># 2. Get the next step to execute
</span>            <span class="n">step_index</span><span class="p">,</span> <span class="n">step_info</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_current_step_info</span><span class="p">()</span>

            <span class="c1"># 3. Exit if no more steps
</span>            <span class="k">if</span> <span class="n">step_index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">result_accumulator</span> <span class="o">+=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">_finalize_plan</span><span class="p">()</span>
                <span class="k">break</span>

            <span class="c1"># 4. Get the agent to execute the step
</span>            <span class="n">executor_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_executor</span><span class="p">(</span><span class="n">step_info</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"type"</span><span class="p">))</span>

            <span class="c1"># 5. Execute the step using the agent
</span>            <span class="n">step_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">_execute_step</span><span class="p">(</span><span class="n">executor_agent</span><span class="p">,</span> <span class="n">step_info</span><span class="p">)</span>
            <span class="n">result_accumulator</span> <span class="o">+=</span> <span class="n">step_result</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>

            <span class="c1"># Mark step as completed (done inside _execute_step or here)
</span>            <span class="c1"># await self._mark_step_completed(step_index) # Simplified
</span>
            <span class="c1"># Maybe check if agent finished early...
</span>
        <span class="k">return</span> <span class="n">result_accumulator</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_create_initial_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="s">"""Uses LLM and PlanningTool to create the plan."""</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Creating plan for: </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">system_msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">.</span><span class="n">system_message</span><span class="p">(</span><span class="s">"You are a planner..."</span><span class="p">)</span>
        <span class="n">user_msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">.</span><span class="n">user_message</span><span class="p">(</span><span class="sa">f</span><span class="s">"Create a plan for: </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="c1"># Ask LLM to use the planning tool
</span>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">llm</span><span class="p">.</span><span class="n">ask_tool</span><span class="p">(</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span><span class="n">user_msg</span><span class="p">],</span>
            <span class="n">system_msgs</span><span class="o">=</span><span class="p">[</span><span class="n">system_msg</span><span class="p">],</span>
            <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">planning_tool</span><span class="p">.</span><span class="n">to_param</span><span class="p">()],</span> <span class="c1"># Provide the tool spec
</span>            <span class="c1"># Force LLM to use a tool (often planning tool)
</span>            <span class="c1"># tool_choice=ToolChoice.AUTO # Or specify planning tool name
</span>        <span class="p">)</span>

        <span class="c1"># Process LLM response to execute the planning tool call
</span>        <span class="c1"># Simplified: Assume LLM calls planning_tool.execute(...)
</span>        <span class="c1"># to store the plan steps.
</span>        <span class="c1"># ... logic to handle response and tool execution ...
</span>        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Plan created."</span><span class="p">)</span>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executor</span><span class="p">:</span> <span class="n">BaseAgent</span><span class="p">,</span> <span class="n">step_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Execute a single step using the executor agent."""</span>
        <span class="n">step_text</span> <span class="o">=</span> <span class="n">step_info</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"text"</span><span class="p">,</span> <span class="s">"Current step"</span><span class="p">)</span>
        <span class="n">plan_status</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_plan_text</span><span class="p">()</span> <span class="c1"># Get current plan state
</span>
        <span class="c1"># Construct prompt for the agent
</span>        <span class="n">step_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"Current Plan:</span><span class="se">\n</span><span class="si">{</span><span class="n">plan_status</span><span class="si">}</span><span class="se">\n\n</span><span class="s">Your Task:</span><span class="se">\n</span><span class="s">Execute step: </span><span class="si">{</span><span class="n">step_text</span><span class="si">}</span><span class="s">"</span>

        <span class="c1"># Call the agent's run method!
</span>        <span class="n">step_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">executor</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">step_prompt</span><span class="p">)</span>

        <span class="c1"># Mark step completed after execution
</span>        <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">_mark_step_completed</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">step_result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_mark_step_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Update the planning tool state for the current step."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">current_step_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">planning_tool</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">command</span><span class="o">=</span><span class="s">"mark_step"</span><span class="p">,</span>
                <span class="n">plan_id</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">active_plan_id</span><span class="p">,</span>
                <span class="n">step_index</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">current_step_index</span><span class="p">,</span>
                <span class="n">step_status</span><span class="o">=</span><span class="s">"completed"</span> <span class="c1"># Simplified status
</span>            <span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Step </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">current_step_index</span><span class="si">}</span><span class="s"> marked complete."</span><span class="p">)</span>

    <span class="c1"># ... other helper methods like _get_current_step_info, get_executor ...
</span></code></pre></div></div>

<p><strong>Explanation of Snippets:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">BaseFlow</code> defines the <code class="language-plaintext highlighter-rouge">agents</code> dictionary and the abstract <code class="language-plaintext highlighter-rouge">execute</code> method.</li>
  <li><code class="language-plaintext highlighter-rouge">FlowFactory</code> looks at the requested <code class="language-plaintext highlighter-rouge">FlowType</code> and returns an instance of the corresponding class (<code class="language-plaintext highlighter-rouge">PlanningFlow</code>).</li>
  <li><code class="language-plaintext highlighter-rouge">PlanningFlow.execute</code> orchestrates the overall process: create plan, loop through steps, get executor, execute step via <code class="language-plaintext highlighter-rouge">agent.run()</code>, mark complete.</li>
  <li><code class="language-plaintext highlighter-rouge">_create_initial_plan</code> shows interaction with the <a href="01_llm.md">LLM</a> and the <code class="language-plaintext highlighter-rouge">PlanningTool</code> to generate the initial steps.</li>
  <li><code class="language-plaintext highlighter-rouge">_execute_step</code> shows how the flow prepares a prompt and then delegates the actual work for a specific step to an agent by calling <code class="language-plaintext highlighter-rouge">executor.run()</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">_mark_step_completed</code> updates the plan state using the <code class="language-plaintext highlighter-rouge">PlanningTool</code>.</li>
</ul>

<h2 id="wrapping-up-chapter-5">Wrapping Up Chapter 5</h2>

<p>We’ve seen that <code class="language-plaintext highlighter-rouge">BaseFlow</code> provides a way to manage complex, multi-step tasks that might involve multiple agents or tools. It acts as an orchestrator or project manager. We focused on <code class="language-plaintext highlighter-rouge">PlanningFlow</code>, a specific strategy where a plan is created first, and then each step is executed sequentially by designated agents. This allows OpenManus to tackle much larger and more complex goals than a single agent could handle alone.</p>

<p>So far, we’ve covered the core components: LLMs, Memory, Agents, Tools, and Flows. But how do we define the structure of data that these components pass around, like the format of tool parameters or agent configurations? That’s where schemas come in.</p>

<p>Let’s move on to <a href="06_schema.md">Chapter 6: Schema</a> to understand how OpenManus defines and validates data structures.</p>

<hr />

<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>
