<h1 id="chapter-4-approval-policy--security">Chapter 4: Approval Policy &amp; Security</h1>

<p>In the <a href="03_agent_loop.md">previous chapter</a>, we saw how the <strong>Agent Loop</strong> acts like Codex’s brain, talking to the AI and figuring out what steps to take. Sometimes, the AI might suggest actions that could change things on your computer, like modifying a file or running a command in your terminal (e.g., <code class="language-plaintext highlighter-rouge">git commit</code>, <code class="language-plaintext highlighter-rouge">npm install</code>, or even <code class="language-plaintext highlighter-rouge">rm important_file.txt</code>!).</p>

<p>This sounds powerful, but also a little scary, right? What if the AI misunderstands and suggests deleting the wrong file? We need a way to control how much power Codex has.</p>

<p>That’s exactly what the <strong>Approval Policy &amp; Security</strong> system does. It’s like a security guard standing between the AI’s suggestions and your actual computer.</p>

<h2 id="whats-the-big-idea-the-security-guard">What’s the Big Idea? The Security Guard</h2>

<p>Imagine you’re visiting a secure building. Depending on your pass, you have different levels of access:</p>

<ul>
  <li><strong>Guest Pass (<code class="language-plaintext highlighter-rouge">suggest</code> mode):</strong> You can look around (read files), but if you want to open a door (modify a file) or use special equipment (run a command), you need to ask the guard for permission every single time.</li>
  <li><strong>Employee Badge (<code class="language-plaintext highlighter-rouge">auto-edit</code> mode):</strong> You can open regular office doors (modify files in the project) without asking each time, but you still need permission for restricted areas like the server room (running commands).</li>
  <li><strong>Full Access Badge (<code class="language-plaintext highlighter-rouge">full-auto</code> mode):</strong> You can go almost anywhere (modify files, run commands), but for potentially sensitive actions (like running commands), the guard might escort you to a special monitored room (a “sandbox”) to ensure safety.</li>
</ul>

<p>The Approval Policy in Codex works just like these passes. It lets <em>you</em> choose how much autonomy Codex has when it suggests potentially risky actions.</p>

<h2 id="key-concepts-the-approval-modes">Key Concepts: The Approval Modes</h2>

<p>Codex offers different levels of autonomy, which you can usually set with a command-line flag like <code class="language-plaintext highlighter-rouge">--approval-mode</code> or when you first configure it. These are the main modes:</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">suggest</code> (Default):</strong>
    <ul>
      <li><strong>What it is:</strong> The most cautious mode. Like the Guest Pass.</li>
      <li><strong>What it does:</strong> Codex can read files to understand your project, but before it <em>modifies</em> any file or <em>runs</em> any command, it will always stop and ask for your explicit permission through the <a href="01_terminal_ui__ink_components_.md">Terminal UI</a>.</li>
      <li><strong>Use when:</strong> You want maximum control and want to review every single change or command.</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">auto-edit</code>:</strong>
    <ul>
      <li><strong>What it is:</strong> Allows automatic file edits, but still requires approval for commands. Like the Employee Badge.</li>
      <li><strong>What it does:</strong> Codex can automatically apply changes (patches) to files within your project directory. However, if it wants to run a shell command (like <code class="language-plaintext highlighter-rouge">npm install</code>, <code class="language-plaintext highlighter-rouge">git commit</code>, <code class="language-plaintext highlighter-rouge">python script.py</code>), it will still stop and ask for your permission.</li>
      <li><strong>Use when:</strong> You trust the AI to make code changes but still want to manually approve any commands it tries to run.</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">full-auto</code>:</strong>
    <ul>
      <li><strong>What it is:</strong> The most autonomous mode, allowing file edits and command execution, but with safeguards. Like the Full Access Badge with escort.</li>
      <li><strong>What it does:</strong> Codex can automatically apply file changes <em>and</em> run shell commands without asking you first. Crucially, to prevent accidental damage, commands run in this mode are typically executed inside a <strong>sandbox</strong> – a restricted environment that limits what the command can do (e.g., blocking network access, limiting file access to the project directory). We’ll learn more about this in the <a href="06_command_execution___sandboxing.md">Command Execution &amp; Sandboxing</a> chapter.</li>
      <li><strong>Use when:</strong> You want Codex to work as independently as possible, understanding that potentially risky commands are run with safety restrictions.</li>
    </ul>
  </li>
</ol>

<h2 id="how-it-works-in-practice">How it Works in Practice</h2>

<p>When the <a href="03_agent_loop.md">Agent Loop</a> receives a suggestion from the AI to perform an action (like applying a patch or running a shell command), it doesn’t just blindly execute it. Instead, it checks the current Approval Policy you’ve set.</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant AgentLoop as Agent Loop
    participant ApprovalCheck as Approval Policy Check
    participant UserUI as Terminal UI
    participant CmdExec as Command Execution

    AgentLoop-&gt;&gt;AgentLoop: AI suggests action (e.g., run `npm install`)
    AgentLoop-&gt;&gt;ApprovalCheck: Check action against policy (`auto-edit`)
    ApprovalCheck-&gt;&gt;ApprovalCheck: Action is `npm install` (command)
    ApprovalCheck-&gt;&gt;ApprovalCheck: Policy is `auto-edit` (commands need approval)
    ApprovalCheck--&gt;&gt;AgentLoop: Decision: `ask-user`
    AgentLoop-&gt;&gt;UserUI: Request confirmation for `npm install`
    UserUI-&gt;&gt;UserUI: Display "Allow command `npm install`? [Y/n]"
    UserUI--&gt;&gt;AgentLoop: User response (e.g., Yes)
    AgentLoop-&gt;&gt;CmdExec: Execute `npm install`
</code></pre>

<ol>
  <li><strong>Suggestion:</strong> The AI tells the Agent Loop it wants to run <code class="language-plaintext highlighter-rouge">npm install</code>.</li>
  <li><strong>Check Policy:</strong> The Agent Loop asks the Approval Policy system: “The AI wants to run <code class="language-plaintext highlighter-rouge">npm install</code>. The user set the policy to <code class="language-plaintext highlighter-rouge">auto-edit</code>. Is this okay?”</li>
  <li><strong>Decision:</strong> The Approval Policy system checks its rules:
    <ul>
      <li>The action is a shell command.</li>
      <li>The policy is <code class="language-plaintext highlighter-rouge">auto-edit</code>.</li>
      <li>Rule: In <code class="language-plaintext highlighter-rouge">auto-edit</code> mode, shell commands require user approval.</li>
      <li>Result: The decision is <code class="language-plaintext highlighter-rouge">ask-user</code>.</li>
    </ul>
  </li>
  <li><strong>Ask User:</strong> The Agent Loop receives the <code class="language-plaintext highlighter-rouge">ask-user</code> decision and uses the <code class="language-plaintext highlighter-rouge">getCommandConfirmation</code> callback (provided by the <a href="01_terminal_ui__ink_components_.md">Terminal UI</a>) to display the prompt to you.</li>
  <li><strong>User Response:</strong> You see the prompt and respond (e.g., ‘Yes’).</li>
  <li><strong>Execute (if approved):</strong> The Agent Loop receives your ‘Yes’ and proceeds to execute the command, potentially using the <a href="06_command_execution___sandboxing.md">Command Execution &amp; Sandboxing</a> system.</li>
</ol>

<p>If the policy had been <code class="language-plaintext highlighter-rouge">full-auto</code>, the decision in Step 3 might have been <code class="language-plaintext highlighter-rouge">auto-approve</code> (with <code class="language-plaintext highlighter-rouge">runInSandbox: true</code>), and the Agent Loop would have skipped asking you (Steps 4 &amp; 5) and gone straight to execution (Step 6), but inside the sandbox.</p>

<p>If the action was applying a file patch and the policy was <code class="language-plaintext highlighter-rouge">auto-edit</code> or <code class="language-plaintext highlighter-rouge">full-auto</code>, the decision might also be <code class="language-plaintext highlighter-rouge">auto-approve</code> (checking if the file path is allowed), skipping the user prompt.</p>

<h2 id="under-the-hood-the-approvalsts-logic">Under the Hood: The <code class="language-plaintext highlighter-rouge">approvals.ts</code> Logic</h2>

<p>The core logic for making these decisions lives in <code class="language-plaintext highlighter-rouge">codex-cli/src/approvals.ts</code>. A key function here is <code class="language-plaintext highlighter-rouge">canAutoApprove</code>.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: codex-cli/src/approvals.ts (Simplified)</span>

<span class="c1">// Represents the different approval modes</span>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">ApprovalPolicy</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">suggest</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">auto-edit</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">full-auto</span><span class="dl">"</span><span class="p">;</span>

<span class="c1">// Represents the outcome of the safety check</span>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">SafetyAssessment</span> <span class="o">=</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">auto-approve</span><span class="dl">"</span><span class="p">;</span> <span class="nl">runInSandbox</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span> <span class="nl">reason</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span> <span class="cm">/*...*/</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ask-user</span><span class="dl">"</span><span class="p">;</span> <span class="nl">applyPatch</span><span class="p">?:</span> <span class="nx">ApplyPatchCommand</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">reject</span><span class="dl">"</span><span class="p">;</span> <span class="nl">reason</span><span class="p">:</span> <span class="kr">string</span> <span class="p">};</span>

<span class="c1">// Input for apply_patch commands</span>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">ApplyPatchCommand</span> <span class="o">=</span> <span class="p">{</span> <span class="na">patch</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span> <span class="p">};</span>

<span class="cm">/**
 * Checks if a command can be run automatically based on the policy.
 */</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">canAutoApprove</span><span class="p">(</span>
  <span class="nx">command</span><span class="p">:</span> <span class="nx">ReadonlyArray</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">,</span> <span class="c1">// e.g., ["git", "status"] or ["apply_patch", "..."]</span>
  <span class="nx">policy</span><span class="p">:</span> <span class="nx">ApprovalPolicy</span><span class="p">,</span>
  <span class="nx">writableRoots</span><span class="p">:</span> <span class="nx">ReadonlyArray</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">,</span> <span class="c1">// Allowed directories for edits</span>
  <span class="c1">// ... env ...</span>
<span class="p">):</span> <span class="nx">SafetyAssessment</span> <span class="p">{</span>
  <span class="c1">// --- Special case: apply_patch ---</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">apply_patch</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Check if policy allows auto-editing and if patch only affects allowed files</span>
    <span class="kd">const</span> <span class="nx">applyPatchArg</span> <span class="o">=</span> <span class="nx">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">as</span> <span class="kr">string</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">patchDetails</span> <span class="o">=</span> <span class="p">{</span> <span class="na">patch</span><span class="p">:</span> <span class="nx">applyPatchArg</span> <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">policy</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">suggest</span><span class="dl">"</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ask-user</span><span class="dl">"</span><span class="p">,</span> <span class="na">applyPatch</span><span class="p">:</span> <span class="nx">patchDetails</span> <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isWritePatchConstrainedToWritablePaths</span><span class="p">(</span><span class="nx">applyPatchArg</span><span class="p">,</span> <span class="nx">writableRoots</span><span class="p">))</span> <span class="p">{</span>
       <span class="k">return</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">auto-approve</span><span class="dl">"</span><span class="p">,</span> <span class="na">runInSandbox</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">reason</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Patch affects allowed files</span><span class="dl">"</span><span class="p">,</span> <span class="cm">/*...*/</span> <span class="p">};</span>
    <span class="p">}</span>
    <span class="c1">// If policy is auto-edit but patch affects disallowed files, ask user.</span>
    <span class="c1">// If policy is full-auto, still approve but mark for sandbox if paths are weird.</span>
    <span class="k">return</span> <span class="nx">policy</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">full-auto</span><span class="dl">"</span> <span class="p">?</span>
      <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">auto-approve</span><span class="dl">"</span><span class="p">,</span> <span class="na">runInSandbox</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">reason</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Full auto mode</span><span class="dl">"</span><span class="p">,</span> <span class="cm">/*...*/</span> <span class="p">}</span> <span class="p">:</span>
      <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ask-user</span><span class="dl">"</span><span class="p">,</span> <span class="na">applyPatch</span><span class="p">:</span> <span class="nx">patchDetails</span> <span class="p">};</span>
  <span class="p">}</span>

  <span class="c1">// --- Check for known safe, read-only commands ---</span>
  <span class="kd">const</span> <span class="nx">knownSafe</span> <span class="o">=</span> <span class="nx">isSafeCommand</span><span class="p">(</span><span class="nx">command</span><span class="p">);</span> <span class="c1">// Checks things like "ls", "pwd", "git status"</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">knownSafe</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">auto-approve</span><span class="dl">"</span><span class="p">,</span> <span class="na">runInSandbox</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">reason</span><span class="p">:</span> <span class="nx">knownSafe</span><span class="p">.</span><span class="nx">reason</span><span class="p">,</span> <span class="cm">/*...*/</span> <span class="p">};</span>
  <span class="p">}</span>

  <span class="c1">// --- Handle shell commands (like "bash -lc 'npm install'") ---</span>
  <span class="c1">// (Simplified: assumes any other command needs policy check)</span>

  <span class="c1">// --- Default: Check policy for general commands ---</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">policy</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">full-auto</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">auto-approve</span><span class="dl">"</span><span class="p">,</span> <span class="na">runInSandbox</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">reason</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Full auto mode</span><span class="dl">"</span><span class="p">,</span> <span class="cm">/*...*/</span> <span class="p">};</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 'suggest' and 'auto-edit' require asking for commands</span>
    <span class="k">return</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ask-user</span><span class="dl">"</span> <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Helper to check if a command is known to be safe (read-only)</span>
<span class="kd">function</span> <span class="nx">isSafeCommand</span><span class="p">(</span><span class="nx">command</span><span class="p">:</span> <span class="nx">ReadonlyArray</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">):</span> <span class="p">{</span> <span class="nl">reason</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">group</span><span class="p">:</span> <span class="kr">string</span> <span class="p">}</span> <span class="o">|</span> <span class="kc">null</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">cmd</span> <span class="o">=</span> <span class="nx">command</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">([</span><span class="dl">"</span><span class="s2">ls</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">pwd</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">cat</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">git status</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">git diff</span><span class="dl">"</span><span class="p">,</span> <span class="cm">/*...*/</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">cmd</span><span class="p">))</span> <span class="p">{</span>
     <span class="k">return</span> <span class="p">{</span> <span class="na">reason</span><span class="p">:</span> <span class="s2">`Safe read-only command: </span><span class="p">${</span><span class="nx">cmd</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="na">group</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Reading</span><span class="dl">"</span> <span class="p">};</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Helper (simplified) to check if patch affects allowed paths</span>
<span class="kd">function</span> <span class="nx">isWritePatchConstrainedToWritablePaths</span><span class="p">(</span>
  <span class="nx">patch</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span>
  <span class="nx">writableRoots</span><span class="p">:</span> <span class="nx">ReadonlyArray</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span>
<span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="c1">// ... logic to parse patch and check affected file paths ...</span>
  <span class="c1">// ... return true if all paths are within writableRoots ...</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// Simplified for example</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><strong>Inputs:</strong> <code class="language-plaintext highlighter-rouge">canAutoApprove</code> takes the command the AI wants to run (as an array of strings, like <code class="language-plaintext highlighter-rouge">["npm", "install"]</code>), the current <code class="language-plaintext highlighter-rouge">ApprovalPolicy</code> (<code class="language-plaintext highlighter-rouge">suggest</code>, <code class="language-plaintext highlighter-rouge">auto-edit</code>, or <code class="language-plaintext highlighter-rouge">full-auto</code>), and a list of directories where file edits are allowed (<code class="language-plaintext highlighter-rouge">writableRoots</code>, usually just your project’s main folder).</li>
  <li><strong>Checks:</strong> It first handles special cases like <code class="language-plaintext highlighter-rouge">apply_patch</code> (checking the policy and file paths) and known safe, read-only commands using <code class="language-plaintext highlighter-rouge">isSafeCommand</code>.</li>
  <li><strong>Policy Decision:</strong> For other commands, it primarily relies on the policy:
    <ul>
      <li>If <code class="language-plaintext highlighter-rouge">full-auto</code>, it returns <code class="language-plaintext highlighter-rouge">auto-approve</code> but sets <code class="language-plaintext highlighter-rouge">runInSandbox</code> to <code class="language-plaintext highlighter-rouge">true</code>.</li>
      <li>If <code class="language-plaintext highlighter-rouge">suggest</code> or <code class="language-plaintext highlighter-rouge">auto-edit</code>, it returns <code class="language-plaintext highlighter-rouge">ask-user</code>.</li>
    </ul>
  </li>
  <li><strong>Output:</strong> It returns a <code class="language-plaintext highlighter-rouge">SafetyAssessment</code> object telling the <a href="03_agent_loop.md">Agent Loop</a> what to do: <code class="language-plaintext highlighter-rouge">auto-approve</code> (and whether sandboxing is needed), <code class="language-plaintext highlighter-rouge">ask-user</code>, or in rare cases, <code class="language-plaintext highlighter-rouge">reject</code> (if the command is fundamentally invalid).</li>
</ul>

<p>This decision is then used back in the Agent Loop, often within a function like <code class="language-plaintext highlighter-rouge">handleExecCommand</code> (in <code class="language-plaintext highlighter-rouge">handle-exec-command.ts</code>), which we touched on in the previous chapter.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: codex-cli/src/utils/agent/handle-exec-command.ts (Simplified snippet)</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">canAutoApprove</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../approvals.js</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ReviewDecision</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./review.js</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// ... other imports ...</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">handleExecCommand</span><span class="p">(</span>
  <span class="nx">args</span><span class="p">:</span> <span class="nx">ExecInput</span><span class="p">,</span> <span class="c1">// Contains the command array `cmd`</span>
  <span class="nx">config</span><span class="p">:</span> <span class="nx">AppConfig</span><span class="p">,</span>
  <span class="nx">policy</span><span class="p">:</span> <span class="nx">ApprovalPolicy</span><span class="p">,</span>
  <span class="nx">getCommandConfirmation</span><span class="p">:</span> <span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">CommandConfirmation</span><span class="o">&gt;</span><span class="p">,</span> <span class="c1">// UI callback</span>
  <span class="c1">// ... abortSignal ...</span>
<span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">HandleExecCommandResult</span><span class="o">&gt;</span> <span class="p">{</span>

  <span class="c1">// *** Check the approval policy first! ***</span>
  <span class="kd">const</span> <span class="nx">safety</span> <span class="o">=</span> <span class="nx">canAutoApprove</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">policy</span><span class="p">,</span> <span class="p">[</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()]);</span>

  <span class="kd">let</span> <span class="na">runInSandbox</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">safety</span><span class="p">.</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">ask-user</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">// Policy requires asking the user</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="na">review</span><span class="p">:</span> <span class="nx">decision</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getCommandConfirmation</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">safety</span><span class="p">.</span><span class="nx">applyPatch</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">decision</span> <span class="o">!==</span> <span class="nx">ReviewDecision</span><span class="p">.</span><span class="nx">YES</span> <span class="o">&amp;&amp;</span> <span class="nx">decision</span> <span class="o">!==</span> <span class="nx">ReviewDecision</span><span class="p">.</span><span class="nx">ALWAYS</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// User said No or provided feedback to stop</span>
        <span class="k">return</span> <span class="p">{</span> <span class="na">outputText</span><span class="p">:</span> <span class="dl">"</span><span class="s2">aborted</span><span class="dl">"</span><span class="p">,</span> <span class="na">metadata</span><span class="p">:</span> <span class="p">{</span> <span class="cm">/*...*/</span> <span class="p">}</span> <span class="p">};</span>
      <span class="p">}</span>
      <span class="c1">// User approved! Proceed without sandbox (unless policy changes later).</span>
      <span class="nx">runInSandbox</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">auto-approve</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">// Policy allows auto-approval</span>
      <span class="nx">runInSandbox</span> <span class="o">=</span> <span class="nx">safety</span><span class="p">.</span><span class="nx">runInSandbox</span><span class="p">;</span> <span class="c1">// Respect sandbox flag from canAutoApprove</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">reject</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">// Policy outright rejected the command</span>
      <span class="k">return</span> <span class="p">{</span> <span class="na">outputText</span><span class="p">:</span> <span class="dl">"</span><span class="s2">aborted</span><span class="dl">"</span><span class="p">,</span> <span class="na">metadata</span><span class="p">:</span> <span class="p">{</span> <span class="na">reason</span><span class="p">:</span> <span class="nx">safety</span><span class="p">.</span><span class="nx">reason</span> <span class="p">}</span> <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// *** If approved (either automatically or by user), execute the command ***</span>
  <span class="kd">const</span> <span class="nx">summary</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">execCommand</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">safety</span><span class="p">.</span><span class="nx">applyPatch</span><span class="p">,</span> <span class="nx">runInSandbox</span><span class="p">,</span> <span class="cm">/*...*/</span><span class="p">);</span>
  <span class="c1">// ... handle results ...</span>
  <span class="k">return</span> <span class="nx">convertSummaryToResult</span><span class="p">(</span><span class="nx">summary</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This shows how <code class="language-plaintext highlighter-rouge">canAutoApprove</code> is called first. If it returns <code class="language-plaintext highlighter-rouge">ask-user</code>, the <code class="language-plaintext highlighter-rouge">getCommandConfirmation</code> callback (which triggers the UI prompt) is invoked. Only if the assessment is <code class="language-plaintext highlighter-rouge">auto-approve</code> or the user explicitly approves does the code proceed to actually execute the command using <code class="language-plaintext highlighter-rouge">execCommand</code>, passing the <code class="language-plaintext highlighter-rouge">runInSandbox</code> flag determined by the policy check.</p>

<h2 id="conclusion">Conclusion</h2>

<p>The Approval Policy &amp; Security system is Codex’s safety net. It puts you in control, letting you choose the balance between letting the AI work autonomously and requiring manual confirmation for actions that could affect your system. By understanding the <code class="language-plaintext highlighter-rouge">suggest</code>, <code class="language-plaintext highlighter-rouge">auto-edit</code>, and <code class="language-plaintext highlighter-rouge">full-auto</code> modes, you can configure Codex to operate in a way that matches your comfort level with automation and risk. This system works hand-in-hand with the <a href="03_agent_loop.md">Agent Loop</a> to intercept potentially risky actions and enforce the rules you’ve set, sometimes using sandboxing (as we’ll see later) for an extra layer of protection.</p>

<p>Now that we know how Codex decides <em>whether</em> to perform an action, how does it actually understand the AI’s response, especially when the AI wants to use a tool like running a command or applying a patch?</p>

<p>Next up: <a href="05_response___tool_call_handling.md">Response &amp; Tool Call Handling</a></p>

<hr />

<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>
