<h1 id="chapter-6-command-execution--sandboxing">Chapter 6: Command Execution &amp; Sandboxing</h1>

<p>In the <a href="05_response___tool_call_handling.md">previous chapter</a>, we learned how Codex listens to the AI and understands when it wants to use a tool, like running a specific shell command (<code class="language-plaintext highlighter-rouge">git status</code> or <code class="language-plaintext highlighter-rouge">npm install</code>). We also know from the <a href="04_approval_policy___security.md">Approval Policy &amp; Security</a> chapter that Codex checks if it <em>should</em> run the command based on your chosen safety level.</p>

<p>But once Codex has the command and permission (either from you or automatically), how does it actually <em>run</em> that command? And how does it do it safely, especially if you’ve given it more freedom in <code class="language-plaintext highlighter-rouge">full-auto</code> mode?</p>

<p>That’s the job of the <strong>Command Execution &amp; Sandboxing</strong> system.</p>

<h2 id="whats-the-big-idea-the-workshop-safety-zones">What’s the Big Idea? The Workshop Safety Zones</h2>

<p>Imagine Codex is working in a workshop. This system is like the different areas and safety procedures in that workshop:</p>

<ul>
  <li><strong>The Main Workbench (Raw Execution):</strong> For simple, safe tasks (like running <code class="language-plaintext highlighter-rouge">ls</code> to list files), Codex might just use the tools directly on the main workbench. It’s straightforward, but you wouldn’t use dangerous chemicals there.</li>
  <li><strong>The Safety Cage (Sandboxing):</strong> For potentially risky tasks (like testing a powerful new tool, or maybe running a command the AI suggested that you haven’t manually approved in <code class="language-plaintext highlighter-rouge">full-auto</code> mode), Codex moves the work inside a special safety cage. This cage has reinforced walls and maybe limited power outlets, preventing any accidents from affecting the rest of the workshop.</li>
</ul>

<p>This system takes a command requested by the AI (like <code class="language-plaintext highlighter-rouge">python script.py</code> or <code class="language-plaintext highlighter-rouge">git commit -m "AI commit"</code>) and actually runs it on your computer’s command line. Crucially, it decides <em>whether</em> to run it directly (on the workbench) or inside a restricted environment (the safety cage or “sandbox”). It also collects the results – what the command printed (output/stdout), any errors (stderr), and whether it finished successfully (exit code).</p>

<h2 id="key-concepts">Key Concepts</h2>

<ol>
  <li><strong>Raw Execution:</strong>
    <ul>
      <li><strong>What:</strong> Running the command directly using your system’s shell, just like you would type it.</li>
      <li><strong>When:</strong> Used for commands deemed safe, or when you explicitly approve a command in <code class="language-plaintext highlighter-rouge">suggest</code> or <code class="language-plaintext highlighter-rouge">auto-edit</code> mode.</li>
      <li><strong>Pros:</strong> Simple, has full access to your environment (which might be needed).</li>
      <li><strong>Cons:</strong> If the AI makes a mistake and suggests a harmful command, running it raw could cause problems.</li>
    </ul>
  </li>
  <li><strong>Sandboxing:</strong>
    <ul>
      <li><strong>What:</strong> Running the command inside a restricted environment that limits what it can do. Think of it as putting the command in “jail.”</li>
      <li><strong>How (Examples):</strong>
        <ul>
          <li><strong>macOS Seatbelt:</strong> Uses a built-in macOS feature (<code class="language-plaintext highlighter-rouge">sandbox-exec</code>) with a specific policy file to strictly control what the command can access (e.g., only allow writing to the project folder, block network access).</li>
          <li><strong>Docker Container:</strong> Runs the command inside a lightweight container (like the one defined in <code class="language-plaintext highlighter-rouge">codex-cli/Dockerfile</code>). This container has only specific tools installed and can have network rules applied (using <code class="language-plaintext highlighter-rouge">iptables</code>/<code class="language-plaintext highlighter-rouge">ipset</code> via <code class="language-plaintext highlighter-rouge">init_firewall.sh</code>) to limit internet access.</li>
        </ul>
      </li>
      <li><strong>When:</strong> Typically used automatically in <code class="language-plaintext highlighter-rouge">full-auto</code> mode (as decided by the <a href="04_approval_policy___security.md">Approval Policy &amp; Security</a> check), or potentially if a specific command is flagged as needing extra caution.</li>
      <li><strong>Pros:</strong> Significantly reduces the risk of accidental damage from faulty or malicious commands suggested by the AI.</li>
      <li><strong>Cons:</strong> Might prevent a command from working if it legitimately needs access to something the sandbox blocks (like a specific system file or network resource). The setup can be more complex.</li>
    </ul>
  </li>
</ol>

<h2 id="how-it-works-from-approval-to-execution">How It Works: From Approval to Execution</h2>

<p>The Command Execution system doesn’t decide <em>whether</em> to run a command – that’s the job of the <a href="04_approval_policy___security.md">Approval Policy &amp; Security</a>. This system comes into play <em>after</em> the approval check.</p>

<p>Remember the <code class="language-plaintext highlighter-rouge">handleExecCommand</code> function from the <a href="03_agent_loop.md">Agent Loop</a> chapter? It first calls <code class="language-plaintext highlighter-rouge">canAutoApprove</code> (<a href="04_approval_policy___security.md">Approval Policy &amp; Security</a>). If the command is approved (either by policy or by you), <code class="language-plaintext highlighter-rouge">canAutoApprove</code> tells <code class="language-plaintext highlighter-rouge">handleExecCommand</code> <em>whether</em> sandboxing is needed (<code class="language-plaintext highlighter-rouge">runInSandbox: true</code> or <code class="language-plaintext highlighter-rouge">runInSandbox: false</code>).</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: codex-cli/src/utils/agent/handle-exec-command.ts (Simplified Snippet)</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">execCommand</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./exec-command-helper</span><span class="dl">"</span><span class="p">;</span> <span class="c1">// (Conceptual helper name)</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getSandbox</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./sandbox-selector</span><span class="dl">"</span><span class="p">;</span> <span class="c1">// (Conceptual helper name)</span>
<span class="c1">// ... other imports: canAutoApprove, config, policy types ...</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">handleExecCommand</span><span class="p">(</span>
  <span class="nx">args</span><span class="p">:</span> <span class="nx">ExecInput</span><span class="p">,</span> <span class="c1">// Contains { cmd: ["git", "status"], ... }</span>
  <span class="nx">config</span><span class="p">:</span> <span class="nx">AppConfig</span><span class="p">,</span>
  <span class="nx">policy</span><span class="p">:</span> <span class="nx">ApprovalPolicy</span><span class="p">,</span>
  <span class="nx">getCommandConfirmation</span><span class="p">:</span> <span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">CommandConfirmation</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="c1">// ... abortSignal ...</span>
<span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">HandleExecCommandResult</span><span class="o">&gt;</span> <span class="p">{</span>

  <span class="c1">// 1. Check policy (calls canAutoApprove)</span>
  <span class="kd">const</span> <span class="nx">safety</span> <span class="o">=</span> <span class="nx">canAutoApprove</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">policy</span><span class="p">,</span> <span class="p">[</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()]);</span>
  <span class="kd">let</span> <span class="na">runInSandbox</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>

  <span class="c1">// 2. Determine if approved and if sandbox needed</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">safety</span><span class="p">.</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">ask-user</span><span class="dl">"</span><span class="p">:</span>
      <span class="c1">// Ask user via getCommandConfirmation...</span>
      <span class="c1">// If approved, runInSandbox = false;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">auto-approve</span><span class="dl">"</span><span class="p">:</span>
      <span class="nx">runInSandbox</span> <span class="o">=</span> <span class="nx">safety</span><span class="p">.</span><span class="nx">runInSandbox</span><span class="p">;</span> <span class="c1">// Get sandbox flag from policy check</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="c1">// ... handle reject ...</span>
  <span class="p">}</span>

  <span class="c1">// 3. *** Execute the command! ***</span>
  <span class="c1">// Determine the actual sandbox mechanism (Seatbelt, Docker, None)</span>
  <span class="kd">const</span> <span class="nx">sandboxType</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getSandbox</span><span class="p">(</span><span class="nx">runInSandbox</span><span class="p">);</span>
  <span class="c1">// Call the function that handles execution</span>
  <span class="kd">const</span> <span class="nx">summary</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">execCommand</span><span class="p">(</span>
    <span class="nx">args</span><span class="p">,</span>
    <span class="nx">applyPatch</span><span class="p">,</span> <span class="c1">// (if it was an apply_patch command)</span>
    <span class="nx">sandboxType</span><span class="p">,</span>
    <span class="nx">abortSignal</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="c1">// 4. Format and return results</span>
  <span class="k">return</span> <span class="nx">convertSummaryToResult</span><span class="p">(</span><span class="nx">summary</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><strong>Steps 1 &amp; 2:</strong> Approval policy is checked, maybe the user is asked. We get the <code class="language-plaintext highlighter-rouge">runInSandbox</code> boolean.</li>
  <li><strong>Step 3:</strong> A helper (<code class="language-plaintext highlighter-rouge">getSandbox</code>) determines the specific <code class="language-plaintext highlighter-rouge">SandboxType</code> (e.g., <code class="language-plaintext highlighter-rouge">MACOS_SEATBELT</code> or <code class="language-plaintext highlighter-rouge">NONE</code>) based on <code class="language-plaintext highlighter-rouge">runInSandbox</code> and the operating system. Then, the core execution function (<code class="language-plaintext highlighter-rouge">execCommand</code>) is called, passing the command details and the chosen <code class="language-plaintext highlighter-rouge">sandboxType</code>.</li>
  <li><strong>Step 4:</strong> The results (stdout, stderr, exit code) from <code class="language-plaintext highlighter-rouge">execCommand</code> are packaged up.</li>
</ul>

<h2 id="under-the-hood-running-the-command">Under the Hood: Running the Command</h2>

<p>Let’s trace the execution flow:</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant HEC as handleExecCommand
    participant EC as execCommand (Helper)
    participant Exec as exec (exec.ts)
    participant Raw as rawExec (raw-exec.ts)
    participant SB as execWithSeatbelt (macos-seatbelt.ts)

    HEC-&gt;&gt;EC: Run `git status`, sandboxType=NONE
    EC-&gt;&gt;Exec: Calls exec({cmd: ["git", "status"], ...}, SandboxType.NONE)
    Exec-&gt;&gt;Exec: Selects rawExec based on sandboxType
    Exec-&gt;&gt;Raw: Calls rawExec(["git", "status"], ...)
    Raw-&gt;&gt;NodeJS: Uses child_process.spawn("git", ["status"], ...)
    NodeJS--&gt;&gt;Raw: Command finishes (stdout, stderr, code)
    Raw--&gt;&gt;Exec: Returns result
    Exec--&gt;&gt;EC: Returns result
    EC--&gt;&gt;HEC: Returns final summary

    %% Example with Sandbox %%
    HEC-&gt;&gt;EC: Run `dangerous_script.sh`, sandboxType=MACOS_SEATBELT
    EC-&gt;&gt;Exec: Calls exec({cmd: ["dangerous..."], ...}, SandboxType.MACOS_SEATBELT)
    Exec-&gt;&gt;Exec: Selects execWithSeatbelt based on sandboxType
    Exec-&gt;&gt;SB: Calls execWithSeatbelt(["dangerous..."], ...)
    SB-&gt;&gt;SB: Constructs `sandbox-exec` command with policy
    SB-&gt;&gt;Raw: Calls rawExec(["sandbox-exec", "-p", policy, "--", "dangerous..."], ...)
    Raw-&gt;&gt;NodeJS: Uses child_process.spawn("sandbox-exec", [...])
    NodeJS--&gt;&gt;Raw: Sandboxed command finishes (stdout, stderr, code)
    Raw--&gt;&gt;SB: Returns result
    SB--&gt;&gt;Exec: Returns result
    Exec--&gt;&gt;EC: Returns result
    EC--&gt;&gt;HEC: Returns final summary
</code></pre>

<h3 id="the-entry-point-exects">The Entry Point: <code class="language-plaintext highlighter-rouge">exec.ts</code></h3>

<p>This file acts as a router. It takes the command and the desired <code class="language-plaintext highlighter-rouge">SandboxType</code> and calls the appropriate execution function.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: codex-cli/src/utils/agent/exec.ts (Simplified)</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">ExecInput</span><span class="p">,</span> <span class="nx">ExecResult</span><span class="p">,</span> <span class="nx">SandboxType</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./sandbox/interface.js</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">execWithSeatbelt</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./sandbox/macos-seatbelt.js</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">exec</span> <span class="k">as</span> <span class="nx">rawExec</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./sandbox/raw-exec.js</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// ... other imports like process_patch for apply_patch ...</span>

<span class="c1">// Never rejects, maps errors to non-zero exit code / stderr</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">exec</span><span class="p">(</span>
  <span class="p">{</span> <span class="nx">cmd</span><span class="p">,</span> <span class="nx">workdir</span><span class="p">,</span> <span class="nx">timeoutInMillis</span> <span class="p">}:</span> <span class="nx">ExecInput</span><span class="p">,</span>
  <span class="nx">sandbox</span><span class="p">:</span> <span class="nx">SandboxType</span><span class="p">,</span> <span class="c1">// e.g., NONE, MACOS_SEATBELT</span>
  <span class="nx">abortSignal</span><span class="p">?:</span> <span class="nx">AbortSignal</span><span class="p">,</span>
<span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExecResult</span><span class="o">&gt;</span> <span class="p">{</span>

  <span class="c1">// Decide which execution function to use</span>
  <span class="kd">const</span> <span class="nx">execFunction</span> <span class="o">=</span>
    <span class="nx">sandbox</span> <span class="o">===</span> <span class="nx">SandboxType</span><span class="p">.</span><span class="nx">MACOS_SEATBELT</span> <span class="p">?</span> <span class="nx">execWithSeatbelt</span> <span class="p">:</span> <span class="nx">rawExec</span><span class="p">;</span>

  <span class="kd">const</span> <span class="na">opts</span><span class="p">:</span> <span class="nx">SpawnOptions</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* ... set timeout, workdir ... */</span> <span class="p">};</span>
  <span class="kd">const</span> <span class="nx">writableRoots</span> <span class="o">=</span> <span class="p">[</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">tmpdir</span><span class="p">()];</span> <span class="c1">// Basic allowed paths</span>

  <span class="c1">// Call the chosen function (either raw or sandboxed)</span>
  <span class="k">return</span> <span class="nx">execFunction</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">writableRoots</span><span class="p">,</span> <span class="nx">abortSignal</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Special handler for apply_patch pseudo-command</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">execApplyPatch</span><span class="p">(</span><span class="nx">patchText</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">ExecResult</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// Use file system operations directly (fs.writeFileSync etc.)</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">process_patch</span><span class="p">(</span><span class="cm">/* ... patchText, fs functions ... */</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span> <span class="na">stdout</span><span class="p">:</span> <span class="nx">result</span><span class="p">,</span> <span class="na">stderr</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span> <span class="na">exitCode</span><span class="p">:</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">:</span> <span class="nx">unknown</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Handle errors during patching</span>
    <span class="k">return</span> <span class="p">{</span> <span class="na">stdout</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span> <span class="na">stderr</span><span class="p">:</span> <span class="nb">String</span><span class="p">(</span><span class="nx">error</span><span class="p">),</span> <span class="na">exitCode</span><span class="p">:</span> <span class="mi">1</span> <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>It receives the command (<code class="language-plaintext highlighter-rouge">cmd</code>), options (<code class="language-plaintext highlighter-rouge">workdir</code>, <code class="language-plaintext highlighter-rouge">timeout</code>), and the <code class="language-plaintext highlighter-rouge">sandbox</code> type.</li>
  <li>It checks the <code class="language-plaintext highlighter-rouge">sandbox</code> type and chooses either <code class="language-plaintext highlighter-rouge">execWithSeatbelt</code> (for macOS sandbox) or <code class="language-plaintext highlighter-rouge">rawExec</code> (for direct execution).</li>
  <li>It calls the selected function.</li>
  <li>Note: <code class="language-plaintext highlighter-rouge">apply_patch</code> is handled specially by <code class="language-plaintext highlighter-rouge">execApplyPatch</code>, which directly uses Node.js file system functions instead of spawning a shell command.</li>
</ul>

<h3 id="raw-execution-raw-exects">Raw Execution: <code class="language-plaintext highlighter-rouge">raw-exec.ts</code></h3>

<p>This function runs the command directly using Node.js’s built-in <code class="language-plaintext highlighter-rouge">child_process.spawn</code>.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: codex-cli/src/utils/agent/sandbox/raw-exec.ts (Simplified)</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">ExecResult</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./interface</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">spawn</span><span class="p">,</span> <span class="kd">type</span> <span class="nx">SpawnOptions</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">child_process</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">isLoggingEnabled</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../log.js</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">MAX_BUFFER</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">// 100 KB limit for stdout/stderr</span>

<span class="c1">// Never rejects, maps errors to non-zero exit code / stderr</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">exec</span><span class="p">(</span>
  <span class="nx">command</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">,</span> <span class="c1">// e.g., ["git", "status"]</span>
  <span class="nx">options</span><span class="p">:</span> <span class="nx">SpawnOptions</span><span class="p">,</span>
  <span class="nx">_writableRoots</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">,</span> <span class="c1">// Not used in raw exec</span>
  <span class="nx">abortSignal</span><span class="p">?:</span> <span class="nx">AbortSignal</span><span class="p">,</span>
<span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExecResult</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">prog</span> <span class="o">=</span> <span class="nx">command</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kd">const</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">command</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExecResult</span><span class="o">&gt;</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Spawn the child process</span>
    <span class="kd">const</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">spawn</span><span class="p">(</span><span class="nx">prog</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="p">{</span>
      <span class="p">...</span><span class="nx">options</span><span class="p">,</span>
      <span class="na">stdio</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">ignore</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">pipe</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">pipe</span><span class="dl">"</span><span class="p">],</span> <span class="c1">// Don't wait for stdin, capture stdout/err</span>
      <span class="na">detached</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// Allows killing process group on abort</span>
    <span class="p">});</span>

    <span class="c1">// Handle abort signal if provided</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">abortSignal</span><span class="p">)</span> <span class="p">{</span>
       <span class="c1">// Add listener to kill child process if aborted</span>
       <span class="c1">// ... abort handling logic ...</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nx">stdout</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">stderr</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
    <span class="c1">// Capture stdout/stderr, respecting MAX_BUFFER limit</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">stdout</span><span class="p">?.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="cm">/* append to stdout if under limit */</span> <span class="p">});</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">stderr</span><span class="p">?.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="cm">/* append to stderr if under limit */</span> <span class="p">});</span>

    <span class="c1">// Handle process exit</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">exit</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">signal</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">({</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">,</span> <span class="na">exitCode</span><span class="p">:</span> <span class="nx">code</span> <span class="o">??</span> <span class="mi">1</span> <span class="p">});</span>
    <span class="p">});</span>

    <span class="c1">// Handle errors like "command not found"</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">({</span> <span class="na">stdout</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span> <span class="na">stderr</span><span class="p">:</span> <span class="nb">String</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span> <span class="na">exitCode</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>It uses <code class="language-plaintext highlighter-rouge">child_process.spawn</code> to run the command. <code class="language-plaintext highlighter-rouge">spawn</code> is generally safer than <code class="language-plaintext highlighter-rouge">exec</code> as it doesn’t involve an intermediate shell unless explicitly requested.</li>
  <li>It captures <code class="language-plaintext highlighter-rouge">stdout</code> and <code class="language-plaintext highlighter-rouge">stderr</code> data, enforcing a maximum buffer size to prevent memory issues.</li>
  <li>It listens for the <code class="language-plaintext highlighter-rouge">exit</code> event to get the exit code.</li>
  <li>It listens for the <code class="language-plaintext highlighter-rouge">error</code> event (e.g., if the command executable doesn’t exist).</li>
  <li>It includes logic to kill the child process if the <code class="language-plaintext highlighter-rouge">abortSignal</code> is triggered (e.g., user presses Ctrl+C).</li>
  <li>Crucially, it always <code class="language-plaintext highlighter-rouge">resolve</code>s the promise, even on errors, packaging the error into the <code class="language-plaintext highlighter-rouge">ExecResult</code>.</li>
</ul>

<h3 id="sandboxing-on-macos-macos-seatbeltts">Sandboxing on macOS: <code class="language-plaintext highlighter-rouge">macos-seatbelt.ts</code></h3>

<p>This function wraps the command execution using macOS’s <code class="language-plaintext highlighter-rouge">sandbox-exec</code> tool.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: codex-cli/src/utils/agent/sandbox/macos-seatbelt.ts (Simplified)</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">ExecResult</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./interface.js</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">exec</span> <span class="k">as</span> <span class="nx">rawExec</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./raw-exec.js</span><span class="dl">"</span><span class="p">;</span> <span class="c1">// Uses raw exec internally!</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../log.js</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">READ_ONLY_POLICY_BASE</span> <span class="o">=</span> <span class="s2">`
(version 1)
(deny default)
(allow file-read*) ; Allow reading most things
(allow process-exec process-fork signal) ; Allow running/forking
(allow sysctl-read) ; Allow reading system info
; ... more base rules ...
`</span><span class="p">;</span>

<span class="c1">// Runs command inside macOS Seatbelt sandbox</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">execWithSeatbelt</span><span class="p">(</span>
  <span class="nx">cmd</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">,</span> <span class="c1">// The original command e.g., ["python", "script.py"]</span>
  <span class="nx">opts</span><span class="p">:</span> <span class="nx">SpawnOptions</span><span class="p">,</span>
  <span class="nx">writableRoots</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">,</span> <span class="c1">// Dirs allowed for writing, e.g., project root</span>
  <span class="nx">abortSignal</span><span class="p">?:</span> <span class="nx">AbortSignal</span><span class="p">,</span>
<span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExecResult</span><span class="o">&gt;</span> <span class="p">{</span>

  <span class="c1">// 1. Build the sandbox policy string</span>
  <span class="kd">let</span> <span class="nx">policy</span> <span class="o">=</span> <span class="nx">READ_ONLY_POLICY_BASE</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">policyParams</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">writableRoots</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Add rules to allow writing ONLY within specified roots</span>
    <span class="kd">const</span> <span class="nx">writeRules</span> <span class="o">=</span> <span class="nx">writableRoots</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
      <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`(allow file-write* (subpath (param "WR_</span><span class="p">${</span><span class="nx">i</span><span class="p">}</span><span class="s2">")))`</span>
    <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">policy</span> <span class="o">+=</span> <span class="s2">`\n</span><span class="p">${</span><span class="nx">writeRules</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    <span class="c1">// Create parameters for sandbox-exec</span>
    <span class="nx">policyParams</span> <span class="o">=</span> <span class="nx">writableRoots</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">root</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`-DWR_</span><span class="p">${</span><span class="nx">i</span><span class="p">}</span><span class="s2">=</span><span class="p">${</span><span class="nx">root</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">`Seatbelt Policy: </span><span class="p">${</span><span class="nx">policy</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>

  <span class="c1">// 2. Construct the actual command to run: sandbox-exec + policy + original command</span>
  <span class="kd">const</span> <span class="nx">fullCommand</span> <span class="o">=</span> <span class="p">[</span>
    <span class="dl">"</span><span class="s2">sandbox-exec</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">-p</span><span class="dl">"</span><span class="p">,</span> <span class="nx">policy</span><span class="p">,</span> <span class="c1">// Pass the policy string</span>
    <span class="p">...</span><span class="nx">policyParams</span><span class="p">,</span> <span class="c1">// Pass parameters like -DWR_0=/path/to/project</span>
    <span class="dl">"</span><span class="s2">--</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// End of sandbox-exec options</span>
    <span class="p">...</span><span class="nx">cmd</span><span class="p">,</span> <span class="c1">// The original command and arguments</span>
  <span class="p">];</span>

  <span class="c1">// 3. Execute the `sandbox-exec` command using rawExec</span>
  <span class="k">return</span> <span class="nx">rawExec</span><span class="p">(</span><span class="nx">fullCommand</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">abortSignal</span><span class="p">);</span> <span class="c1">// writableRoots not needed by rawExec here</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>It defines a base Seatbelt policy (<code class="language-plaintext highlighter-rouge">.sb</code> file format) that denies most actions by default but allows basic read operations and process execution.</li>
  <li>It dynamically adds <code class="language-plaintext highlighter-rouge">allow file-write*</code> rules for the specific <code class="language-plaintext highlighter-rouge">writableRoots</code> provided (usually the project directory and temp directories).</li>
  <li>It constructs a new command line that starts with <code class="language-plaintext highlighter-rouge">sandbox-exec</code>, passes the generated policy (<code class="language-plaintext highlighter-rouge">-p</code>), passes parameters defining the writable roots (<code class="language-plaintext highlighter-rouge">-D</code>), and finally appends the original command.</li>
  <li>It then calls <code class="language-plaintext highlighter-rouge">rawExec</code> to run this <em>entire</em> <code class="language-plaintext highlighter-rouge">sandbox-exec ... -- original-command ...</code> line. The operating system handles enforcing the sandbox rules.</li>
</ul>

<h3 id="sandboxing-with-docker-dockerfile">Sandboxing with Docker: <code class="language-plaintext highlighter-rouge">Dockerfile</code></h3>

<p>Another approach, often used on Linux or as a fallback, is Docker. The <code class="language-plaintext highlighter-rouge">Dockerfile</code> defines the restricted environment.</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># File: codex-cli/Dockerfile (Simplified Snippets)</span>

<span class="c"># Start from a basic Node.js image</span>
<span class="k">FROM</span><span class="s"> node:20</span>

<span class="c"># Install only necessary tools (git, jq, rg, maybe python/bash, etc.)</span>
<span class="c"># Avoid installing powerful tools unless absolutely needed.</span>
<span class="k">RUN </span>apt update <span class="o">&amp;&amp;</span> apt <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\
</span>  git jq ripgrep <span class="nb">sudo </span>iproute2 iptables ipset <span class="se">\
</span>  <span class="c"># ... other minimal tools ...</span>
  &amp;&amp; apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*

# Copy codex itself into the container
<span class="k">COPY</span><span class="s"> dist/codex.tgz codex.tgz</span>
<span class="k">RUN </span>npm <span class="nb">install</span> <span class="nt">-g</span> codex.tgz

<span class="c"># Setup non-root user</span>
<span class="k">USER</span><span class="s"> node</span>
<span class="k">WORKDIR</span><span class="s"> /home/node/workspace # Work happens here</span>

<span class="c"># Copy and set up firewall script (runs via sudo)</span>
<span class="c"># This script uses iptables/ipset to block network access by default,</span>
<span class="c"># potentially allowing only specific domains if configured.</span>
<span class="k">COPY</span><span class="s"> scripts/init_firewall.sh /usr/local/bin/</span>
<span class="k">USER</span><span class="s"> root</span>
<span class="k">RUN </span><span class="nb">chmod</span> +x /usr/local/bin/init_firewall.sh <span class="o">&amp;&amp;</span> <span class="se">\
</span>  <span class="c"># Allow 'node' user to run firewall script via sudo without password</span>
  echo "node ALL=(root) NOPASSWD: /usr/local/bin/init_firewall.sh" &gt; /etc/sudoers.d/node-firewall
<span class="k">USER</span><span class="s"> node</span>

<span class="c"># Default command when container starts (might be codex or just a shell)</span>
<span class="c"># ENTRYPOINT ["codex"]</span>
</code></pre></div></div>

<ul>
  <li><strong>Minimal Tools:</strong> The Docker image includes only a limited set of command-line tools, reducing the potential attack surface.</li>
  <li><strong>Non-Root User:</strong> Commands run as a non-privileged user (<code class="language-plaintext highlighter-rouge">node</code>) inside the container.</li>
  <li><strong>Workspace:</strong> Work typically happens in a specific directory (e.g., <code class="language-plaintext highlighter-rouge">/home/node/workspace</code>), often mapped to your project directory on the host machine.</li>
  <li><strong>Network Firewall:</strong> An <code class="language-plaintext highlighter-rouge">init_firewall.sh</code> script (run via <code class="language-plaintext highlighter-rouge">sudo</code> at startup or when needed) configures <code class="language-plaintext highlighter-rouge">iptables</code> to restrict network access. This prevents sandboxed commands from easily calling out to arbitrary internet addresses.</li>
  <li><strong>Usage:</strong> Codex might be run <em>entirely</em> within this container, or it might invoke commands <em>inside</em> this container from the outside using <code class="language-plaintext highlighter-rouge">docker exec</code>.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>You’ve reached the end of the workshop tour! The <strong>Command Execution &amp; Sandboxing</strong> system is Codex’s way of actually <em>doing</em> things on the command line when instructed by the AI. It carefully considers the safety level decided by the <a href="04_approval_policy___security.md">Approval Policy &amp; Security</a> and chooses the right execution method: direct “raw” execution for trusted commands, or running inside a protective “sandbox” (like macOS Seatbelt or a Docker container) for potentially riskier operations, especially in <code class="language-plaintext highlighter-rouge">full-auto</code> mode. This layered approach allows Codex to be powerful while providing crucial safety mechanisms against unintended consequences.</p>

<p>We’ve seen how Codex handles input, talks to the AI, checks policies, and executes commands. But how does Codex know <em>which</em> AI model to use, what your API key is, or which approval mode you prefer? All these settings need to be managed.</p>

<p>Next up: <a href="07_configuration_management.md">Configuration Management</a></p>

<hr />

<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>
