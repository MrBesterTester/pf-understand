<h1 id="chapter-8-single-pass-mode">Chapter 8: Single-Pass Mode</h1>

<p>In the <a href="07_configuration_management.md">previous chapter</a>, we explored how Codex uses configuration files to remember your preferences and follow custom instructions. We’ve mostly seen Codex operate in its default interactive mode, like having a conversation in the <a href="01_terminal_ui__ink_components_.md">Terminal UI</a> where the <a href="03_agent_loop.md">Agent Loop</a> goes back and forth with the AI.</p>

<p>But what if you have a task that’s very clearly defined? Imagine you want to rename a function across your entire project. You know exactly what needs to be done, and you don’t really need a back-and-forth chat. Wouldn’t it be faster if you could just give Codex the instructions and have it figure out <em>all</em> the necessary changes at once?</p>

<p>That’s exactly the idea behind <strong>Single-Pass Mode</strong>.</p>

<h2 id="whats-the-big-idea-the-architect-analogy">What’s the Big Idea? The Architect Analogy</h2>

<p>Think about building a house. The normal, interactive mode of Codex is like having a conversation with your architect room by room: “Let’s design the kitchen.” “Okay, now how about the living room?” “Should we add a window here?”. It’s collaborative and allows for adjustments along the way.</p>

<p><strong>Single-Pass Mode</strong> is different. It’s like giving the architect the complete blueprints, all the requirements, and the site survey <em>upfront</em>, and asking them to come back with the <em>final, complete building plan</em> in one go.</p>

<p>In this experimental mode, Codex tries to:</p>

<ol>
  <li>Gather a large amount of context about your project (lots of code files).</li>
  <li>Send your request <em>and</em> all that context to the AI model <em>at the same time</em>.</li>
  <li>Ask the AI to generate a <em>complete set</em> of file operations (creations, updates, deletions) needed to fulfill your request, all in a single response.</li>
  <li>Show you the proposed changes for review.</li>
  <li>If you approve, apply all the changes and exit.</li>
</ol>

<p>This mode aims for efficiency, especially on larger, well-defined tasks where you’re reasonably confident the AI can generate the full solution without needing clarification.</p>

<h2 id="key-concepts">Key Concepts</h2>

<ol>
  <li><strong>Full Context (Within Limits):</strong> Instead of just looking at one or two files, Codex gathers the content of many files in your project (respecting ignore rules from <a href="07_configuration_management.md">Configuration Management</a> and size limits like <code class="language-plaintext highlighter-rouge">MAX_CONTEXT_CHARACTER_LIMIT</code>). This gives the AI a broader view of your codebase.</li>
  <li><strong>Single Structured Response:</strong> The AI isn’t just asked for text. It’s specifically instructed to respond with a structured list of <em>all</em> the file operations required. Codex uses a predefined schema (like <code class="language-plaintext highlighter-rouge">EditedFilesSchema</code> defined using Zod in <code class="language-plaintext highlighter-rouge">file_ops.ts</code>) to tell the AI exactly how to format this list.</li>
  <li><strong>All-or-Nothing Confirmation:</strong> You are presented with a summary and a diff (showing additions and deletions) of <em>all</em> the proposed changes across all affected files. You then give a single “Yes” or “No” to apply everything or nothing.</li>
  <li><strong>Efficiency for Defined Tasks:</strong> This mode shines when your instructions are clear and the task doesn’t likely require interactive refinement (e.g., “Rename function X to Y everywhere”, “Add logging to every public method in class Z”).</li>
</ol>

<h2 id="how-to-use-it">How to Use It</h2>

<p>You typically invoke single-pass mode using a specific command-line flag when running Codex (the exact flag might vary, but let’s assume <code class="language-plaintext highlighter-rouge">--single-pass</code>).</p>

<p><strong>Example:</strong></p>

<p>Let’s say you want to rename a function <code class="language-plaintext highlighter-rouge">calculate_total</code> to <code class="language-plaintext highlighter-rouge">compute_grand_total</code> throughout your project located in <code class="language-plaintext highlighter-rouge">~/my-sales-app/</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/my-sales-app/
codex <span class="nt">--single-pass</span> <span class="s2">"Rename the function 'calculate_total' to 'compute_grand_total' in all project files."</span>
</code></pre></div></div>

<p><strong>What Happens:</strong></p>

<ol>
  <li><strong>Context Loading:</strong> Codex will identify the files in <code class="language-plaintext highlighter-rouge">~/my-sales-app/</code> (respecting ignores), read their content, and note the size. You might see output indicating this.</li>
  <li><strong>AI Thinking:</strong> It sends your prompt and the file contents to the AI, asking for the complete set of changes. You’ll likely see a spinner.</li>
  <li><strong>Review:</strong> Codex receives the proposed file operations from the AI. It calculates the differences (diffs) and shows you a summary:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Summary:
  Modified: src/utils.py (+1/-1)
  Modified: tests/test_utils.py (+1/-1)
  Modified: main_app.py (+1/-1)

Proposed Diffs:
================================================================================
Changes for: src/utils.py
--------------------------------------------------------------------------------
@@ -10,7 +10,7 @@
 # ... code ...

-def calculate_total(items):
+def compute_grand_total(items):
   # ... implementation ...

# ... (more diffs for other files) ...

Apply these changes? [y/N]
</code></pre></div>    </div>
  </li>
  <li><strong>Confirmation:</strong> You type <code class="language-plaintext highlighter-rouge">y</code> and press Enter.</li>
  <li><strong>Applying:</strong> Codex modifies the files <code class="language-plaintext highlighter-rouge">src/utils.py</code>, <code class="language-plaintext highlighter-rouge">tests/test_utils.py</code>, and <code class="language-plaintext highlighter-rouge">main_app.py</code> according to the diffs.</li>
  <li><strong>Exit:</strong> The Codex process finishes.</li>
</ol>

<p>If you had typed <code class="language-plaintext highlighter-rouge">n</code>, no files would have been changed.</p>

<h2 id="under-the-hood-the-single-pass-flow">Under the Hood: The Single-Pass Flow</h2>

<p>Let’s trace the journey when you run <code class="language-plaintext highlighter-rouge">codex --single-pass "prompt"</code>:</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant User
    participant CLI as Codex CLI (SinglePass)
    participant ContextLoader as context_files.ts
    participant OpenAI
    participant FileSystem

    User-&gt;&gt;CLI: Runs `codex --single-pass "Rename func..."`
    CLI-&gt;&gt;ContextLoader: Get project file contents (respecting ignores)
    ContextLoader-&gt;&gt;FileSystem: Reads relevant files
    FileSystem--&gt;&gt;ContextLoader: File contents
    ContextLoader--&gt;&gt;CLI: Returns list of files &amp; content
    CLI-&gt;&gt;CLI: Formats huge prompt (request + file contents) using `renderTaskContext`
    CLI-&gt;&gt;OpenAI: Sends single large request (expecting structured `EditedFilesSchema` response)
    Note over CLI, OpenAI: AI processes context and request
    OpenAI--&gt;&gt;CLI: Returns structured response { ops: [ {path:..., updated_full_content:...}, ... ] }
    CLI-&gt;&gt;CLI: Parses the `ops` list (`file_ops.ts`)
    CLI-&gt;&gt;CLI: Generates diffs and summary (`code_diff.ts`)
    CLI-&gt;&gt;User: Displays summary &amp; diffs, asks "Apply changes? [y/N]"
    User-&gt;&gt;CLI: Types 'y'
    CLI-&gt;&gt;FileSystem: Applies changes (writes updated content, creates/deletes files)
    CLI-&gt;&gt;User: Shows "Changes applied." message
    CLI-&gt;&gt;CLI: Exits
</code></pre>

<ol>
  <li><strong>Invocation:</strong> The CLI (<code class="language-plaintext highlighter-rouge">cli_singlepass.tsx</code>) is started in single-pass mode.</li>
  <li><strong>Context Gathering:</strong> It uses functions like <code class="language-plaintext highlighter-rouge">getFileContents</code> from <code class="language-plaintext highlighter-rouge">utils/singlepass/context_files.ts</code> to read the content of project files, respecting ignore patterns and size limits.</li>
  <li><strong>Prompt Construction:</strong> It builds a large prompt using <code class="language-plaintext highlighter-rouge">renderTaskContext</code> from <code class="language-plaintext highlighter-rouge">utils/singlepass/context.ts</code>. This prompt includes your request and embeds the content of all gathered files, often in an XML-like format.</li>
  <li><strong>AI Call:</strong> It sends this single, massive prompt to the OpenAI API. Crucially, it tells the API to format the response according to a specific structure (<code class="language-plaintext highlighter-rouge">EditedFilesSchema</code> from <code class="language-plaintext highlighter-rouge">utils/singlepass/file_ops.ts</code>) which expects a list of file operations.</li>
  <li><strong>Response Parsing:</strong> The CLI receives the response and uses the <code class="language-plaintext highlighter-rouge">EditedFilesSchema</code> to parse the expected list of operations (create file, update file content, delete file, move file).</li>
  <li><strong>Diffing &amp; Summary:</strong> It uses helpers like <code class="language-plaintext highlighter-rouge">generateDiffSummary</code> and <code class="language-plaintext highlighter-rouge">generateEditSummary</code> from <code class="language-plaintext highlighter-rouge">utils/singlepass/code_diff.ts</code> to compare the proposed <code class="language-plaintext highlighter-rouge">updated_full_content</code> for each operation against the original file content, generating human-readable diffs and a summary.</li>
  <li><strong>Confirmation:</strong> The main application component (<code class="language-plaintext highlighter-rouge">SinglePassApp</code> in <code class="language-plaintext highlighter-rouge">components/singlepass-cli-app.tsx</code>) displays the summary and diffs using Ink components and prompts the user for confirmation (<code class="language-plaintext highlighter-rouge">ConfirmationPrompt</code>).</li>
  <li><strong>Application:</strong> If confirmed, the <code class="language-plaintext highlighter-rouge">applyFileOps</code> function iterates through the parsed operations and uses Node.js’s <code class="language-plaintext highlighter-rouge">fs.promises</code> module (<code class="language-plaintext highlighter-rouge">fsPromises.writeFile</code>, <code class="language-plaintext highlighter-rouge">fsPromises.unlink</code>, etc.) to modify the files on disk.</li>
  <li><strong>Exit:</strong> The application cleans up and exits.</li>
</ol>

<h2 id="diving-into-code">Diving into Code</h2>

<p>Let’s look at the key parts involved.</p>

<h3 id="starting-single-pass-mode-cli_singlepasstsx">Starting Single-Pass Mode (<code class="language-plaintext highlighter-rouge">cli_singlepass.tsx</code>)</h3>

<p>This module likely provides the entry point function called by the main CLI when the <code class="language-plaintext highlighter-rouge">--single-pass</code> flag is detected.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: codex-cli/src/cli_singlepass.tsx (Simplified)</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">AppConfig</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./utils/config</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">SinglePassApp</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./components/singlepass-cli-app</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">render</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">ink</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span><span class="p">;</span>

<span class="c1">// This function is called by the main CLI logic</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">runSinglePass</span><span class="p">({</span>
  <span class="nx">originalPrompt</span><span class="p">,</span> <span class="c1">// The user's request string</span>
  <span class="nx">config</span><span class="p">,</span>         <span class="c1">// Loaded configuration (model, instructions)</span>
  <span class="nx">rootPath</span><span class="p">,</span>       <span class="c1">// The project directory</span>
<span class="p">}:</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Render the dedicated Ink UI for single-pass mode</span>
    <span class="nx">render</span><span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">SinglePassApp</span>
        <span class="nx">originalPrompt</span><span class="o">=</span><span class="p">{</span><span class="nx">originalPrompt</span><span class="p">}</span>
        <span class="nx">config</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">}</span>
        <span class="nx">rootPath</span><span class="o">=</span><span class="p">{</span><span class="nx">rootPath</span><span class="p">}</span>
        <span class="nx">onExit</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">()}</span> <span class="c1">// Callback when the app is done</span>
      <span class="sr">/&gt;</span><span class="err">,
</span>    <span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><strong>Explanation:</strong> This function simply renders the main React component (<code class="language-plaintext highlighter-rouge">SinglePassApp</code>) responsible for the entire single-pass UI and logic, passing along the user’s prompt and configuration. It uses a Promise to signal when the process is complete.</li>
</ul>

<h3 id="the-main-ui-and-logic-singlepass-cli-apptsx">The Main UI and Logic (<code class="language-plaintext highlighter-rouge">singlepass-cli-app.tsx</code>)</h3>

<p>This component manages the state (loading, thinking, confirming, etc.) and orchestrates the single-pass flow.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: codex-cli/src/components/singlepass-cli-app.tsx (Simplified Snippets)</span>
<span class="k">import</span> <span class="nx">React</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useEffect</span><span class="p">,</span> <span class="nx">useState</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Box</span><span class="p">,</span> <span class="nx">Text</span><span class="p">,</span> <span class="nx">useApp</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">ink</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">OpenAI</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">openai</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">zodResponseFormat</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">openai/helpers/zod</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// --- Local Utils ---</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getFileContents</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../utils/singlepass/context_files</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">renderTaskContext</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../utils/singlepass/context</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">EditedFilesSchema</span><span class="p">,</span> <span class="nx">FileOperation</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../utils/singlepass/file_ops</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">generateDiffSummary</span><span class="p">,</span> <span class="nx">generateEditSummary</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../utils/singlepass/code_diff</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">fsPromises</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">fs/promises</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// --- UI Components ---</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">InputPrompt</span><span class="p">,</span> <span class="nx">ConfirmationPrompt</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./prompts</span><span class="dl">"</span><span class="p">;</span> <span class="c1">// Conceptual grouping</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">SinglePassApp</span><span class="p">({</span> <span class="cm">/* ...props: config, rootPath, onExit ... */</span> <span class="p">}):</span> <span class="nx">JSX</span><span class="p">.</span><span class="nx">Element</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">useApp</span><span class="p">();</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">state</span><span class="p">,</span> <span class="nx">setState</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="dl">"</span><span class="s2">init</span><span class="dl">"</span><span class="p">);</span> <span class="c1">// 'init', 'prompt', 'thinking', 'confirm', 'applied', 'error'...</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">files</span><span class="p">,</span> <span class="nx">setFiles</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">([]);</span> <span class="c1">// Holds { path, content }</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">diffInfo</span><span class="p">,</span> <span class="nx">setDiffInfo</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">({</span> <span class="na">summary</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span> <span class="na">diffs</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span> <span class="na">ops</span><span class="p">:</span> <span class="p">[]</span> <span class="p">});</span>

  <span class="c1">// 1. Load file context on mount</span>
  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">fileContents</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getFileContents</span><span class="p">(</span><span class="nx">rootPath</span><span class="p">,</span> <span class="cm">/* ignorePatterns */</span><span class="p">);</span>
      <span class="nx">setFiles</span><span class="p">(</span><span class="nx">fileContents</span><span class="p">);</span>
      <span class="nx">setState</span><span class="p">(</span><span class="dl">"</span><span class="s2">prompt</span><span class="dl">"</span><span class="p">);</span> <span class="c1">// Ready for user input</span>
    <span class="p">})();</span>
  <span class="p">},</span> <span class="p">[</span><span class="nx">rootPath</span><span class="p">]);</span>

  <span class="c1">// 2. Function to run the AI task</span>
  <span class="k">async</span> <span class="kd">function</span> <span class="nx">runSinglePassTask</span><span class="p">(</span><span class="nx">userPrompt</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setState</span><span class="p">(</span><span class="dl">"</span><span class="s2">thinking</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// Format the context + prompt for the AI</span>
      <span class="kd">const</span> <span class="nx">taskContextStr</span> <span class="o">=</span> <span class="nx">renderTaskContext</span><span class="p">({</span> <span class="na">prompt</span><span class="p">:</span> <span class="nx">userPrompt</span><span class="p">,</span> <span class="nx">files</span><span class="p">,</span> <span class="cm">/*...*/</span> <span class="p">});</span>

      <span class="kd">const</span> <span class="nx">openai</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenAI</span><span class="p">({</span> <span class="cm">/* ... config ... */</span> <span class="p">});</span>
      <span class="c1">// Call OpenAI, specifying the expected structured response format</span>
      <span class="kd">const</span> <span class="nx">chatResp</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openai</span><span class="p">.</span><span class="nx">beta</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">completions</span><span class="p">.</span><span class="nx">parse</span><span class="p">({</span>
        <span class="na">model</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
        <span class="na">messages</span><span class="p">:</span> <span class="p">[{</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">,</span> <span class="na">content</span><span class="p">:</span> <span class="nx">taskContextStr</span> <span class="p">}],</span>
        <span class="na">response_format</span><span class="p">:</span> <span class="nx">zodResponseFormat</span><span class="p">(</span><span class="nx">EditedFilesSchema</span><span class="p">,</span> <span class="dl">"</span><span class="s2">schema</span><span class="dl">"</span><span class="p">),</span> <span class="c1">// Ask for this specific structure!</span>
      <span class="p">});</span>

      <span class="kd">const</span> <span class="nx">edited</span> <span class="o">=</span> <span class="nx">chatResp</span><span class="p">.</span><span class="nx">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]?.</span><span class="nx">message</span><span class="p">?.</span><span class="nx">parsed</span><span class="p">;</span> <span class="c1">// The parsed { ops: [...] } object</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">edited</span> <span class="o">||</span> <span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">edited</span><span class="p">.</span><span class="nx">ops</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Handle no ops */</span> <span class="p">}</span>

      <span class="c1">// Generate diffs from the AI's proposed operations</span>
      <span class="kd">const</span> <span class="p">[</span><span class="nx">combinedDiffs</span><span class="p">,</span> <span class="nx">opsToApply</span><span class="p">]</span> <span class="o">=</span> <span class="nx">generateDiffSummary</span><span class="p">(</span><span class="nx">edited</span><span class="p">,</span> <span class="cm">/* original files map */</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">opsToApply</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Handle no actual changes */</span> <span class="p">}</span>

      <span class="kd">const</span> <span class="nx">summary</span> <span class="o">=</span> <span class="nx">generateEditSummary</span><span class="p">(</span><span class="nx">opsToApply</span><span class="p">,</span> <span class="cm">/* original files map */</span><span class="p">);</span>
      <span class="nx">setDiffInfo</span><span class="p">({</span> <span class="nx">summary</span><span class="p">,</span> <span class="na">diffs</span><span class="p">:</span> <span class="nx">combinedDiffs</span><span class="p">,</span> <span class="na">ops</span><span class="p">:</span> <span class="nx">opsToApply</span> <span class="p">});</span>
      <span class="nx">setState</span><span class="p">(</span><span class="dl">"</span><span class="s2">confirm</span><span class="dl">"</span><span class="p">);</span> <span class="c1">// Move to confirmation state</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">setState</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 3. Function to apply the changes</span>
  <span class="k">async</span> <span class="kd">function</span> <span class="nx">applyFileOps</span><span class="p">(</span><span class="nx">ops</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">FileOperation</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">op</span> <span class="k">of</span> <span class="nx">ops</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="k">delete</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">fsPromises</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">path</span><span class="p">).</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Create or Update</span>
        <span class="kd">const</span> <span class="nx">newContent</span> <span class="o">=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">updated_full_content</span> <span class="o">||</span> <span class="dl">""</span><span class="p">;</span>
        <span class="k">await</span> <span class="nx">fsPromises</span><span class="p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">path</span><span class="p">),</span> <span class="p">{</span> <span class="na">recursive</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
        <span class="k">await</span> <span class="nx">fsPromises</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">newContent</span><span class="p">,</span> <span class="dl">"</span><span class="s2">utf-8</span><span class="dl">"</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// Handle move_to separately if needed</span>
    <span class="p">}</span>
    <span class="nx">setState</span><span class="p">(</span><span class="dl">"</span><span class="s2">applied</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// --- Render logic based on `state` ---</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">prompt</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">InputPrompt</span> <span class="nx">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">runSinglePassTask</span><span class="p">}</span> <span class="cm">/* ... */</span> <span class="sr">/&gt;</span><span class="err">;
</span>  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">thinking</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Show Spinner */</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">confirm</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">Box</span> <span class="nx">flexDirection</span><span class="o">=</span><span class="dl">"</span><span class="s2">column</span><span class="dl">"</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="cm">/* Display diffInfo.summary and diffInfo.diffs */</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="nx">ConfirmationPrompt</span>
          <span class="nx">message</span><span class="o">=</span><span class="dl">"</span><span class="s2">Apply these changes?</span><span class="dl">"</span>
          <span class="nx">onResult</span><span class="o">=</span><span class="p">{(</span><span class="nx">accept</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">accept</span><span class="p">)</span> <span class="nx">applyFileOps</span><span class="p">(</span><span class="nx">diffInfo</span><span class="p">.</span><span class="nx">ops</span><span class="p">);</span>
            <span class="k">else</span> <span class="nx">setState</span><span class="p">(</span><span class="dl">"</span><span class="s2">skipped</span><span class="dl">"</span><span class="p">);</span>
          <span class="p">}}</span>
        <span class="sr">/</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/Box</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">applied</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Show success, maybe offer another prompt */</span> <span class="p">}</span>
  <span class="c1">// ... other states: init, error, skipped ...</span>

  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">Text</span><span class="o">&gt;</span><span class="p">...</span><span class="o">&lt;</span><span class="sr">/Text&gt;; /</span><span class="o">/</span> <span class="nx">Fallback</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><strong>Explanation:</strong> This component uses <code class="language-plaintext highlighter-rouge">useEffect</code> to load files initially. The <code class="language-plaintext highlighter-rouge">runSinglePassTask</code> function orchestrates calling the AI (using <code class="language-plaintext highlighter-rouge">zodResponseFormat</code> to enforce the <code class="language-plaintext highlighter-rouge">EditedFilesSchema</code>) and generating diffs. <code class="language-plaintext highlighter-rouge">applyFileOps</code> performs the actual file system changes if the user confirms via the <code class="language-plaintext highlighter-rouge">ConfirmationPrompt</code>. The UI rendered depends heavily on the current <code class="language-plaintext highlighter-rouge">state</code>.</li>
</ul>

<h3 id="defining-the-ais-output-file_opsts">Defining the AI’s Output: <code class="language-plaintext highlighter-rouge">file_ops.ts</code></h3>

<p>This file defines the exact structure Codex expects the AI to return in single-pass mode.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: codex-cli/src/utils/singlepass/file_ops.ts (Simplified)</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">z</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">zod</span><span class="dl">"</span><span class="p">;</span> <span class="c1">// Zod is a schema validation library</span>

<span class="c1">// Schema for a single file operation</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">FileOperationSchema</span> <span class="o">=</span> <span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
  <span class="na">path</span><span class="p">:</span> <span class="nx">z</span><span class="p">.</span><span class="kr">string</span><span class="p">().</span><span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">Absolute path to the file.</span><span class="dl">"</span><span class="p">),</span>
  <span class="na">updated_full_content</span><span class="p">:</span> <span class="nx">z</span><span class="p">.</span><span class="kr">string</span><span class="p">().</span><span class="nx">optional</span><span class="p">().</span><span class="nx">describe</span><span class="p">(</span>
    <span class="dl">"</span><span class="s2">FULL CONTENT of the file after modification. MUST provide COMPLETE content.</span><span class="dl">"</span>
  <span class="p">),</span>
  <span class="na">delete</span><span class="p">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">boolean</span><span class="p">().</span><span class="nx">optional</span><span class="p">().</span><span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">Set true to delete the file.</span><span class="dl">"</span><span class="p">),</span>
  <span class="na">move_to</span><span class="p">:</span> <span class="nx">z</span><span class="p">.</span><span class="kr">string</span><span class="p">().</span><span class="nx">optional</span><span class="p">().</span><span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">New absolute path if file is moved.</span><span class="dl">"</span><span class="p">),</span>
  <span class="c1">// Ensure only one action per operation (update, delete, or move)</span>
<span class="p">}).</span><span class="nx">refine</span><span class="p">(</span><span class="cm">/* ... validation logic ... */</span><span class="p">);</span>

<span class="c1">// Schema for the overall response containing a list of operations</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">EditedFilesSchema</span> <span class="o">=</span> <span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
  <span class="na">ops</span><span class="p">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">array</span><span class="p">(</span><span class="nx">FileOperationSchema</span><span class="p">).</span><span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">List of file operations.</span><span class="dl">"</span><span class="p">),</span>
<span class="p">});</span>

<span class="k">export</span> <span class="kd">type</span> <span class="nx">FileOperation</span> <span class="o">=</span> <span class="nx">z</span><span class="p">.</span><span class="nx">infer</span><span class="o">&lt;</span><span class="k">typeof</span> <span class="nx">FileOperationSchema</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">EditedFiles</span> <span class="o">=</span> <span class="nx">z</span><span class="p">.</span><span class="nx">infer</span><span class="o">&lt;</span><span class="k">typeof</span> <span class="nx">EditedFilesSchema</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li><strong>Explanation:</strong> This uses the Zod library to define a strict schema. <code class="language-plaintext highlighter-rouge">FileOperationSchema</code> describes a single change (update, delete, or move), emphasizing that <code class="language-plaintext highlighter-rouge">updated_full_content</code> must be the <em>entire</em> file content. <code class="language-plaintext highlighter-rouge">EditedFilesSchema</code> wraps this in a list called <code class="language-plaintext highlighter-rouge">ops</code>. This schema is given to the OpenAI API (via <code class="language-plaintext highlighter-rouge">zodResponseFormat</code>) to ensure the AI’s response is structured correctly.</li>
</ul>

<h3 id="generating-context-and-diffs">Generating Context and Diffs</h3>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">context.ts</code> (<code class="language-plaintext highlighter-rouge">renderTaskContext</code>):</strong> Takes the user prompt and file contents and formats them into the large string sent to the AI, including instructions and often wrapping file content in XML-like tags (<code class="language-plaintext highlighter-rouge">&lt;file&gt;&lt;path&gt;...&lt;/path&gt;&lt;content&gt;...&lt;/content&gt;&lt;/file&gt;</code>).</li>
  <li><strong><code class="language-plaintext highlighter-rouge">code_diff.ts</code> (<code class="language-plaintext highlighter-rouge">generateDiffSummary</code>, <code class="language-plaintext highlighter-rouge">generateEditSummary</code>):</strong> Takes the <code class="language-plaintext highlighter-rouge">ops</code> returned by the AI and compares the <code class="language-plaintext highlighter-rouge">updated_full_content</code> with the original content read from disk. It uses a library (like <code class="language-plaintext highlighter-rouge">diff</code>) to generate standard diff text and then formats it (often with colors) and creates a short summary list for display.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>Single-Pass Mode offers a different, potentially faster way to use Codex for well-defined tasks. By providing extensive context upfront and asking the AI for a complete set of structured file operations in one response, it minimizes back-and-forth. You gather context, send one big request, review the complete proposed solution, and either accept or reject it entirely. While still experimental, it’s a powerful approach for streamlining larger refactoring or generation tasks where the requirements are clear.</p>

<p>This concludes our tour through the core concepts of Codex! We’ve journeyed from the <a href="01_terminal_ui__ink_components_.md">Terminal UI</a> and <a href="02_input_handling__textbuffer_editor_.md">Input Handling</a>, through the central <a href="03_agent_loop.md">Agent Loop</a>, into the crucial aspects of <a href="04_approval_policy___security.md">Approval Policy &amp; Security</a>, <a href="05_response___tool_call_handling.md">Response &amp; Tool Call Handling</a>, and safe <a href="06_command_execution___sandboxing.md">Command Execution &amp; Sandboxing</a>, learned about <a href="07_configuration_management.md">Configuration Management</a>, and finally explored the alternative <a href="08_single_pass_mode.md">Single-Pass Mode</a>.</p>

<p>We hope this gives you a solid understanding of how Codex works under the hood. Feel free to dive deeper into the codebase, experiment, and perhaps even contribute!</p>

<hr />

<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>
