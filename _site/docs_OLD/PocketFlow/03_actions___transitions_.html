<h1 id="chapter-3-actions--transitions">Chapter 3: Actions / Transitions</h1>

<p>In <a href="02_node___basenode____node____asyncnode___.md">Chapter 2: Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a>, we learned that Nodes are the individual workers in our PocketFlow application, each performing a specific task. We also touched upon the <code class="language-plaintext highlighter-rouge">post</code> method of a Node, mentioning that it can return an ‚Äúaction‚Äù string. Now, it‚Äôs time to explore exactly what these ‚Äúactions‚Äù are and how they create ‚Äútransitions,‚Äù guiding the workflow dynamically.</p>

<p>Imagine you‚Äôre building an AI research assistant. After the AI receives your question, it needs to decide: should it search the web for more information, or does it already have enough context to answer? This decision point, and acting upon it, is where Actions and Transitions shine.</p>

<h2 id="what-are-actions-and-transitions">What are Actions and Transitions?</h2>

<p><strong>Actions</strong> and <strong>Transitions</strong> are the mechanism by which a PocketFlow <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> determines the next <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> to execute.</p>

<ul>
  <li>An <strong>Action</strong> is usually a simple string (e.g., <code class="language-plaintext highlighter-rouge">"search"</code>, <code class="language-plaintext highlighter-rouge">"answer"</code>, <code class="language-plaintext highlighter-rouge">"proceed"</code>) returned by a <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a>‚Äôs <code class="language-plaintext highlighter-rouge">post</code> method after it completes its work. This string signals the outcome or a desired next step.</li>
  <li>A <strong>Transition</strong> is the rule defined within the <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> that says, ‚ÄúIf <em>this</em> Node returns <em>this</em> action, then go to <em>that</em> Node next.‚Äù</li>
</ul>

<p>Think of it like a ‚ÄúChoose Your Own Adventure‚Äù book. At the end of a section (a <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> finishing its task), you might be told, ‚ÄúIf you want to open the door, turn to page 42. If you want to look under the bed, turn to page 55.‚Äù The ‚Äúopen the door‚Äù part is the ‚Äúaction,‚Äù and ‚Äúturn to page 42‚Äù is the ‚Äútransition.‚Äù</p>

<p>This allows your workflow to be dynamic and intelligent, not just a fixed sequence of steps.</p>

<h2 id="how-to-use-actions-and-transitions">How to Use Actions and Transitions</h2>

<p>Let‚Äôs break down how you implement this, using our AI research assistant idea from <code class="language-plaintext highlighter-rouge">cookbook/pocketflow-a2a/</code>.</p>

<p><strong>1. A Node Returns an Action String</strong></p>

<p>The <code class="language-plaintext highlighter-rouge">post</code> method of a <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> is where the decision for the next action is typically made and returned.</p>

<p>Consider the <code class="language-plaintext highlighter-rouge">DecideAction</code> <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> from <code class="language-plaintext highlighter-rouge">cookbook/pocketflow-a2a/nodes.py</code>. Its job is to decide whether to search the web or try to answer the question directly.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Inside DecideAction Node class (cookbook/pocketflow-a2a/nodes.py)
# ... (prep and exec methods are here) ...
</span>
<span class="k">class</span> <span class="nc">DecideAction</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="c1"># ...
</span>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res</span><span class="p">):</span>
        <span class="s">"""Save the decision and determine the next step in the flow."""</span>
        <span class="c1"># 'exec_res' is a dictionary like {"action": "search", "search_query": "..."}
</span>        <span class="c1"># or {"action": "answer", "answer": "..."}
</span>        <span class="k">if</span> <span class="n">exec_res</span><span class="p">[</span><span class="s">"action"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"search"</span><span class="p">:</span>
            <span class="n">shared</span><span class="p">[</span><span class="s">"search_query"</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_res</span><span class="p">[</span><span class="s">"search_query"</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"üîç Agent decided to search for: </span><span class="si">{</span><span class="n">exec_res</span><span class="p">[</span><span class="s">'search_query'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ... store answer if action is "answer" ...
</span>            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"üí° Agent decided to answer the question"</span><span class="p">)</span>
        
        <span class="c1"># Return the action string to guide the Flow
</span>        <span class="k">return</span> <span class="n">exec_res</span><span class="p">[</span><span class="s">"action"</span><span class="p">]</span> <span class="c1"># This could be "search" or "answer"
</span></code></pre></div></div>
<p>In this <code class="language-plaintext highlighter-rouge">post</code> method:</p>
<ul>
  <li>It first updates the <a href="01_shared_state___shared__dictionary__.md">shared dictionary</a> based on the decision made in <code class="language-plaintext highlighter-rouge">exec_res</code>.</li>
  <li>Crucially, it returns <code class="language-plaintext highlighter-rouge">exec_res["action"]</code>. If the LLM in the <code class="language-plaintext highlighter-rouge">exec</code> method decided to search, this will be the string <code class="language-plaintext highlighter-rouge">"search"</code>. If it decided to answer, it will be <code class="language-plaintext highlighter-rouge">"answer"</code>. This returned string is the <strong>action</strong>.</li>
</ul>

<p><strong>2. Defining Transitions in a Flow</strong></p>

<p>Now that our <code class="language-plaintext highlighter-rouge">DecideAction</code> <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> can return an action like <code class="language-plaintext highlighter-rouge">"search"</code> or <code class="language-plaintext highlighter-rouge">"answer"</code>, we need to tell the <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> what to do for each of these actions. This is done when you set up your <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a>.</p>

<p>PocketFlow uses a very intuitive syntax: <code class="language-plaintext highlighter-rouge">current_node - "action_string" &gt;&gt; next_node</code>.</p>

<p>Let‚Äôs look at <code class="language-plaintext highlighter-rouge">cookbook/pocketflow-a2a/flow.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># From cookbook/pocketflow-a2a/flow.py
</span><span class="kn">from</span> <span class="nn">pocketflow</span> <span class="kn">import</span> <span class="n">Flow</span>
<span class="kn">from</span> <span class="nn">nodes</span> <span class="kn">import</span> <span class="n">DecideAction</span><span class="p">,</span> <span class="n">SearchWeb</span><span class="p">,</span> <span class="n">AnswerQuestion</span>

<span class="c1"># Create instances of each node
</span><span class="n">decide</span> <span class="o">=</span> <span class="n">DecideAction</span><span class="p">()</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">SearchWeb</span><span class="p">()</span>
<span class="n">answer</span> <span class="o">=</span> <span class="n">AnswerQuestion</span><span class="p">()</span>

<span class="c1"># Connect the nodes using actions
# If DecideAction returns "search", go to SearchWeb node
</span><span class="n">decide</span> <span class="o">-</span> <span class="s">"search"</span> <span class="o">&gt;&gt;</span> <span class="n">search</span>

<span class="c1"># If DecideAction returns "answer", go to AnswerQuestion node
</span><span class="n">decide</span> <span class="o">-</span> <span class="s">"answer"</span> <span class="o">&gt;&gt;</span> <span class="n">answer</span>

<span class="c1"># After SearchWeb completes and returns "decide", go back to DecideAction
</span><span class="n">search</span> <span class="o">-</span> <span class="s">"decide"</span> <span class="o">&gt;&gt;</span> <span class="n">decide</span>

<span class="c1"># Create the flow, starting with the DecideAction node
</span><span class="n">agent_flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">decide</span><span class="p">)</span>
</code></pre></div></div>
<p>Here‚Äôs what‚Äôs happening:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">decide - "search" &gt;&gt; search</code>: This line says, ‚ÄúIf the <code class="language-plaintext highlighter-rouge">decide</code> Node returns the action string <code class="language-plaintext highlighter-rouge">"search"</code>, then the <em>next</em> Node to execute should be the <code class="language-plaintext highlighter-rouge">search</code> Node.‚Äù</li>
  <li><code class="language-plaintext highlighter-rouge">decide - "answer" &gt;&gt; answer</code>: Similarly, ‚ÄúIf <code class="language-plaintext highlighter-rouge">decide</code> returns <code class="language-plaintext highlighter-rouge">"answer"</code>, then go to the <code class="language-plaintext highlighter-rouge">answer</code> Node.‚Äù</li>
  <li><code class="language-plaintext highlighter-rouge">search - "decide" &gt;&gt; decide</code>: This creates a loop! After the <code class="language-plaintext highlighter-rouge">search</code> Node (which performs a web search) completes, its <code class="language-plaintext highlighter-rouge">post</code> method returns <code class="language-plaintext highlighter-rouge">"decide"</code>. This transition sends the control <em>back</em> to the <code class="language-plaintext highlighter-rouge">decide</code> Node, perhaps with new search results in the <a href="01_shared_state___shared__dictionary__.md">shared dictionary</a>, to re-evaluate.</li>
</ul>

<p>When <code class="language-plaintext highlighter-rouge">agent_flow.run(shared_data)</code> is called:</p>
<ol>
  <li>The <code class="language-plaintext highlighter-rouge">decide</code> Node runs. Let‚Äôs say its <code class="language-plaintext highlighter-rouge">post</code> method returns <code class="language-plaintext highlighter-rouge">"search"</code>.</li>
  <li>The <code class="language-plaintext highlighter-rouge">Flow</code> sees this action. It looks at the transitions defined for <code class="language-plaintext highlighter-rouge">decide</code>. It finds <code class="language-plaintext highlighter-rouge">decide - "search" &gt;&gt; search</code>.</li>
  <li>So, the <code class="language-plaintext highlighter-rouge">search</code> Node runs next.</li>
  <li>Let‚Äôs say the <code class="language-plaintext highlighter-rouge">search</code> Node‚Äôs <code class="language-plaintext highlighter-rouge">post</code> method returns <code class="language-plaintext highlighter-rouge">"decide"</code>.</li>
  <li>The <code class="language-plaintext highlighter-rouge">Flow</code> sees this. It finds <code class="language-plaintext highlighter-rouge">search - "decide" &gt;&gt; decide</code>.</li>
  <li>The <code class="language-plaintext highlighter-rouge">decide</code> Node runs again. This time, with the search results in <code class="language-plaintext highlighter-rouge">shared</code>, it might return <code class="language-plaintext highlighter-rouge">"answer"</code>.</li>
  <li>The <code class="language-plaintext highlighter-rouge">Flow</code> finds <code class="language-plaintext highlighter-rouge">decide - "answer" &gt;&gt; answer</code>.</li>
  <li>The <code class="language-plaintext highlighter-rouge">answer</code> Node runs, generates the final answer, and its <code class="language-plaintext highlighter-rouge">post</code> method might return <code class="language-plaintext highlighter-rouge">"done"</code> (or <code class="language-plaintext highlighter-rouge">None</code>). If <code class="language-plaintext highlighter-rouge">"done"</code> isn‚Äôt a defined transition for the <code class="language-plaintext highlighter-rouge">answer</code> Node, the flow might end.</li>
</ol>

<p><strong>3. Default Transitions</strong></p>

<p>What if a Node‚Äôs <code class="language-plaintext highlighter-rouge">post</code> method returns <code class="language-plaintext highlighter-rouge">None</code> (i.e., nothing), or it returns an action string for which you haven‚Äôt defined a specific transition (e.g., <code class="language-plaintext highlighter-rouge">decide</code> returns <code class="language-plaintext highlighter-rouge">"unknown_action"</code>)?</p>

<p>Often, you‚Äôll define a <strong>default transition</strong>. This is like the ‚Äúelse‚Äù in an if-else statement. If no specific action matches, the default transition is taken.</p>

<p>The syntax for a default transition is simpler: <code class="language-plaintext highlighter-rouge">current_node &gt;&gt; next_node_for_default_action</code>.</p>

<p>Let‚Äôs look at <code class="language-plaintext highlighter-rouge">cookbook/pocketflow-supervisor/flow.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># From cookbook/pocketflow-supervisor/flow.py
# ... (agent_flow is an inner Flow, supervisor is a SupervisorNode) ...
</span>
<span class="c1"># Connect the components
# After agent_flow completes, go to supervisor (this is a default transition)
</span><span class="n">agent_flow</span> <span class="o">&gt;&gt;</span> <span class="n">supervisor</span>

<span class="c1"># If supervisor rejects the answer (returns "retry"), go back to agent_flow
</span><span class="n">supervisor</span> <span class="o">-</span> <span class="s">"retry"</span> <span class="o">&gt;&gt;</span> <span class="n">agent_flow</span>

<span class="c1"># Create and return the outer flow
</span><span class="n">supervised_flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">agent_flow</span><span class="p">)</span>
</code></pre></div></div>
<p>Here:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">agent_flow &gt;&gt; supervisor</code>: If the <code class="language-plaintext highlighter-rouge">agent_flow</code> (which is treated as a single unit here) completes and its <code class="language-plaintext highlighter-rouge">post</code> method returns an action that is <em>not</em> specifically handled by <code class="language-plaintext highlighter-rouge">agent_flow</code> itself for transitions <em>within</em> it, or if it returns <code class="language-plaintext highlighter-rouge">None</code>, it will transition to the <code class="language-plaintext highlighter-rouge">supervisor</code> Node. This is a default transition.</li>
  <li><code class="language-plaintext highlighter-rouge">supervisor - "retry" &gt;&gt; agent_flow</code>: This is a specific action-based transition. If the <code class="language-plaintext highlighter-rouge">supervisor</code> Node‚Äôs <code class="language-plaintext highlighter-rouge">post</code> method returns <code class="language-plaintext highlighter-rouge">"retry"</code>, the flow goes back to <code class="language-plaintext highlighter-rouge">agent_flow</code>.</li>
</ul>

<p>If a Node‚Äôs <code class="language-plaintext highlighter-rouge">post</code> returns <code class="language-plaintext highlighter-rouge">None</code>, and there‚Äôs a default transition defined (e.g., <code class="language-plaintext highlighter-rouge">node1 &gt;&gt; node2</code>), then <code class="language-plaintext highlighter-rouge">node2</code> will be executed. If there‚Äôs no specific transition for the returned action <em>and</em> no default transition, the <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> typically ends for that branch.</p>

<h2 id="what-happens-under-the-hood-a-simplified-view">What Happens Under the Hood? (A Simplified View)</h2>

<ol>
  <li><strong>Node Execution:</strong> Your <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> runs a <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a>.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">post</code> Method Returns Action:</strong> The <code class="language-plaintext highlighter-rouge">post</code> method of that <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> completes and returns an action string (e.g., <code class="language-plaintext highlighter-rouge">"search"</code>).</li>
  <li><strong>Flow Receives Action:</strong> The <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> (specifically, its orchestrator logic) gets this action string.</li>
  <li><strong>Lookup Successor:</strong> The <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> looks at the current <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> and checks its defined successors. Each <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> object internally stores a dictionary called <code class="language-plaintext highlighter-rouge">successors</code>. This dictionary maps action strings to the next <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> object.
    <ul>
      <li>The syntax <code class="language-plaintext highlighter-rouge">node1 - "actionX" &gt;&gt; node2</code> effectively does <code class="language-plaintext highlighter-rouge">node1.successors["actionX"] = node2</code>.</li>
      <li>The syntax <code class="language-plaintext highlighter-rouge">node1 &gt;&gt; node2</code> effectively does <code class="language-plaintext highlighter-rouge">node1.successors["default"] = node2</code>.</li>
    </ul>
  </li>
  <li><strong>Find Next Node:</strong> The <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> tries to find an entry in <code class="language-plaintext highlighter-rouge">current_node.successors</code> for the returned action string. If not found, it tries to find an entry for <code class="language-plaintext highlighter-rouge">"default"</code>.</li>
  <li><strong>Transition or End:</strong>
    <ul>
      <li>If a next <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> is found, the <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> prepares to execute it.</li>
      <li>If no matching transition (neither specific nor default) is found, that path of the <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> typically concludes.</li>
    </ul>
  </li>
</ol>

<p>Here‚Äôs a sequence diagram illustrating this:</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant FlowEngine
    participant CurrentNode as Current Node
    participant NextNodeSearch as Next Node (for "search")
    participant NextNodeAnswer as Next Node (for "answer")

    FlowEngine-&gt;&gt;CurrentNode: _run(shared_data)
    Note over CurrentNode: prep(), exec() run...
    CurrentNode-&gt;&gt;CurrentNode: post() method executes
    CurrentNode--&gt;&gt;FlowEngine: Returns action_string (e.g., "search")
    FlowEngine-&gt;&gt;FlowEngine: get_next_node(CurrentNode, "search")
    Note over FlowEngine: Looks up "search" in CurrentNode.successors
    FlowEngine-&gt;&gt;NextNodeSearch: _run(shared_data)
</code></pre>

<p><strong>Diving into the Code (from <code class="language-plaintext highlighter-rouge">pocketflow/__init__.py</code>):</strong></p>

<ol>
  <li><strong>Storing Transitions:</strong>
The <code class="language-plaintext highlighter-rouge">BaseNode</code> class (which all <a href="02_node___basenode____node____asyncnode___.md">Nodes (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> and <a href="04_flow___flow____asyncflow___.md">Flows (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> inherit from) has a <code class="language-plaintext highlighter-rouge">next</code> method to define successors:
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Inside BaseNode class (pocketflow/__init__.py)
</span><span class="k">class</span> <span class="nc">BaseNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="bp">self</span><span class="p">.</span><span class="n">successors</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Stores action -&gt; next_node mapping
</span>        <span class="c1"># ... other initializations ...
</span>        
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"default"</span><span class="p">):</span>
        <span class="c1"># ... (warning if overwriting) ...
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">successors</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">return</span> <span class="n">node</span> <span class="c1"># Allows chaining
</span></code></pre></div>    </div>
    <p>The cool <code class="language-plaintext highlighter-rouge">node - "action" &gt;&gt; next_node</code> syntax is made possible by Python‚Äôs special methods (<code class="language-plaintext highlighter-rouge">__sub__</code> for <code class="language-plaintext highlighter-rouge">-</code> and <code class="language-plaintext highlighter-rouge">__rshift__</code> for <code class="language-plaintext highlighter-rouge">&gt;&gt;</code>):</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Inside BaseNode class (pocketflow/__init__.py)
</span><span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_str</span><span class="p">):</span> <span class="c1"># When you do 'node - "action_str"'
</span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_ConditionalTransition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_str</span><span class="p">)</span>
    <span class="c1"># ... error handling ...
</span>
<span class="k">class</span> <span class="nc">_ConditionalTransition</span><span class="p">:</span> <span class="c1"># A temporary helper object
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_node</span><span class="p">,</span> <span class="n">action_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">src_node</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">action_name</span> <span class="o">=</span> <span class="n">src_node</span><span class="p">,</span> <span class="n">action_name</span>
        
    <span class="k">def</span> <span class="nf">__rshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_node</span><span class="p">):</span> <span class="c1"># When you do '... &gt;&gt; target_node'
</span>        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">src_node</span><span class="p">.</span><span class="nb">next</span><span class="p">(</span><span class="n">target_node</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">action_name</span><span class="p">)</span>
</code></pre></div>    </div>
    <p>And for the default transition <code class="language-plaintext highlighter-rouge">node1 &gt;&gt; node2</code>:</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Inside BaseNode class (pocketflow/__init__.py)
</span><span class="k">def</span> <span class="nf">__rshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_node</span><span class="p">):</span> <span class="c1"># When you do 'node1 &gt;&gt; other_node'
</span>    <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="nb">next</span><span class="p">(</span><span class="n">other_node</span><span class="p">)</span> <span class="c1"># Calls .next() with action="default"
</span></code></pre></div>    </div>
    <p>So, these operators are just convenient ways to populate the <code class="language-plaintext highlighter-rouge">successors</code> dictionary of a <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a>.</p>
  </li>
  <li><strong>Flow Orchestration and Using Actions:</strong>
The <code class="language-plaintext highlighter-rouge">Flow</code> class has an <code class="language-plaintext highlighter-rouge">_orch</code> (orchestration) method that manages running <a href="02_node___basenode____node____asyncnode___.md">Nodes (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> in sequence.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Inside Flow class (pocketflow/__init__.py)
</span><span class="k">class</span> <span class="nc">Flow</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="c1"># ...
</span>    <span class="k">def</span> <span class="nf">get_next_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_node</span><span class="p">,</span> <span class="n">action_str</span><span class="p">):</span>
        <span class="c1"># Tries the specific action, then "default"
</span>        <span class="n">next_node</span> <span class="o">=</span> <span class="n">current_node</span><span class="p">.</span><span class="n">successors</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">action_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">next_node</span><span class="p">:</span> <span class="c1"># If specific action not found
</span>             <span class="n">next_node</span> <span class="o">=</span> <span class="n">current_node</span><span class="p">.</span><span class="n">successors</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"default"</span><span class="p">)</span>

        <span class="c1"># ... (warning if action not found and successors exist) ...
</span>        <span class="k">return</span> <span class="n">next_node</span>

    <span class="k">def</span> <span class="nf">_orch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">current_node</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">start_node</span> 
        <span class="n">last_action</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="n">current_node</span><span class="p">:</span>
            <span class="c1"># ... (set params for current_node) ...
</span>            <span class="n">last_action</span> <span class="o">=</span> <span class="n">current_node</span><span class="p">.</span><span class="n">_run</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span> <span class="c1"># Node returns an action
</span>            <span class="n">current_node</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_next_node</span><span class="p">(</span><span class="n">current_node</span><span class="p">,</span> <span class="n">last_action</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">last_action</span> <span class="c1"># Returns the last action from the entire flow
</span></code></pre></div>    </div>
    <p>The <code class="language-plaintext highlighter-rouge">_orch</code> method:</p>
    <ul>
      <li>Starts with the <code class="language-plaintext highlighter-rouge">self.start_node</code>.</li>
      <li>In a loop, it runs the <code class="language-plaintext highlighter-rouge">current_node</code> (whose <code class="language-plaintext highlighter-rouge">_run</code> method calls <code class="language-plaintext highlighter-rouge">prep</code>, <code class="language-plaintext highlighter-rouge">exec</code>, and <code class="language-plaintext highlighter-rouge">post</code>). The <code class="language-plaintext highlighter-rouge">post</code> method‚Äôs return value becomes <code class="language-plaintext highlighter-rouge">last_action</code>.</li>
      <li>It then calls <code class="language-plaintext highlighter-rouge">self.get_next_node(current_node, last_action)</code> to determine the next <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a>.</li>
      <li>If <code class="language-plaintext highlighter-rouge">get_next_node</code> returns a <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a>, the loop continues. If it returns <code class="language-plaintext highlighter-rouge">None</code> (no transition found), the loop (and thus the flow for that path) ends.</li>
    </ul>
  </li>
</ol>

<h2 id="analogy-a-mail-sorter">Analogy: A Mail Sorter</h2>

<p>Think of a <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> as a mail processing station.</p>
<ul>
  <li>It receives a package (data via <code class="language-plaintext highlighter-rouge">prep</code> from the <a href="01_shared_state___shared__dictionary__.md">shared dictionary</a>).</li>
  <li>It processes the package (its <code class="language-plaintext highlighter-rouge">exec</code> method).</li>
  <li>Then, its <code class="language-plaintext highlighter-rouge">post</code> method looks at the package and decides which destination bin it should go to next. It writes a ‚Äúdestination code‚Äù (the action string like <code class="language-plaintext highlighter-rouge">"LOCAL_DELIVERY"</code> or <code class="language-plaintext highlighter-rouge">"INTERNATIONAL_FORWARD"</code>) on the package.</li>
  <li>The <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> is like the conveyor belt system. It reads the ‚Äúdestination code‚Äù and uses its routing rules (the <code class="language-plaintext highlighter-rouge">node - "code" &gt;&gt; next_station</code> definitions) to send the package to the correct next station. If there‚Äôs no specific code, it might send it to a ‚Äúdefault processing‚Äù station.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>Actions and Transitions are the control flow mechanism in PocketFlow. They allow you to build dynamic and responsive workflows where the path of execution can change based on the outcomes of individual <a href="02_node___basenode____node____asyncnode___.md">Nodes (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a>.</p>
<ul>
  <li>A <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a>‚Äôs <code class="language-plaintext highlighter-rouge">post</code> method returns an <strong>action string</strong>.</li>
  <li>The <a href="04_flow___flow____asyncflow___.md">Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a> uses this action string to find a <strong>transition rule</strong> (e.g., <code class="language-plaintext highlighter-rouge">current_node - "action" &gt;&gt; next_node</code> or a default <code class="language-plaintext highlighter-rouge">current_node &gt;&gt; next_node</code>).</li>
  <li>This determines the next <a href="02_node___basenode____node____asyncnode___.md">Node (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> to execute.</li>
</ul>

<p>By mastering actions and transitions, you can design sophisticated logic for your AI agents, enabling them to make decisions and navigate complex tasks.</p>

<p>Now that we understand how individual <a href="02_node___basenode____node____asyncnode___.md">Nodes (<code class="language-plaintext highlighter-rouge">BaseNode</code>, <code class="language-plaintext highlighter-rouge">Node</code>, <code class="language-plaintext highlighter-rouge">AsyncNode</code>)</a> are defined, how they share data using the <a href="01_shared_state___shared__dictionary__.md">shared dictionary</a>, and how they connect using Actions and Transitions, we‚Äôre ready to look at the bigger picture: the container that orchestrates all of this.</p>

<p>Next up: <a href="04_flow___flow____asyncflow___.md">Chapter 4: Flow (<code class="language-plaintext highlighter-rouge">Flow</code>, <code class="language-plaintext highlighter-rouge">AsyncFlow</code>)</a></p>

<hr />

<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>
