<h1 id="chapter-6-pythonexecutor---running-code-safely">Chapter 6: PythonExecutor - Running Code Safely</h1>

<p>Welcome back! In <a href="05_prompttemplates.md">Chapter 5: PromptTemplates</a>, we saw how agents use templates to create clear instructions for their LLM brain. These instructions often involve asking the LLM to generate code, especially for agents like <code class="language-plaintext highlighter-rouge">CodeAgent</code>, which are designed to solve problems by writing and running Python.</p>

<p>But wait‚Ä¶ running code generated by an AI? Isn‚Äôt that risky? What if the AI generates code that tries to delete your files, access sensitive information, or just crashes?</p>

<p>This is a very valid concern! You wouldn‚Äôt want an AI assistant to accidentally (or intentionally!) cause harm to your computer. We need a secure way to run this generated code.</p>

<p>This is exactly the problem the <strong><code class="language-plaintext highlighter-rouge">PythonExecutor</code></strong> solves!</p>

<h2 id="the-problem-running-untrusted-code">The Problem: Running Untrusted Code</h2>

<p>Imagine you have a brilliant but slightly unpredictable scientist (the <code class="language-plaintext highlighter-rouge">CodeAgent</code>) who comes up with new experiments (Python code snippets) to solve problems. You want the results of these experiments, but you can‚Äôt let the scientist run them directly in your main lab (your computer) because they might spill dangerous chemicals or break expensive equipment.</p>

<p><img src="https://img.icons8.com/external-flaticons-lineal-color-flat-icons/64/external-scientist-professions-man-flaticons-lineal-color-flat-icons-3.png" alt="Risky Scientist" /> ‚û°Ô∏è üî•üíª (Danger!)</p>

<p>Directly executing AI-generated code is like letting that unpredictable scientist run wild. We need a controlled environment.</p>

<h2 id="the-solution-the-secure-laboratory-pythonexecutor">The Solution: The Secure Laboratory (<code class="language-plaintext highlighter-rouge">PythonExecutor</code>)</h2>

<p>The <code class="language-plaintext highlighter-rouge">PythonExecutor</code> acts like a <strong>secure, isolated laboratory</strong> or a <strong>sandbox</strong> for the code generated by the <code class="language-plaintext highlighter-rouge">CodeAgent</code>.</p>

<p><img src="https://img.icons8.com/external-flaticons-flat-flat-icons/64/external-laboratory-science-flaticons-flat-flat-icons.png" alt="Safe Lab" /> &lt;-&gt; üë®‚Äçüî¨ CodeAgent</p>

<p>Think of it this way:</p>

<ol>
  <li><strong>Isolation:</strong> The <code class="language-plaintext highlighter-rouge">PythonExecutor</code> creates a safe space, separate from your main system, where the code can run. If the code tries to do something harmful, the damage is contained within this sandbox and doesn‚Äôt affect your computer.</li>
  <li><strong>Execution:</strong> It takes the Python code snippet provided by the <code class="language-plaintext highlighter-rouge">CodeAgent</code> and runs it within this safe environment.</li>
  <li><strong>State Management:</strong> Just like a real lab keeps track of ongoing experiments, the <code class="language-plaintext highlighter-rouge">PythonExecutor</code> can remember variables and the state <em>between</em> different code snippets run in sequence. If one snippet calculates <code class="language-plaintext highlighter-rouge">x = 5</code>, the next snippet run by the same executor will know the value of <code class="language-plaintext highlighter-rouge">x</code>.</li>
  <li><strong>Capture Results:</strong> It carefully observes what happens inside the sandbox, capturing any output produced by the code (like results from <code class="language-plaintext highlighter-rouge">print()</code> statements) and the final result of the code snippet.</li>
  <li><strong>Handle Errors:</strong> If the code crashes or produces an error, the <code class="language-plaintext highlighter-rouge">PythonExecutor</code> catches the error message instead of letting it crash the whole agent.</li>
</ol>

<p>Essentially, the <code class="language-plaintext highlighter-rouge">PythonExecutor</code> allows the <code class="language-plaintext highlighter-rouge">CodeAgent</code> to ‚Äúrun experiments‚Äù safely and report back the findings (or failures) without endangering the outside world.</p>

<h2 id="how-does-the-codeagent-use-it-mostly-automatic">How Does the <code class="language-plaintext highlighter-rouge">CodeAgent</code> Use It? (Mostly Automatic!)</h2>

<p>For beginners, the great news is that the <code class="language-plaintext highlighter-rouge">CodeAgent</code> handles the <code class="language-plaintext highlighter-rouge">PythonExecutor</code> automatically! When you create a <code class="language-plaintext highlighter-rouge">CodeAgent</code>, it usually sets up a <code class="language-plaintext highlighter-rouge">PythonExecutor</code> behind the scenes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- File: create_code_agent.py ---
</span><span class="kn">from</span> <span class="nn">smolagents</span> <span class="kn">import</span> <span class="n">CodeAgent</span>
<span class="kn">from</span> <span class="nn">smolagents.models</span> <span class="kn">import</span> <span class="n">LiteLLMModel</span> <span class="c1"># From Chapter 2
# Assume we have some tools defined, maybe a search tool
</span><span class="kn">from</span> <span class="nn">smolagents.tools</span> <span class="kn">import</span> <span class="n">DuckDuckGoSearchTool</span>

<span class="n">search_tool</span> <span class="o">=</span> <span class="n">DuckDuckGoSearchTool</span><span class="p">()</span>

<span class="c1"># Choose a language model
</span><span class="n">llm</span> <span class="o">=</span> <span class="n">LiteLLMModel</span><span class="p">(</span><span class="n">model_id</span><span class="o">=</span><span class="s">"gpt-4-turbo"</span><span class="p">)</span> <span class="c1"># Needs API key setup
</span>
<span class="c1"># Create the CodeAgent
# It automatically creates a PythonExecutor internally!
</span><span class="n">agent</span> <span class="o">=</span> <span class="n">CodeAgent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">search_tool</span><span class="p">],</span>
    <span class="c1"># By default, executor_type="local" is used
</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"CodeAgent created with an internal PythonExecutor."</span><span class="p">)</span>

<span class="c1"># Now, when you run the agent:
# task = "Calculate the square root of 1764 and tell me the result."
# result = agent.run(task)
# print(f"Result: {result}")
# --&gt; The agent will generate code like "import math; result = math.sqrt(1764); final_answer(result)"
# --&gt; It will pass this code to its PythonExecutor to run safely.
# --&gt; The executor runs it, captures the result (42.0), and returns it to the agent.
# --&gt; The agent then uses the final_answer tool.
</span></code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ul>
  <li>When we create <code class="language-plaintext highlighter-rouge">CodeAgent</code>, we don‚Äôt explicitly create a <code class="language-plaintext highlighter-rouge">PythonExecutor</code>. The <code class="language-plaintext highlighter-rouge">CodeAgent</code>‚Äôs initialization logic does this for us.</li>
  <li>By default, it uses a <code class="language-plaintext highlighter-rouge">LocalPythonExecutor</code>, which runs the code in a restricted local environment.</li>
  <li>When <code class="language-plaintext highlighter-rouge">agent.run()</code> is called, and the LLM generates Python code, the <code class="language-plaintext highlighter-rouge">CodeAgent</code> automatically passes that code to its internal <code class="language-plaintext highlighter-rouge">python_executor</code> instance for execution.</li>
</ul>

<h2 id="local-vs-remote-execution">Local vs. Remote Execution</h2>

<p><code class="language-plaintext highlighter-rouge">SmolaAgents</code> offers different types of executors for varying levels of security and environment needs:</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">LocalPythonExecutor</code> (Default):</strong>
    <ul>
      <li>Runs the code within the same Python process as your agent, but uses clever techniques (like parsing the code‚Äôs Abstract Syntax Tree - AST) to restrict dangerous operations (like file system access or arbitrary imports).</li>
      <li>It‚Äôs the simplest to set up (usually requires no extra installation).</li>
      <li>It‚Äôs generally safe for many tasks, but a very complex or malicious piece of code <em>might</em> potentially find ways around the restrictions (though this is difficult).</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">DockerExecutor</code>:</strong>
    <ul>
      <li>Runs the code inside a separate Docker container. Docker provides strong isolation from your main system.</li>
      <li>Requires Docker to be installed and running on your machine.</li>
      <li>Offers better security than the local executor.</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">E2BExecutor</code> (Environment-to-Behavior):</strong>
    <ul>
      <li>Uses a cloud service (E2B.dev) to provide secure, sandboxed cloud environments for code execution.</li>
      <li>Requires an E2B account and API key.</li>
      <li>Offers very strong security and avoids needing Docker locally, but relies on an external service.</li>
    </ul>
  </li>
</ol>

<p><strong>How to Choose?</strong></p>

<ul>
  <li><strong>Beginners:</strong> Stick with the default <code class="language-plaintext highlighter-rouge">LocalPythonExecutor</code>. It‚Äôs usually sufficient and requires no extra setup.</li>
  <li><strong>Need Higher Security:</strong> If you‚Äôre running potentially riskier code or need stronger guarantees, consider <code class="language-plaintext highlighter-rouge">DockerExecutor</code> (if you have Docker) or <code class="language-plaintext highlighter-rouge">E2BExecutor</code>.</li>
</ul>

<p>You can specify the executor type when creating the <code class="language-plaintext highlighter-rouge">CodeAgent</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example: Using a Docker executor (if Docker is installed and running)
</span><span class="n">docker_agent</span> <span class="o">=</span> <span class="n">CodeAgent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">search_tool</span><span class="p">],</span>
    <span class="n">executor_type</span><span class="o">=</span><span class="s">"docker"</span> <span class="c1"># Tell the agent to use Docker
</span>    <span class="c1"># You might need to pass executor_kwargs for specific configurations
</span><span class="p">)</span>

<span class="c1"># Example: Using E2B (requires E2B setup and API key in environment)
# pip install 'smolagents[e2b]'
</span><span class="n">e2b_agent</span> <span class="o">=</span> <span class="n">CodeAgent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">search_tool</span><span class="p">],</span>
    <span class="n">executor_type</span><span class="o">=</span><span class="s">"e2b"</span> <span class="c1"># Tell the agent to use E2B
</span><span class="p">)</span>
</code></pre></div></div>

<p>For the rest of this chapter, we‚Äôll mostly focus on the concepts common to all executors, using the default <code class="language-plaintext highlighter-rouge">LocalPythonExecutor</code> as the main example.</p>

<h2 id="under-the-hood-how-execution-works">Under the Hood: How Execution Works</h2>

<p>Let‚Äôs trace what happens when <code class="language-plaintext highlighter-rouge">CodeAgent</code> decides to run a piece of code:</p>

<ol>
  <li><strong>Agent (Think):</strong> The LLM generates a response containing Python code, like:
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Thought: I need to calculate 5 * 10.
</span><span class="n">result</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">10</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"The intermediate result is: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">final_answer</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Agent (Act - Parse):</strong> The <code class="language-plaintext highlighter-rouge">CodeAgent</code> extracts the Python code block.</li>
  <li><strong>Agent (Act - Execute):</strong> The <code class="language-plaintext highlighter-rouge">CodeAgent</code> calls its <code class="language-plaintext highlighter-rouge">python_executor</code> instance, passing the code string. <code class="language-plaintext highlighter-rouge">output, logs, is_final = self.python_executor(code_string)</code></li>
  <li><strong>Executor (Prepare):</strong> The <code class="language-plaintext highlighter-rouge">PythonExecutor</code> (e.g., <code class="language-plaintext highlighter-rouge">LocalPythonExecutor</code>) gets ready. It knows the current state (variables defined in previous steps).</li>
  <li><strong>Executor (Run Safely):</strong>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">LocalPythonExecutor</code>: Parses the code into an Abstract Syntax Tree (AST). It walks through the tree, evaluating allowed operations (math, variable assignments, safe function calls) and blocking dangerous ones (like <code class="language-plaintext highlighter-rouge">os.system</code>). It executes the code within the current <code class="language-plaintext highlighter-rouge">state</code>.</li>
      <li><code class="language-plaintext highlighter-rouge">DockerExecutor</code>/<code class="language-plaintext highlighter-rouge">E2BExecutor</code>: Sends the code to the remote environment (Docker container or E2B sandbox) for execution.</li>
    </ul>
  </li>
  <li><strong>Executor (Capture):</strong> It intercepts any output sent to <code class="language-plaintext highlighter-rouge">print()</code> (captured in <code class="language-plaintext highlighter-rouge">logs</code>) and gets the final value returned by the code block (if any, captured in <code class="language-plaintext highlighter-rouge">output</code>). It also checks if the special <code class="language-plaintext highlighter-rouge">final_answer()</code> function was called (indicated by <code class="language-plaintext highlighter-rouge">is_final</code>).</li>
  <li><strong>Executor (Update State):</strong> If the code assigned variables (like <code class="language-plaintext highlighter-rouge">result = 50</code>), the executor updates its internal <code class="language-plaintext highlighter-rouge">state</code> dictionary.</li>
  <li><strong>Agent (Observe):</strong> The <code class="language-plaintext highlighter-rouge">CodeAgent</code> receives the <code class="language-plaintext highlighter-rouge">output</code>, <code class="language-plaintext highlighter-rouge">logs</code>, and <code class="language-plaintext highlighter-rouge">is_final</code> flag from the executor. This becomes the ‚ÄúObservation‚Äù for the current step. If <code class="language-plaintext highlighter-rouge">is_final</code> is true, the agent knows the task is complete.</li>
</ol>

<p><strong>Diagram:</strong></p>

<pre><code class="language-mermaid">sequenceDiagram
    participant Agent as CodeAgent
    participant Executor as PythonExecutor (e.g., Local)
    participant SafeEnv as Safe Execution Env (AST walk / Docker / E2B)
    participant State as Executor State

    Agent-&gt;&gt;Executor: execute(code_string)
    Executor-&gt;&gt;State: Get current variables
    Executor-&gt;&gt;SafeEnv: Run code_string safely
    SafeEnv-&gt;&gt;SafeEnv: Execute line by line (e.g., result = 5 * 10)
    SafeEnv--&gt;&gt;State: Update variable 'result' = 50
    SafeEnv-&gt;&gt;Executor: Capture print() output ("The intermediate result is: 50")
    SafeEnv-&gt;&gt;Executor: Capture final result (50)
    SafeEnv-&gt;&gt;Executor: Indicate if final_answer() was called
    Executor--&gt;&gt;Agent: Return: output=50, logs="...", is_final=True
</code></pre>

<h2 id="code-glimpse-where-is-the-executor-used">Code Glimpse: Where is the Executor Used?</h2>

<p>Let‚Äôs look at simplified snippets showing the key interactions.</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">CodeAgent</code> Initialization (<code class="language-plaintext highlighter-rouge">agents.py</code>):</strong> Creates the executor instance.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- File: agents.py (Simplified CodeAgent __init__) ---
</span><span class="kn">from</span> <span class="nn">.local_python_executor</span> <span class="kn">import</span> <span class="n">LocalPythonExecutor</span><span class="p">,</span> <span class="n">PythonExecutor</span>
<span class="kn">from</span> <span class="nn">.remote_executors</span> <span class="kn">import</span> <span class="n">DockerExecutor</span><span class="p">,</span> <span class="n">E2BExecutor</span>

<span class="k">class</span> <span class="nc">CodeAgent</span><span class="p">(</span><span class="n">MultiStepAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="c1"># ... model, tools, etc. ...
</span>        <span class="n">executor_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="s">"local"</span><span class="p">,</span> <span class="c1"># Default is local
</span>        <span class="n">executor_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">additional_authorized_imports</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">max_print_outputs_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="c1"># ... other kwargs ...
</span>    <span class="p">):</span>
        <span class="c1"># ... setup basic agent parts ...
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">executor_type</span> <span class="o">=</span> <span class="n">executor_type</span> <span class="ow">or</span> <span class="s">"local"</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">executor_kwargs</span> <span class="o">=</span> <span class="n">executor_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">additional_authorized_imports</span> <span class="o">=</span> <span class="n">additional_authorized_imports</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">max_print_outputs_length</span> <span class="o">=</span> <span class="n">max_print_outputs_length</span>

        <span class="c1"># Create the appropriate executor instance based on type
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">python_executor</span><span class="p">:</span> <span class="n">PythonExecutor</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">create_python_executor</span><span class="p">()</span>

        <span class="c1"># ... rest of setup ...
</span>        <span class="c1"># Send initial state/tools to executor if needed
</span>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">"python_executor"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">python_executor</span><span class="p">.</span><span class="n">send_variables</span><span class="p">(</span><span class="n">variables</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">python_executor</span><span class="p">.</span><span class="n">send_tools</span><span class="p">({</span><span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">managed_agents</span><span class="p">})</span>


    <span class="k">def</span> <span class="nf">create_python_executor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PythonExecutor</span><span class="p">:</span>
        <span class="s">"""Helper method to create the executor instance."""</span>
        <span class="n">match</span> <span class="bp">self</span><span class="p">.</span><span class="n">executor_type</span><span class="p">:</span>
            <span class="n">case</span> <span class="s">"e2b"</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">E2BExecutor</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">additional_authorized_imports</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">executor_kwargs</span><span class="p">)</span>
            <span class="n">case</span> <span class="s">"docker"</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">DockerExecutor</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">additional_authorized_imports</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">executor_kwargs</span><span class="p">)</span>
            <span class="n">case</span> <span class="s">"local"</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">LocalPythonExecutor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">additional_authorized_imports</span><span class="p">,</span>
                    <span class="n">max_print_outputs_length</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">max_print_outputs_length</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">case</span> <span class="n">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Unsupported executor type: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">executor_type</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div>    </div>
    <ul>
      <li>The <code class="language-plaintext highlighter-rouge">CodeAgent</code> takes <code class="language-plaintext highlighter-rouge">executor_type</code> and related arguments.</li>
      <li>The <code class="language-plaintext highlighter-rouge">create_python_executor</code> method instantiates the correct class (<code class="language-plaintext highlighter-rouge">LocalPythonExecutor</code>, <code class="language-plaintext highlighter-rouge">DockerExecutor</code>, or <code class="language-plaintext highlighter-rouge">E2BExecutor</code>).</li>
      <li>Initial tools and state might be sent to the executor using <code class="language-plaintext highlighter-rouge">send_tools</code> and <code class="language-plaintext highlighter-rouge">send_variables</code>.</li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">CodeAgent</code> Step Execution (<code class="language-plaintext highlighter-rouge">agents.py</code>):</strong> Uses the executor instance.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- File: agents.py (Simplified CodeAgent step) ---
</span><span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">parse_code_blobs</span> <span class="c1"># Helper to extract code
</span><span class="kn">from</span> <span class="nn">.local_python_executor</span> <span class="kn">import</span> <span class="n">fix_final_answer_code</span> <span class="c1"># Helper
</span>
<span class="k">class</span> <span class="nc">CodeAgent</span><span class="p">(</span><span class="n">MultiStepAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory_step</span><span class="p">:</span> <span class="n">ActionStep</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># ... (Agent thinks, gets LLM response with code) ...
</span>        <span class="n">model_output</span> <span class="o">=</span> <span class="n">chat_message</span><span class="p">.</span><span class="n">content</span>

        <span class="c1"># Parse the code from the LLM response
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># parse_code_blobs finds ```python ... ``` blocks
</span>            <span class="c1"># fix_final_answer ensures `final_answer = x` becomes `final_answer(x)`
</span>            <span class="n">code_action</span> <span class="o">=</span> <span class="n">fix_final_answer_code</span><span class="p">(</span><span class="n">parse_code_blobs</span><span class="p">(</span><span class="n">model_output</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle parsing errors
</span>            <span class="k">raise</span> <span class="n">AgentParsingError</span><span class="p">(...)</span>

        <span class="c1"># === Execute the code using the PythonExecutor ===
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">log_code</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">"Executing parsed code:"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">code_action</span><span class="p">,</span> <span class="p">...)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># THE CORE CALL to the executor
</span>            <span class="n">output</span><span class="p">,</span> <span class="n">execution_logs</span><span class="p">,</span> <span class="n">is_final_answer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">python_executor</span><span class="p">(</span><span class="n">code_action</span><span class="p">)</span>

            <span class="c1"># Store results in memory step
</span>            <span class="n">memory_step</span><span class="p">.</span><span class="n">observations</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"Execution logs:</span><span class="se">\n</span><span class="si">{</span><span class="n">execution_logs</span><span class="si">}</span><span class="se">\n</span><span class="s">Last output:</span><span class="se">\n</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s">"</span>
            <span class="n">memory_step</span><span class="p">.</span><span class="n">action_output</span> <span class="o">=</span> <span class="n">output</span>

        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle execution errors reported by the executor
</span>            <span class="k">raise</span> <span class="n">AgentExecutionError</span><span class="p">(...)</span>

        <span class="c1"># Return the output if it's the final answer, otherwise None
</span>        <span class="k">return</span> <span class="n">output</span> <span class="k">if</span> <span class="n">is_final_answer</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="c1"># ...
</span></code></pre></div>    </div>
    <ul>
      <li>The <code class="language-plaintext highlighter-rouge">step</code> method gets code from the LLM.</li>
      <li>It calls <code class="language-plaintext highlighter-rouge">self.python_executor(code_action)</code>. This triggers the executor‚Äôs <code class="language-plaintext highlighter-rouge">__call__</code> method.</li>
      <li>It receives the <code class="language-plaintext highlighter-rouge">output</code>, <code class="language-plaintext highlighter-rouge">logs</code>, and <code class="language-plaintext highlighter-rouge">is_final_answer</code> flag back from the executor.</li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">LocalPythonExecutor</code> Execution (<code class="language-plaintext highlighter-rouge">local_python_executor.py</code>):</strong> The core logic for local execution.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- File: local_python_executor.py (Simplified LocalPythonExecutor __call__) ---
</span><span class="kn">from</span> <span class="nn">.local_python_executor</span> <span class="kn">import</span> <span class="n">evaluate_python_code</span> <span class="c1"># The safe evaluation function
</span><span class="kn">from</span> <span class="nn">.tools</span> <span class="kn">import</span> <span class="n">Tool</span> <span class="c1"># For type hinting
</span>
<span class="k">class</span> <span class="nc">LocalPythonExecutor</span><span class="p">(</span><span class="n">PythonExecutor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additional_authorized_imports</span><span class="p">,</span> <span class="n">max_print_outputs_length</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">custom_tools</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Stores functions defined in code
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Stores variables
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">max_print_outputs_length</span> <span class="o">=</span> <span class="n">max_print_outputs_length</span> <span class="ow">or</span> <span class="mi">50000</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">additional_authorized_imports</span> <span class="o">=</span> <span class="n">additional_authorized_imports</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">authorized_imports</span> <span class="o">=</span> <span class="c1"># ... combine base and additional imports ...
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">static_tools</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># Will hold agent tools + safe builtins
</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code_action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="s">"""Runs the code using the safe evaluate_python_code function."""</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">is_final_answer</span> <span class="o">=</span> <span class="n">evaluate_python_code</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">code_action</span><span class="p">,</span>
            <span class="n">static_tools</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">static_tools</span><span class="p">,</span> <span class="c1"># Tools provided by the agent
</span>            <span class="n">custom_tools</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">custom_tools</span><span class="p">,</span> <span class="c1"># Functions defined during execution
</span>            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="c1"># Current variables
</span>            <span class="n">authorized_imports</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">authorized_imports</span><span class="p">,</span> <span class="c1"># Allowed imports
</span>            <span class="n">max_print_outputs_length</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">max_print_outputs_length</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Get captured print logs from the state
</span>        <span class="n">logs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"_print_outputs"</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">logs</span><span class="p">,</span> <span class="n">is_final_answer</span>

    <span class="k">def</span> <span class="nf">send_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="s">"""Adds external variables to the executor's state."""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tool</span><span class="p">]):</span>
        <span class="s">"""Makes agent tools available to the executed code."""</span>
        <span class="c1"># Combine agent tools with safe Python builtins (like len, str, math functions)
</span>        <span class="kn">from</span> <span class="nn">.local_python_executor</span> <span class="kn">import</span> <span class="n">BASE_PYTHON_TOOLS</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">static_tools</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">tools</span><span class="p">,</span> <span class="o">**</span><span class="n">BASE_PYTHON_TOOLS</span><span class="p">.</span><span class="n">copy</span><span class="p">()}</span>

<span class="c1"># --- Also in local_python_executor.py ---
</span><span class="k">def</span> <span class="nf">evaluate_python_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">static_tools</span><span class="p">,</span> <span class="n">custom_tools</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">authorized_imports</span><span class="p">,</span> <span class="p">...):</span>
    <span class="s">"""
    Safely evaluates code by parsing to AST and walking the tree.
    - Parses `code` string into an Abstract Syntax Tree (AST).
    - Initializes `state['_print_outputs']` to capture prints.
    - Defines a `final_answer` wrapper to signal completion.
    - Iterates through AST nodes using `evaluate_ast`.
    - `evaluate_ast` recursively handles different node types (assignments, calls, loops etc.)
        - It uses `state` to read/write variables.
        - It checks calls against `static_tools` and `custom_tools`.
        - It enforces `authorized_imports`.
        - It blocks dangerous operations (e.g., direct `eval`, certain imports).
    - Returns the final `result` and `is_final_answer` flag.
    - Captures print outputs in `state['_print_outputs']`.
    - Handles errors gracefully.
    """</span>
    <span class="c1"># ... implementation details ...
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">ast</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="c1"># Parse code to AST
</span>        <span class="c1"># ... setup state, wrap final_answer ...
</span>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">.</span><span class="n">body</span><span class="p">:</span>
             <span class="n">result</span> <span class="o">=</span> <span class="n">evaluate_ast</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">static_tools</span><span class="p">,</span> <span class="n">custom_tools</span><span class="p">,</span> <span class="n">authorized_imports</span><span class="p">)</span> <span class="c1"># Evaluate node-by-node
</span>        <span class="c1"># ... capture logs, handle exceptions ...
</span>        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">is_final_answer</span>
    <span class="k">except</span> <span class="n">FinalAnswerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="c1"># ... capture logs ...
</span>         <span class="k">return</span> <span class="n">e</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">True</span> <span class="c1"># Special exception for final_answer
</span>    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="c1"># ... capture logs, wrap error ...
</span>         <span class="k">raise</span> <span class="n">InterpreterError</span><span class="p">(...)</span>

<span class="k">def</span> <span class="nf">evaluate_ast</span><span class="p">(</span><span class="n">expression</span><span class="p">:</span> <span class="n">ast</span><span class="p">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">static_tools</span><span class="p">,</span> <span class="n">custom_tools</span><span class="p">,</span> <span class="n">authorized_imports</span><span class="p">):</span>
    <span class="s">"""Recursive function to evaluate a single AST node safely."""</span>
    <span class="c1"># ... checks node type (ast.Assign, ast.Call, ast.Import, etc.) ...
</span>    <span class="c1"># ... performs the corresponding safe operation using state and tools ...
</span>    <span class="c1"># ... raises InterpreterError for disallowed operations ...
</span>    <span class="k">pass</span>
</code></pre></div>    </div>
    <ul>
      <li>The <code class="language-plaintext highlighter-rouge">LocalPythonExecutor</code>‚Äôs <code class="language-plaintext highlighter-rouge">__call__</code> method relies heavily on <code class="language-plaintext highlighter-rouge">evaluate_python_code</code>.</li>
      <li><code class="language-plaintext highlighter-rouge">evaluate_python_code</code> parses the code into an AST and evaluates it node by node using <code class="language-plaintext highlighter-rouge">evaluate_ast</code>, maintaining <code class="language-plaintext highlighter-rouge">state</code> and respecting allowed <code class="language-plaintext highlighter-rouge">tools</code> and <code class="language-plaintext highlighter-rouge">authorized_imports</code>.</li>
      <li>The <code class="language-plaintext highlighter-rouge">send_variables</code> and <code class="language-plaintext highlighter-rouge">send_tools</code> methods prepare the <code class="language-plaintext highlighter-rouge">state</code> and available functions for the executor.</li>
    </ul>
  </li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>The <code class="language-plaintext highlighter-rouge">PythonExecutor</code> is a critical safety component in <code class="language-plaintext highlighter-rouge">SmolaAgents</code>, especially when using <code class="language-plaintext highlighter-rouge">CodeAgent</code>. It provides a secure sandbox (local or remote) to execute AI-generated Python code, preventing potential harm while still allowing the agent to leverage code for complex calculations, data manipulation, and interacting with tools.</p>

<p>You‚Äôve learned:</p>

<ul>
  <li>Why safe code execution is essential when dealing with AI-generated code.</li>
  <li>The ‚Äúsecure laboratory‚Äù analogy for <code class="language-plaintext highlighter-rouge">PythonExecutor</code>.</li>
  <li>Its key responsibilities: isolation, execution, state management, and capturing output/errors.</li>
  <li>How <code class="language-plaintext highlighter-rouge">CodeAgent</code> uses it automatically (usually the <code class="language-plaintext highlighter-rouge">LocalPythonExecutor</code> by default).</li>
  <li>The difference between <code class="language-plaintext highlighter-rouge">LocalPythonExecutor</code>, <code class="language-plaintext highlighter-rouge">DockerExecutor</code>, and <code class="language-plaintext highlighter-rouge">E2BExecutor</code>.</li>
  <li>The basic flow of execution: Agent -&gt; Executor -&gt; Safe Environment -&gt; State -&gt; Executor -&gt; Agent.</li>
  <li>Where the executor is created and used within the <code class="language-plaintext highlighter-rouge">CodeAgent</code> code.</li>
</ul>

<p>While you might not interact with the <code class="language-plaintext highlighter-rouge">PythonExecutor</code> directly very often as a beginner, understanding its role is crucial for trusting your agents and knowing how they perform code-based actions safely.</p>

<p>So far, we‚Äôve seen <code class="language-plaintext highlighter-rouge">CodeAgent</code> and <code class="language-plaintext highlighter-rouge">ToolCallingAgent</code>. Are these the only types of agents? How can we define different agent behaviors?</p>

<p><strong>Next Chapter:</strong> <a href="07_agenttype.md">Chapter 7: AgentType</a> - Defining Agent Behaviors.</p>

<hr />

<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>
