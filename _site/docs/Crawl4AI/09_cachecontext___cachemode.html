<h1 id="chapter-9-smart-fetching-with-caching---cachecontext--cachemode">Chapter 9: Smart Fetching with Caching - CacheContext / CacheMode</h1>

<p>In the previous chapter, <a href="08_deepcrawlstrategy.md">Chapter 8: Exploring Websites - DeepCrawlStrategy</a>, we saw how Crawl4AI can explore websites by following links, potentially visiting many pages. During such explorations, or even when you run the same crawl multiple times, the crawler might try to fetch the exact same webpage again and again. This can be slow and might unnecessarily put a load on the website you’re crawling. Wouldn’t it be smarter to remember the result from the first time and just reuse it?</p>

<h2 id="what-problem-does-caching-solve">What Problem Does Caching Solve?</h2>

<p>Imagine you need to download a large instruction manual (a webpage) from the internet.</p>

<ul>
  <li><strong>Without Caching:</strong> Every single time you need the manual, you download the entire file again. This takes time and uses bandwidth every time.</li>
  <li><strong>With Caching:</strong> The first time you download it, you save a copy on your computer (the “cache”). The next time you need it, you first check your local copy. If it’s there, you use it instantly! You only download it again if you specifically want the absolute latest version or if your local copy is missing.</li>
</ul>

<p>Caching in Crawl4AI works the same way. It’s a mechanism to <strong>store the results</strong> of crawling a webpage locally (in a database file). When asked to crawl a URL again, Crawl4AI can check its cache first. If a valid result is already stored, it can return that saved result almost instantly, saving time and resources.</p>

<h2 id="introducing-cachemode-and-cachecontext">Introducing <code class="language-plaintext highlighter-rouge">CacheMode</code> and <code class="language-plaintext highlighter-rouge">CacheContext</code></h2>

<p>Crawl4AI uses two key concepts to manage this caching behavior:</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">CacheMode</code> (The Cache Policy):</strong>
    <ul>
      <li>Think of this like setting the rules for how you interact with your saved instruction manuals.</li>
      <li>It’s an <strong>instruction</strong> you give the crawler for a specific run, telling it <em>how</em> to use the cache.</li>
      <li><strong>Analogy:</strong> Should you <em>always</em> use your saved copy if you have one? (<code class="language-plaintext highlighter-rouge">ENABLED</code>) Should you <em>ignore</em> your saved copies and always download a fresh one? (<code class="language-plaintext highlighter-rouge">BYPASS</code>) Should you <em>never</em> save any copies? (<code class="language-plaintext highlighter-rouge">DISABLED</code>) Should you save new copies but never reuse old ones? (<code class="language-plaintext highlighter-rouge">WRITE_ONLY</code>)</li>
      <li><code class="language-plaintext highlighter-rouge">CacheMode</code> lets you choose the caching behavior that best fits your needs for a particular task.</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">CacheContext</code> (The Decision Maker):</strong>
    <ul>
      <li>This is an internal helper that Crawl4AI uses <em>during</em> a crawl. You don’t usually interact with it directly.</li>
      <li>It looks at the <code class="language-plaintext highlighter-rouge">CacheMode</code> you provided (the policy) and the type of URL being processed.</li>
      <li><strong>Analogy:</strong> Imagine a librarian who checks the library’s borrowing rules (<code class="language-plaintext highlighter-rouge">CacheMode</code>) and the type of item you’re requesting (e.g., a reference book that can’t be checked out, like <code class="language-plaintext highlighter-rouge">raw:</code> HTML which isn’t cached). Based on these, the librarian (<code class="language-plaintext highlighter-rouge">CacheContext</code>) decides if you can borrow an existing copy (read from cache) or if a new copy should be added to the library (write to cache).</li>
      <li>It helps the main <code class="language-plaintext highlighter-rouge">AsyncWebCrawler</code> make the right decision about reading from or writing to the cache for each specific URL based on the active policy.</li>
    </ul>
  </li>
</ol>

<h2 id="setting-the-cache-policy-using-cachemode">Setting the Cache Policy: Using <code class="language-plaintext highlighter-rouge">CacheMode</code></h2>

<p>You control the caching behavior by setting the <code class="language-plaintext highlighter-rouge">cache_mode</code> parameter within the <code class="language-plaintext highlighter-rouge">CrawlerRunConfig</code> object that you pass to <code class="language-plaintext highlighter-rouge">crawler.arun()</code> or <code class="language-plaintext highlighter-rouge">crawler.arun_many()</code>.</p>

<p>Let’s explore the most common <code class="language-plaintext highlighter-rouge">CacheMode</code> options:</p>

<p><strong>1. <code class="language-plaintext highlighter-rouge">CacheMode.ENABLED</code> (The Default Behavior - If not specified)</strong></p>

<ul>
  <li><strong>Policy:</strong> “Use the cache if a valid result exists. If not, fetch the page, save the result to the cache, and then return it.”</li>
  <li>This is the standard, balanced approach. It saves time on repeated crawls but ensures you get the content eventually.</li>
  <li><em>Note: In recent versions, the default if <code class="language-plaintext highlighter-rouge">cache_mode</code> is left completely unspecified might be <code class="language-plaintext highlighter-rouge">CacheMode.BYPASS</code>. Always check the documentation or explicitly set the mode for clarity.</em> For this tutorial, let’s assume we explicitly set it.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># chapter9_example_1.py
</span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">crawl4ai</span> <span class="kn">import</span> <span class="n">AsyncWebCrawler</span><span class="p">,</span> <span class="n">CrawlerRunConfig</span><span class="p">,</span> <span class="n">CacheMode</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://httpbin.org/html"</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncWebCrawler</span><span class="p">()</span> <span class="k">as</span> <span class="n">crawler</span><span class="p">:</span>
        <span class="c1"># Explicitly set the mode to ENABLED
</span>        <span class="n">config_enabled</span> <span class="o">=</span> <span class="n">CrawlerRunConfig</span><span class="p">(</span><span class="n">cache_mode</span><span class="o">=</span><span class="n">CacheMode</span><span class="p">.</span><span class="n">ENABLED</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Running with CacheMode: </span><span class="si">{</span><span class="n">config_enabled</span><span class="p">.</span><span class="n">cache_mode</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="c1"># First run: Fetches, caches, and returns result
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"First run (ENABLED)..."</span><span class="p">)</span>
        <span class="n">result1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crawler</span><span class="p">.</span><span class="n">arun</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_enabled</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Got result 1? </span><span class="si">{</span><span class="s">'Yes'</span> <span class="k">if</span> <span class="n">result1</span><span class="p">.</span><span class="n">success</span> <span class="k">else</span> <span class="s">'No'</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="c1"># Second run: Finds result in cache and returns it instantly
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"Second run (ENABLED)..."</span><span class="p">)</span>
        <span class="n">result2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crawler</span><span class="p">.</span><span class="n">arun</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_enabled</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Got result 2? </span><span class="si">{</span><span class="s">'Yes'</span> <span class="k">if</span> <span class="n">result2</span><span class="p">.</span><span class="n">success</span> <span class="k">else</span> <span class="s">'No'</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="c1"># This second run should be much faster!
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ul>
  <li>We create a <code class="language-plaintext highlighter-rouge">CrawlerRunConfig</code> with <code class="language-plaintext highlighter-rouge">cache_mode=CacheMode.ENABLED</code>.</li>
  <li>The first <code class="language-plaintext highlighter-rouge">arun</code> call fetches the page from the web and saves the result in the cache.</li>
  <li>The second <code class="language-plaintext highlighter-rouge">arun</code> call (for the same URL and config affecting cache key) finds the saved result in the cache and returns it immediately, skipping the web fetch.</li>
</ul>

<p><strong>2. <code class="language-plaintext highlighter-rouge">CacheMode.BYPASS</code></strong></p>

<ul>
  <li><strong>Policy:</strong> “Ignore any existing saved copy. Always fetch a fresh copy from the web. After fetching, save this new result to the cache (overwriting any old one).”</li>
  <li>Useful when you <em>always</em> need the absolute latest version of the page, but you still want to update the cache for potential future use with <code class="language-plaintext highlighter-rouge">CacheMode.ENABLED</code>.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># chapter9_example_2.py
</span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">crawl4ai</span> <span class="kn">import</span> <span class="n">AsyncWebCrawler</span><span class="p">,</span> <span class="n">CrawlerRunConfig</span><span class="p">,</span> <span class="n">CacheMode</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://httpbin.org/html"</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncWebCrawler</span><span class="p">()</span> <span class="k">as</span> <span class="n">crawler</span><span class="p">:</span>
        <span class="c1"># Set the mode to BYPASS
</span>        <span class="n">config_bypass</span> <span class="o">=</span> <span class="n">CrawlerRunConfig</span><span class="p">(</span><span class="n">cache_mode</span><span class="o">=</span><span class="n">CacheMode</span><span class="p">.</span><span class="n">BYPASS</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Running with CacheMode: </span><span class="si">{</span><span class="n">config_bypass</span><span class="p">.</span><span class="n">cache_mode</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="c1"># First run: Fetches, caches, and returns result
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"First run (BYPASS)..."</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">result1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crawler</span><span class="p">.</span><span class="n">arun</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_bypass</span><span class="p">)</span>
        <span class="n">duration1</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Got result 1? </span><span class="si">{</span><span class="s">'Yes'</span> <span class="k">if</span> <span class="n">result1</span><span class="p">.</span><span class="n">success</span> <span class="k">else</span> <span class="s">'No'</span><span class="si">}</span><span class="s"> (took </span><span class="si">{</span><span class="n">duration1</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s)"</span><span class="p">)</span>

        <span class="c1"># Second run: Ignores cache, fetches again, updates cache, returns result
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"Second run (BYPASS)..."</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">result2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crawler</span><span class="p">.</span><span class="n">arun</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_bypass</span><span class="p">)</span>
        <span class="n">duration2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Got result 2? </span><span class="si">{</span><span class="s">'Yes'</span> <span class="k">if</span> <span class="n">result2</span><span class="p">.</span><span class="n">success</span> <span class="k">else</span> <span class="s">'No'</span><span class="si">}</span><span class="s"> (took </span><span class="si">{</span><span class="n">duration2</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s)"</span><span class="p">)</span>
        <span class="c1"># Both runs should take a similar amount of time (fetching time)
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ul>
  <li>We set <code class="language-plaintext highlighter-rouge">cache_mode=CacheMode.BYPASS</code>.</li>
  <li>Both the first and second <code class="language-plaintext highlighter-rouge">arun</code> calls will fetch the page directly from the web, ignoring any previously cached result. They will still write the newly fetched result to the cache. Notice both runs take roughly the same amount of time (network fetch time).</li>
</ul>

<p><strong>3. <code class="language-plaintext highlighter-rouge">CacheMode.DISABLED</code></strong></p>

<ul>
  <li><strong>Policy:</strong> “Completely ignore the cache. Never read from it, never write to it.”</li>
  <li>Useful when you don’t want Crawl4AI to interact with the cache files at all, perhaps for debugging or if you have storage constraints.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># chapter9_example_3.py
</span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">crawl4ai</span> <span class="kn">import</span> <span class="n">AsyncWebCrawler</span><span class="p">,</span> <span class="n">CrawlerRunConfig</span><span class="p">,</span> <span class="n">CacheMode</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://httpbin.org/html"</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncWebCrawler</span><span class="p">()</span> <span class="k">as</span> <span class="n">crawler</span><span class="p">:</span>
        <span class="c1"># Set the mode to DISABLED
</span>        <span class="n">config_disabled</span> <span class="o">=</span> <span class="n">CrawlerRunConfig</span><span class="p">(</span><span class="n">cache_mode</span><span class="o">=</span><span class="n">CacheMode</span><span class="p">.</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Running with CacheMode: </span><span class="si">{</span><span class="n">config_disabled</span><span class="p">.</span><span class="n">cache_mode</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="c1"># First run: Fetches, returns result (does NOT cache)
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"First run (DISABLED)..."</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">result1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crawler</span><span class="p">.</span><span class="n">arun</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_disabled</span><span class="p">)</span>
        <span class="n">duration1</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Got result 1? </span><span class="si">{</span><span class="s">'Yes'</span> <span class="k">if</span> <span class="n">result1</span><span class="p">.</span><span class="n">success</span> <span class="k">else</span> <span class="s">'No'</span><span class="si">}</span><span class="s"> (took </span><span class="si">{</span><span class="n">duration1</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s)"</span><span class="p">)</span>

        <span class="c1"># Second run: Fetches again, returns result (does NOT cache)
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"Second run (DISABLED)..."</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">result2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crawler</span><span class="p">.</span><span class="n">arun</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_disabled</span><span class="p">)</span>
        <span class="n">duration2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Got result 2? </span><span class="si">{</span><span class="s">'Yes'</span> <span class="k">if</span> <span class="n">result2</span><span class="p">.</span><span class="n">success</span> <span class="k">else</span> <span class="s">'No'</span><span class="si">}</span><span class="s"> (took </span><span class="si">{</span><span class="n">duration2</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s)"</span><span class="p">)</span>
        <span class="c1"># Both runs fetch fresh, and nothing is ever saved to the cache.
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ul>
  <li>We set <code class="language-plaintext highlighter-rouge">cache_mode=CacheMode.DISABLED</code>.</li>
  <li>Both <code class="language-plaintext highlighter-rouge">arun</code> calls fetch fresh content from the web. Crucially, neither run reads from nor writes to the cache database.</li>
</ul>

<p><strong>Other Modes (<code class="language-plaintext highlighter-rouge">READ_ONLY</code>, <code class="language-plaintext highlighter-rouge">WRITE_ONLY</code>):</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">CacheMode.READ_ONLY</code>: Only uses existing cached results. If a result isn’t in the cache, it will fail or return an empty result rather than fetching it. Never saves anything new.</li>
  <li><code class="language-plaintext highlighter-rouge">CacheMode.WRITE_ONLY</code>: Never reads from the cache (always fetches fresh). It <em>only</em> writes the newly fetched result to the cache.</li>
</ul>

<h2 id="how-caching-works-internally">How Caching Works Internally</h2>

<p>When you call <code class="language-plaintext highlighter-rouge">crawler.arun(url="...", config=...)</code>:</p>

<ol>
  <li><strong>Create Context:</strong> The <code class="language-plaintext highlighter-rouge">AsyncWebCrawler</code> creates a <code class="language-plaintext highlighter-rouge">CacheContext</code> instance using the <code class="language-plaintext highlighter-rouge">url</code> and the <code class="language-plaintext highlighter-rouge">config.cache_mode</code>.</li>
  <li><strong>Check Read:</strong> It asks the <code class="language-plaintext highlighter-rouge">CacheContext</code>, “Should I read from the cache?” (<code class="language-plaintext highlighter-rouge">cache_context.should_read()</code>).</li>
  <li><strong>Try Reading:</strong> If <code class="language-plaintext highlighter-rouge">should_read()</code> is <code class="language-plaintext highlighter-rouge">True</code>, it asks the database manager (<a href="async_database.py"><code class="language-plaintext highlighter-rouge">AsyncDatabaseManager</code></a>) to look for a cached result for the <code class="language-plaintext highlighter-rouge">url</code>.</li>
  <li><strong>Cache Hit?</strong>
    <ul>
      <li>If a valid cached result is found: The <code class="language-plaintext highlighter-rouge">AsyncWebCrawler</code> returns this cached <code class="language-plaintext highlighter-rouge">CrawlResult</code> immediately. Done!</li>
      <li>If no cached result is found (or if <code class="language-plaintext highlighter-rouge">should_read()</code> was <code class="language-plaintext highlighter-rouge">False</code>): Proceed to fetching.</li>
    </ul>
  </li>
  <li><strong>Fetch:</strong> The <code class="language-plaintext highlighter-rouge">AsyncWebCrawler</code> calls the appropriate <a href="01_asynccrawlerstrategy.md">AsyncCrawlerStrategy</a> to fetch the content from the web.</li>
  <li><strong>Process:</strong> It processes the fetched HTML (scraping, filtering, extracting) to create a new <code class="language-plaintext highlighter-rouge">CrawlResult</code>.</li>
  <li><strong>Check Write:</strong> It asks the <code class="language-plaintext highlighter-rouge">CacheContext</code>, “Should I write this result to the cache?” (<code class="language-plaintext highlighter-rouge">cache_context.should_write()</code>).</li>
  <li><strong>Write Cache:</strong> If <code class="language-plaintext highlighter-rouge">should_write()</code> is <code class="language-plaintext highlighter-rouge">True</code>, it tells the database manager to save the new <code class="language-plaintext highlighter-rouge">CrawlResult</code> into the cache database.</li>
  <li><strong>Return:</strong> The <code class="language-plaintext highlighter-rouge">AsyncWebCrawler</code> returns the newly created <code class="language-plaintext highlighter-rouge">CrawlResult</code>.</li>
</ol>

<pre><code class="language-mermaid">sequenceDiagram
    participant User
    participant AWC as AsyncWebCrawler
    participant Ctx as CacheContext
    participant DB as DatabaseManager
    participant Fetcher as AsyncCrawlerStrategy

    User-&gt;&gt;AWC: arun(url, config)
    AWC-&gt;&gt;Ctx: Create CacheContext(url, config.cache_mode)
    AWC-&gt;&gt;Ctx: should_read()?
    alt Cache Read Allowed
        Ctx--&gt;&gt;AWC: Yes
        AWC-&gt;&gt;DB: aget_cached_url(url)
        DB--&gt;&gt;AWC: Cached Result (or None)
        alt Cache Hit &amp; Valid
            AWC--&gt;&gt;User: Return Cached CrawlResult
        else Cache Miss or Invalid
            AWC-&gt;&gt;AWC: Proceed to Fetch
        end
    else Cache Read Not Allowed
        Ctx--&gt;&gt;AWC: No
        AWC-&gt;&gt;AWC: Proceed to Fetch
    end

    Note over AWC: Fetching Required
    AWC-&gt;&gt;Fetcher: crawl(url, config)
    Fetcher--&gt;&gt;AWC: Raw Response
    AWC-&gt;&gt;AWC: Process HTML -&gt; New CrawlResult
    AWC-&gt;&gt;Ctx: should_write()?
    alt Cache Write Allowed
        Ctx--&gt;&gt;AWC: Yes
        AWC-&gt;&gt;DB: acache_url(New CrawlResult)
        DB--&gt;&gt;AWC: OK
    else Cache Write Not Allowed
        Ctx--&gt;&gt;AWC: No
    end
    AWC--&gt;&gt;User: Return New CrawlResult

</code></pre>

<h2 id="code-glimpse">Code Glimpse</h2>

<p>Let’s look at simplified code snippets.</p>

<p><strong>Inside <code class="language-plaintext highlighter-rouge">async_webcrawler.py</code> (where <code class="language-plaintext highlighter-rouge">arun</code> uses caching):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified from crawl4ai/async_webcrawler.py
</span><span class="kn">from</span> <span class="nn">.cache_context</span> <span class="kn">import</span> <span class="n">CacheContext</span><span class="p">,</span> <span class="n">CacheMode</span>
<span class="kn">from</span> <span class="nn">.async_database</span> <span class="kn">import</span> <span class="n">async_db_manager</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">CrawlResult</span>
<span class="c1"># ... other imports
</span>
<span class="k">class</span> <span class="nc">AsyncWebCrawler</span><span class="p">:</span>
    <span class="c1"># ... (init, other methods) ...
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">arun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">CrawlerRunConfig</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CrawlResult</span><span class="p">:</span>
        <span class="c1"># ... (ensure config exists, set defaults) ...
</span>        <span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">cache_mode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">config</span><span class="p">.</span><span class="n">cache_mode</span> <span class="o">=</span> <span class="n">CacheMode</span><span class="p">.</span><span class="n">ENABLED</span> <span class="c1"># Example default
</span>
        <span class="c1"># 1. Create CacheContext
</span>        <span class="n">cache_context</span> <span class="o">=</span> <span class="n">CacheContext</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">cache_mode</span><span class="p">)</span>

        <span class="n">cached_result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># 2. Check if cache read is allowed
</span>        <span class="k">if</span> <span class="n">cache_context</span><span class="p">.</span><span class="n">should_read</span><span class="p">():</span>
            <span class="c1"># 3. Try reading from database
</span>            <span class="n">cached_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">async_db_manager</span><span class="p">.</span><span class="n">aget_cached_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># 4. If cache hit and valid, return it
</span>        <span class="k">if</span> <span class="n">cached_result</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">_is_cache_valid</span><span class="p">(</span><span class="n">cached_result</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Cache hit for: %s"</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span> <span class="c1"># Example log
</span>            <span class="k">return</span> <span class="n">cached_result</span> <span class="c1"># Return early
</span>
        <span class="c1"># 5. Fetch fresh content (if no cache hit or read disabled)
</span>        <span class="n">async_response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">crawler_strategy</span><span class="p">.</span><span class="n">crawl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">async_response</span><span class="p">.</span><span class="n">html</span> <span class="c1"># ... and other data ...
</span>
        <span class="c1"># 6. Process the HTML to get a new CrawlResult
</span>        <span class="n">crawl_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">aprocess_html</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="c1"># ... other params ...
</span>        <span class="p">)</span>

        <span class="c1"># 7. Check if cache write is allowed
</span>        <span class="k">if</span> <span class="n">cache_context</span><span class="p">.</span><span class="n">should_write</span><span class="p">():</span>
            <span class="c1"># 8. Write the new result to the database
</span>            <span class="k">await</span> <span class="n">async_db_manager</span><span class="p">.</span><span class="n">acache_url</span><span class="p">(</span><span class="n">crawl_result</span><span class="p">)</span>

        <span class="c1"># 9. Return the new result
</span>        <span class="k">return</span> <span class="n">crawl_result</span>

    <span class="k">def</span> <span class="nf">_is_cache_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cached_result</span><span class="p">:</span> <span class="n">CrawlResult</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">CrawlerRunConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># Internal logic to check if cached result meets current needs
</span>        <span class="c1"># (e.g., was screenshot requested now but not cached?)
</span>        <span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">screenshot</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cached_result</span><span class="p">.</span><span class="n">screenshot</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">pdf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cached_result</span><span class="p">.</span><span class="n">pdf</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="c1"># ... other checks ...
</span>        <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<p><strong>Inside <code class="language-plaintext highlighter-rouge">cache_context.py</code> (defining the concepts):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified from crawl4ai/cache_context.py
</span><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">CacheMode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="s">"""Defines the caching behavior for web crawling operations."""</span>
    <span class="n">ENABLED</span> <span class="o">=</span> <span class="s">"enabled"</span>     <span class="c1"># Read and Write
</span>    <span class="n">DISABLED</span> <span class="o">=</span> <span class="s">"disabled"</span>    <span class="c1"># No Read, No Write
</span>    <span class="n">READ_ONLY</span> <span class="o">=</span> <span class="s">"read_only"</span>  <span class="c1"># Read Only, No Write
</span>    <span class="n">WRITE_ONLY</span> <span class="o">=</span> <span class="s">"write_only"</span> <span class="c1"># Write Only, No Read
</span>    <span class="n">BYPASS</span> <span class="o">=</span> <span class="s">"bypass"</span>      <span class="c1"># No Read, Write Only (similar to WRITE_ONLY but explicit intention)
</span>
<span class="k">class</span> <span class="nc">CacheContext</span><span class="p">:</span>
    <span class="s">"""Encapsulates cache-related decisions and URL handling."""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cache_mode</span><span class="p">:</span> <span class="n">CacheMode</span><span class="p">,</span> <span class="n">always_bypass</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">cache_mode</span> <span class="o">=</span> <span class="n">cache_mode</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">always_bypass</span> <span class="o">=</span> <span class="n">always_bypass</span> <span class="c1"># Usually False
</span>        <span class="c1"># Determine if URL type is cacheable (e.g., not 'raw:')
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">is_cacheable</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="n">startswith</span><span class="p">((</span><span class="s">"http://"</span><span class="p">,</span> <span class="s">"https://"</span><span class="p">,</span> <span class="s">"file://"</span><span class="p">))</span>
        <span class="c1"># ... other URL type checks ...
</span>
    <span class="k">def</span> <span class="nf">should_read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s">"""Determines if cache should be read based on context."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">always_bypass</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_cacheable</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="c1"># Allow read if mode is ENABLED or READ_ONLY
</span>        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">cache_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CacheMode</span><span class="p">.</span><span class="n">ENABLED</span><span class="p">,</span> <span class="n">CacheMode</span><span class="p">.</span><span class="n">READ_ONLY</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">should_write</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s">"""Determines if cache should be written based on context."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">always_bypass</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_cacheable</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="c1"># Allow write if mode is ENABLED, WRITE_ONLY, or BYPASS
</span>        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">cache_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CacheMode</span><span class="p">.</span><span class="n">ENABLED</span><span class="p">,</span> <span class="n">CacheMode</span><span class="p">.</span><span class="n">WRITE_ONLY</span><span class="p">,</span> <span class="n">CacheMode</span><span class="p">.</span><span class="n">BYPASS</span><span class="p">]</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">display_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Returns the URL in display format."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">url</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">url</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"raw:"</span><span class="p">)</span> <span class="k">else</span> <span class="s">"Raw HTML"</span>

<span class="c1"># Helper for backward compatibility (may be removed later)
</span><span class="k">def</span> <span class="nf">_legacy_to_cache_mode</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">CacheMode</span><span class="p">:</span>
    <span class="c1"># ... logic to convert old boolean flags ...
</span>    <span class="k">pass</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>You’ve learned how Crawl4AI uses caching to avoid redundant work and speed up repeated crawls!</p>

<ul>
  <li><strong>Caching</strong> stores results locally to reuse them later.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">CacheMode</code></strong> is the policy you set in <code class="language-plaintext highlighter-rouge">CrawlerRunConfig</code> to control <em>how</em> the cache is used (<code class="language-plaintext highlighter-rouge">ENABLED</code>, <code class="language-plaintext highlighter-rouge">BYPASS</code>, <code class="language-plaintext highlighter-rouge">DISABLED</code>, etc.).</li>
  <li><strong><code class="language-plaintext highlighter-rouge">CacheContext</code></strong> is an internal helper that makes decisions based on the <code class="language-plaintext highlighter-rouge">CacheMode</code> and URL type.</li>
  <li>Using the cache effectively (especially <code class="language-plaintext highlighter-rouge">CacheMode.ENABLED</code>) can significantly speed up your crawling tasks, particularly during development or when dealing with many URLs, including deep crawls.</li>
</ul>

<p>We’ve seen how Crawl4AI can crawl single pages, lists of pages (<code class="language-plaintext highlighter-rouge">arun_many</code>), and even explore websites (<code class="language-plaintext highlighter-rouge">DeepCrawlStrategy</code>). But how does <code class="language-plaintext highlighter-rouge">arun_many</code> or a deep crawl manage running potentially hundreds or thousands of individual crawl tasks efficiently without overwhelming your system or the target website?</p>

<p><strong>Next:</strong> Let’s explore the component responsible for managing concurrent tasks: <a href="10_basedispatcher.md">Chapter 10: Orchestrating the Crawl - BaseDispatcher</a>.</p>

<hr />

<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>
