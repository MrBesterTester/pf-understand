<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Chapter 4: Strides and Offset Computation | Two Tutorials for Mojo using Pocket Flow</title> <meta name="generator" content="Jekyll v4.3.4" /> <meta property="og:title" content="Chapter 4: Strides and Offset Computation" /> <meta name="author" content="Sam Kirk" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Documentation generated using AI to explain codebases" /> <meta property="og:description" content="Documentation generated using AI to explain codebases" /> <link rel="canonical" href="http://localhost:4000/mojo-v2/04_strides_and_offset_computation_.html" /> <meta property="og:url" content="http://localhost:4000/mojo-v2/04_strides_and_offset_computation_.html" /> <meta property="og:site_name" content="Two Tutorials for Mojo using Pocket Flow" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Chapter 4: Strides and Offset Computation" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Sam Kirk","url":"https://www.linkedin.com/in/samuelkirk"},"description":"Documentation generated using AI to explain codebases","headline":"Chapter 4: Strides and Offset Computation","url":"http://localhost:4000/mojo-v2/04_strides_and_offset_computation_.html"}</script> <!-- End Jekyll SEO tag --> <!-- Add Mermaid support --> <script src="https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js"></script> <script> document.addEventListener("DOMContentLoaded", function() { mermaid.initialize({ startOnLoad: true, theme: "default" }); // Process code blocks document.querySelectorAll('pre code.language-mermaid').forEach(function(block) { // Create a div with class 'mermaid' var mermaidDiv = document.createElement('div'); mermaidDiv.className = 'mermaid'; mermaidDiv.innerHTML = block.textContent; // Replace the parent pre with the mermaid div block.parentNode.parentNode.replaceChild(mermaidDiv, block.parentNode); console.log("Processed Mermaid block:", mermaidDiv.innerHTML.substring(0, 50) + "..."); }); console.log("Mermaid initialization complete. Version:", mermaid.version()); }); </script> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> Two Tutorials for Mojo using Pocket Flow </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">README</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Crawl4AI category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/Crawl4AI/" class="nav-list-link">Crawl4AI</a><ul class="nav-list"><li class="nav-list-item "><a href="/Crawl4AI/01_asynccrawlerstrategy.html" class="nav-list-link">AsyncCrawlerStrategy</a></li><li class="nav-list-item "><a href="/Crawl4AI/01_configuration_system_.html" class="nav-list-link">Chapter 1: Configuration System</a></li><li class="nav-list-item "><a href="/Crawl4AI/02_asyncwebcrawler.html" class="nav-list-link">AsyncWebCrawler</a></li><li class="nav-list-item "><a href="/Crawl4AI/02_asyncwebcrawler_.html" class="nav-list-link">Chapter 2: AsyncWebCrawler</a></li><li class="nav-list-item "><a href="/Crawl4AI/03_content_extraction_pipeline_.html" class="nav-list-link">Chapter 3: Content Extraction Pipeline</a></li><li class="nav-list-item "><a href="/Crawl4AI/03_crawlerrunconfig.html" class="nav-list-link">CrawlerRunConfig</a></li><li class="nav-list-item "><a href="/Crawl4AI/04_contentscrapingstrategy.html" class="nav-list-link">ContentScrapingStrategy</a></li><li class="nav-list-item "><a href="/Crawl4AI/04_url_filtering___scoring_.html" class="nav-list-link">Chapter 4: URL Filtering & Scoring</a></li><li class="nav-list-item "><a href="/Crawl4AI/05_deep_crawling_system_.html" class="nav-list-link">Chapter 5: Deep Crawling System</a></li><li class="nav-list-item "><a href="/Crawl4AI/05_relevantcontentfilter.html" class="nav-list-link">RelevantContentFilter</a></li><li class="nav-list-item "><a href="/Crawl4AI/06_caching_system_.html" class="nav-list-link">Chapter 6: Caching System</a></li><li class="nav-list-item "><a href="/Crawl4AI/06_extractionstrategy.html" class="nav-list-link">ExtractionStrategy</a></li><li class="nav-list-item "><a href="/Crawl4AI/07_crawlresult.html" class="nav-list-link">CrawlResult</a></li><li class="nav-list-item "><a href="/Crawl4AI/07_dispatcher_framework_.html" class="nav-list-link">Chapter 7: Dispatcher Framework</a></li><li class="nav-list-item "><a href="/Crawl4AI/08_async_logging_infrastructure_.html" class="nav-list-link">Chapter 8: Async Logging Infrastructure</a></li><li class="nav-list-item "><a href="/Crawl4AI/08_deepcrawlstrategy.html" class="nav-list-link">DeepCrawlStrategy</a></li><li class="nav-list-item "><a href="/Crawl4AI/09_cachecontext___cachemode.html" class="nav-list-link">CacheContext & CacheMode</a></li><li class="nav-list-item "><a href="/Crawl4AI/09_api___docker_integration_.html" class="nav-list-link">Chapter 9: API & Docker Integration</a></li><li class="nav-list-item "><a href="/Crawl4AI/10_basedispatcher.html" class="nav-list-link">BaseDispatcher</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in My Tutorial for Crawl4ai category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/my-crawl4AI/" class="nav-list-link">My Tutorial for Crawl4ai</a><ul class="nav-list"><li class="nav-list-item "><a href="/my-crawl4ai/01_configuration_system_.html" class="nav-list-link">Chapter 1: Configuration System</a></li><li class="nav-list-item "><a href="/my-crawl4ai/02_asyncwebcrawler_.html" class="nav-list-link">Chapter 2: AsyncWebCrawler</a></li><li class="nav-list-item "><a href="/my-crawl4ai/03_content_extraction_pipeline_.html" class="nav-list-link">Chapter 3: Content Extraction Pipeline</a></li><li class="nav-list-item "><a href="/my-crawl4ai/04_url_filtering___scoring_.html" class="nav-list-link">Chapter 4: URL Filtering & Scoring</a></li><li class="nav-list-item "><a href="/my-crawl4ai/05_deep_crawling_system_.html" class="nav-list-link">Chapter 5: Deep Crawling System</a></li><li class="nav-list-item "><a href="/my-crawl4ai/06_caching_system_.html" class="nav-list-link">Chapter 6: Caching System</a></li><li class="nav-list-item "><a href="/my-crawl4ai/07_dispatcher_framework_.html" class="nav-list-link">Chapter 7: Dispatcher Framework</a></li><li class="nav-list-item "><a href="/my-crawl4ai/08_async_logging_infrastructure_.html" class="nav-list-link">Chapter 8: Async Logging Infrastructure</a></li><li class="nav-list-item "><a href="/my-crawl4ai/09_api___docker_integration_.html" class="nav-list-link">Chapter 9: API & Docker Integration</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in My Tutorial for Modular's Max category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/modular_max/" class="nav-list-link">My Tutorial for Modular's Max</a><ul class="nav-list"><li class="nav-list-item "><a href="/modular_max/01_settings___settings__class__.html" class="nav-list-link">Chapter 1: Settings Class</a></li><li class="nav-list-item "><a href="/modular_max/02_serving_api_layer__fastapi_app___routers__.html" class="nav-list-link">Chapter 2: Serving API Layer</a></li><li class="nav-list-item "><a href="/modular_max/03_llm_pipeline_orchestrator___tokengeneratorpipeline___.html" class="nav-list-link">Chapter 3: LLM Pipeline Orchestrator</a></li><li class="nav-list-item "><a href="/modular_max/04_model_worker_.html" class="nav-list-link">Chapter 4: Model Worker</a></li><li class="nav-list-item "><a href="/modular_max/05_scheduler___tokengenerationscheduler____embeddingsscheduler___.html" class="nav-list-link">Chapter 5: Scheduler</a></li><li class="nav-list-item "><a href="/modular_max/06_kv_cache_management_.html" class="nav-list-link">Chapter 6: KV Cache Management</a></li><li class="nav-list-item "><a href="/modular_max/07_enginequeue_.html" class="nav-list-link">Chapter 7: EngineQueue</a></li><li class="nav-list-item "><a href="/modular_max/08_telemetry_and_metrics___metrics____metricclient___.html" class="nav-list-link">Chapter 8: Telemetry and Metrics</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in My Tutorial for Mojo v1 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/mojo-v1/" class="nav-list-link">My Tutorial for Mojo v1</a><ul class="nav-list"><li class="nav-list-item "><a href="/mojo-v1/01_addressspace_.html" class="nav-list-link">Chapter 1: AddressSpace</a></li><li class="nav-list-item "><a href="/mojo-v1/02_unsafepointer_.html" class="nav-list-link">Chapter 2: UnsafePointer</a></li><li class="nav-list-item "><a href="/mojo-v1/03_indexlist_.html" class="nav-list-link">Chapter 3: IndexList</a></li><li class="nav-list-item "><a href="/mojo-v1/04_dimlist_.html" class="nav-list-link">Chapter 4: DimList</a></li><li class="nav-list-item "><a href="/mojo-v1/05_ndbuffer_.html" class="nav-list-link">Chapter 5: NDBuffer</a></li><li class="nav-list-item "><a href="/mojo-v1/06_n_d_to_1d_indexing_logic__strided_memory_access__.html" class="nav-list-link">Chapter 6: N-D to 1D Indexing Logic</a></li></ul></li><li class="nav-list-item active"><button class="nav-list-expander btn-reset" aria-label="toggle items in My Tutorial for Mojo v2 category" aria-pressed="true"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/mojo-v2/" class="nav-list-link">My Tutorial for Mojo v2</a><ul class="nav-list"><li class="nav-list-item "><a href="/mojo-v2/01_unsafepointer__as_used_by_ndbuffer__.html" class="nav-list-link">Chapter 1: UnsafePointer</a></li><li class="nav-list-item "><a href="/mojo-v2/02_dimlist_and_dim_.html" class="nav-list-link">Chapter 2: DimList and Dim</a></li><li class="nav-list-item "><a href="/mojo-v2/03_ndbuffer_.html" class="nav-list-link">Chapter 3: NDBuffer</a></li><li class="nav-list-item active"><a href="/mojo-v2/04_strides_and_offset_computation_.html" class="nav-list-link active">Chapter 4: Strides and Offset Computation</a></li><li class="nav-list-item "><a href="/mojo-v2/05_simd_data_access_.html" class="nav-list-link">Chapter 5: SIMD Data Access</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Comparisons category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/comparisons/" class="nav-list-link">Comparisons</a><ul class="nav-list"><li class="nav-list-item "><a href="/comparisons/crawl4ai-versions.html" class="nav-list-link">The original version of Crawl4AI vs. the sanity check I did</a></li><li class="nav-list-item "><a href="/comparisons/mojo-versions.html" class="nav-list-link">The 1st version of the Mojo Tutorial vs. The 2nd version of the Mojo Tutorial</a></li></ul></li><li class="nav-list-item"><a href="/generating/" class="nav-list-link">Generating & Preparing for the Mojo Tutorials using Pocket Flow</a></li><li class="nav-list-item"><a href="/design.html" class="nav-list-link">System Design</a></li></ul> <div class="nav-category">Crawl4AI</div> <ul class="nav-list"></ul> <div class="nav-category">Modular Max</div> <ul class="nav-list"></ul> <div class="nav-category">Mojo (v1)</div> <ul class="nav-list"></ul> <div class="nav-category">Mojo (v2)</div> <ul class="nav-list"></ul> <div class="nav-category">Generating</div> <ul class="nav-list"></ul> <div class="nav-category">AI Design</div> <ul class="nav-list"></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Two Tutorials for Mojo using Pocket Flow" aria-label="Search Two Tutorials for Mojo using Pocket Flow" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/MrBesterTester/pf-understand" class="site-button" > View on GitHub </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/mojo-v2/">My Tutorial for Mojo v2</a></li> <li class="breadcrumb-nav-list-item"><span>Chapter 4: Strides and Offset Computation</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="chapter-4-strides-and-offset-computation"> <a href="#chapter-4-strides-and-offset-computation" class="anchor-heading" aria-labelledby="chapter-4-strides-and-offset-computation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Chapter 4: Strides and Offset Computation </h1> <p>Okay, here’s Chapter 4 of the Mojo tutorial, focusing on Strides and Offset Computation, designed to be very beginner-friendly.</p> <h1 id="chapter-4-finding-your-way---strides-and-offset-computation"> <a href="#chapter-4-finding-your-way---strides-and-offset-computation" class="anchor-heading" aria-labelledby="chapter-4-finding-your-way---strides-and-offset-computation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Chapter 4: Finding Your Way - Strides and Offset Computation </h1> <p>In the previous chapters, we’ve learned a lot about <code class="language-plaintext highlighter-rouge">NDBuffer</code>:</p> <ul> <li>It uses an <code class="language-plaintext highlighter-rouge">UnsafePointer</code> (its <code class="language-plaintext highlighter-rouge">data</code> field) to know the memory address where its elements begin (<a href="01_unsafepointer__as_used_by_ndbuffer__.md">Chapter 1</a>).</li> <li>It uses <code class="language-plaintext highlighter-rouge">DimList</code> to define its <code class="language-plaintext highlighter-rouge">shape</code> (the size of each dimension), which can be static or dynamic (<a href="02_dimlist_and_dim_.md">Chapter 2</a>).</li> <li>The <code class="language-plaintext highlighter-rouge">NDBuffer</code> struct itself combines these pieces of information to act as a “lens” on N-dimensional data (<a href="03_ndbuffer_.md">Chapter 3</a>), storing the actual runtime shape in its <code class="language-plaintext highlighter-rouge">dynamic_shape</code> field and, as we’ll see, runtime strides in <code class="language-plaintext highlighter-rouge">dynamic_stride</code>.</li> </ul> <p>Now, a crucial question arises: if an <code class="language-plaintext highlighter-rouge">NDBuffer</code> represents a 2D grid (like a matrix <code class="language-plaintext highlighter-rouge">matrix[row, col]</code>) or even a 3D cube, but computer memory is just one long, flat line of storage cells, how does <code class="language-plaintext highlighter-rouge">NDBuffer</code> find the exact memory location for a specific element, say, at <code class="language-plaintext highlighter-rouge">matrix[1, 2]</code>?</p> <p>This is where <strong>strides</strong> and <strong>offset computation</strong> come into play. They are the magic map <code class="language-plaintext highlighter-rouge">NDBuffer</code> uses to navigate its N-dimensional view of 1D memory.</p> <p>As the project overview puts it:</p> <blockquote> <p>This refers to the core mechanism <code class="language-plaintext highlighter-rouge">NDBuffer</code> uses to locate any specific element within its N-dimensional view of memory. Given an N-dimensional index (e.g., <code class="language-plaintext highlighter-rouge">[row, col]</code>), the <code class="language-plaintext highlighter-rouge">NDBuffer</code> calculates a 1D offset from its base <code class="language-plaintext highlighter-rouge">data</code> pointer. This calculation relies on <code class="language-plaintext highlighter-rouge">strides</code>: an array where each element specifies how many memory items to skip to advance one step along the corresponding dimension.</p> </blockquote> <h2 id="the-memory-maze-from-n-dimensions-to-one-dimension"> <a href="#the-memory-maze-from-n-dimensions-to-one-dimension" class="anchor-heading" aria-labelledby="the-memory-maze-from-n-dimensions-to-one-dimension"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Memory Maze: From N-Dimensions to One Dimension </h2> <p>Imagine your computer’s memory as a single, incredibly long bookshelf. Each spot on the shelf can hold one data element (like one number). This bookshelf is 1-dimensional.</p> <p>However, we often want to work with data in more dimensions:</p> <ul> <li>A list of numbers (1D)</li> <li>A table or spreadsheet (2D)</li> <li>A stack of images, forming a video (3D)</li> </ul> <p><code class="language-plaintext highlighter-rouge">NDBuffer</code> allows us to <em>think</em> about our data in these convenient N-dimensional ways. But underneath, the data still lives on that 1D bookshelf. The challenge is to create a system that can translate an N-dimensional coordinate (like “row 2, column 5”) into a single, unique position on the 1D bookshelf.</p> <h2 id="introducing-strides-your-memory-navigation-map"> <a href="#introducing-strides-your-memory-navigation-map" class="anchor-heading" aria-labelledby="introducing-strides-your-memory-navigation-map"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introducing Strides: Your Memory Navigation Map </h2> <p><strong>Strides</strong> are the key to this translation. For an N-dimensional <code class="language-plaintext highlighter-rouge">NDBuffer</code>, the strides are a list of numbers, with one number for each dimension. Each number in the strides list tells you:</p> <blockquote> <p>“To move one step forward in <em>this particular dimension</em>, while keeping your position in all other dimensions the same, how many actual items do you need to skip over in the 1D memory?”</p> </blockquote> <p>Let’s use the <strong>multi-story car park analogy</strong> from the project description: Imagine your <code class="language-plaintext highlighter-rouge">NDBuffer.data</code> pointer is the entrance to a vast, continuous parking lot (our 1D memory). You want to <em>organize</em> this flat lot to represent a multi-story car park with levels, rows within levels, and spots within rows (your N-D view).</p> <p>Let’s say you want to find your car using its <code class="language-plaintext highlighter-rouge">[level_index, row_index, spot_index]</code>.</p> <ul> <li><strong><code class="language-plaintext highlighter-rouge">NDBuffer.data</code></strong>: The entrance to the entire car park.</li> <li><strong>N-D Index (e.g., <code class="language-plaintext highlighter-rouge">[level, row, spot]</code>)</strong>: How you conceptually remember your car’s location.</li> <li><strong>Shape (e.g., <code class="language-plaintext highlighter-rouge">[num_levels, num_rows_per_level, num_spots_per_row]</code>)</strong>: The capacity and structure of your conceptual car park.</li> <li><strong>Strides</strong>: This is your navigation guide. <ul> <li><code class="language-plaintext highlighter-rouge">stride_spot</code>: How many actual 1D parking spaces do you move to get from <code class="language-plaintext highlighter-rouge">spot_X</code> to <code class="language-plaintext highlighter-rouge">spot_X+1</code> <em>in the same row and on the same level</em>? (This is usually 1, as spots are typically side-by-side).</li> <li><code class="language-plaintext highlighter-rouge">stride_row</code>: How many actual 1D parking spaces do you move to get from <code class="language-plaintext highlighter-rouge">spot_X</code> in <code class="language-plaintext highlighter-rouge">row_Y</code> to <code class="language-plaintext highlighter-rouge">spot_X</code> in <code class="language-plaintext highlighter-rouge">row_Y+1</code> <em>on the same level</em>? (This would be the total number of spots in one complete row, e.g., <code class="language-plaintext highlighter-rouge">num_spots_per_row</code>).</li> <li><code class="language-plaintext highlighter-rouge">stride_level</code>: How many actual 1D parking spaces do you move to get from <code class="language-plaintext highlighter-rouge">spot_X</code> in <code class="language-plaintext highlighter-rouge">row_Y</code> on <code class="language-plaintext highlighter-rouge">level_Z</code> to <code class="language-plaintext highlighter-rouge">spot_X</code> in <code class="language-plaintext highlighter-rouge">row_Y</code> on <code class="language-plaintext highlighter-rouge">level_Z+1</code>? (This would be the total number of spots on one entire level, e.g., <code class="language-plaintext highlighter-rouge">num_spots_per_row * num_rows_per_level</code>).</li> </ul> </li> </ul> <p>The <code class="language-plaintext highlighter-rouge">NDBuffer</code> stores these runtime stride values in its <code class="language-plaintext highlighter-rouge">dynamic_stride</code> field (which is an <code class="language-plaintext highlighter-rouge">IndexList</code>, similar to <code class="language-plaintext highlighter-rouge">dynamic_shape</code>).</p> <h2 id="contiguous-memory-and-calculating-default-strides-_compute_ndbuffer_stride"> <a href="#contiguous-memory-and-calculating-default-strides-_compute_ndbuffer_stride" class="anchor-heading" aria-labelledby="contiguous-memory-and-calculating-default-strides-_compute_ndbuffer_stride"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Contiguous Memory and Calculating Default Strides (<code class="language-plaintext highlighter-rouge">_compute_ndbuffer_stride</code>) </h2> <p>Often, N-dimensional data is stored “contiguously” in memory. This means the elements are packed tightly together without any gaps, in a predictable order. A very common contiguous layout is <strong>row-major order</strong> (also known as C-style order for arrays).</p> <p><strong>Row-Major Order (Example: 2D Matrix)</strong> Imagine a 2x3 matrix (2 rows, 3 columns):</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A = | a b c |
    | d e f |
</code></pre></div></div> <p>In row-major order, this matrix would be stored in memory as a flat sequence: <code class="language-plaintext highlighter-rouge">a, b, c, d, e, f</code>. The first row (<code class="language-plaintext highlighter-rouge">a, b, c</code>) is laid out completely, followed by the second row (<code class="language-plaintext highlighter-rouge">d, e, f</code>).</p> <p>For such a contiguous, row-major layout, <code class="language-plaintext highlighter-rouge">NDBuffer</code> can calculate default strides. The Mojo standard library provides the <code class="language-plaintext highlighter-rouge">_compute_ndbuffer_stride</code> function (found in <code class="language-plaintext highlighter-rouge">stdlib/src/buffer/buffer.mojo</code>) for this. Here’s how it generally works:</p> <ol> <li>The stride for the <strong>innermost (last) dimension</strong> is always <strong>1</strong>. (To go to the next column in the same row, you just move to the very next element in memory).</li> <li>For any other dimension <code class="language-plaintext highlighter-rouge">d</code>, its stride is calculated by taking the size (from the <code class="language-plaintext highlighter-rouge">shape</code>) of the <em>next</em> dimension (<code class="language-plaintext highlighter-rouge">d+1</code>) and multiplying it by the stride of that <em>next</em> dimension (<code class="language-plaintext highlighter-rouge">d+1</code>). You work your way from the inside out.</li> </ol> <p>Let’s calculate default strides for our 2x3 matrix <code class="language-plaintext highlighter-rouge">A</code>.</p> <ul> <li>Shape: <code class="language-plaintext highlighter-rouge">[2, 3]</code> (rows=2, columns=3)</li> <li>Rank (number of dimensions): 2</li> </ul> <ol> <li> <p><strong>Innermost dimension (columns, dimension index 1)</strong>: <code class="language-plaintext highlighter-rouge">stride_col = dynamic_stride[1] = 1</code></p> </li> <li> <p><strong>Next dimension moving outwards (rows, dimension index 0)</strong>: <code class="language-plaintext highlighter-rouge">stride_row = dynamic_stride[0] = shape[1] * dynamic_stride[1]</code> <code class="language-plaintext highlighter-rouge">stride_row = 3 * 1 = 3</code></p> </li> </ol> <p>So, for a 2x3 row-major matrix, the default strides are <code class="language-plaintext highlighter-rouge">[3, 1]</code>.</p> <ul> <li>To move to the next element in the same row (advance one column), you jump 1 memory spot.</li> <li>To move to the same column position in the next row (advance one row), you jump 3 memory spots (which is the entire length of a row).</li> </ul> <p>The <code class="language-plaintext highlighter-rouge">_compute_ndbuffer_stride</code> function in <code class="language-plaintext highlighter-rouge">buffer.mojo</code> implements this logic:</p><pre><code class="language-mojo">@always_inline
fn _compute_ndbuffer_stride[
    rank: Int
](shape: IndexList[rank, **_]) -&gt; __type_of(shape):
    """Computes the NDBuffer's default dynamic strides using the input shape.
    The default strides correspond to contiguous memory layout.
    ...
    """
    constrained[rank &gt; 0]()

    @parameter
    if rank == 1: // Special case for 1D arrays
        return __type_of(shape)(1) // Stride is just 1

    var stride = shape // Temporary, will be overwritten
    stride[rank - 1] = 1 // Stride for the innermost dimension is 1

    // Iterate from the second-to-last dimension backwards to the first
    @parameter
    for i in reversed(range(rank - 1)): // Correctly iterates i from rank-2 down to 0
                                         // Example: rank=2, i=0. stride[0]=shape[1]*stride[1]
                                         // Example: rank=3, i=1,0. stride[1]=shape[2]*stride[2], then stride[0]=shape[1]*stride[1]
        stride[i] = shape[i + 1] * stride[i + 1]

    return stride
</code></pre><p>When you create an <code class="language-plaintext highlighter-rouge">NDBuffer</code> and don’t explicitly provide strides, this function is typically used to calculate them based on the shape, assuming a contiguous, row-major layout.</p> <h2 id="calculating-the-offset-finding-the-exact-spot-_compute_ndbuffer_offset"> <a href="#calculating-the-offset-finding-the-exact-spot-_compute_ndbuffer_offset" class="anchor-heading" aria-labelledby="calculating-the-offset-finding-the-exact-spot-_compute_ndbuffer_offset"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Calculating the Offset: Finding the Exact Spot (<code class="language-plaintext highlighter-rouge">_compute_ndbuffer_offset</code>) </h2> <p>Once an <code class="language-plaintext highlighter-rouge">NDBuffer</code> has:</p> <ol> <li>Its <code class="language-plaintext highlighter-rouge">data</code> pointer (the starting address of the memory block).</li> <li>The N-dimensional <code class="language-plaintext highlighter-rouge">index</code> of the element you want (e.g., <code class="language-plaintext highlighter-rouge">[row_idx, col_idx]</code>).</li> <li>Its <code class="language-plaintext highlighter-rouge">dynamic_stride</code> list (e.g., <code class="language-plaintext highlighter-rouge">[stride_for_row, stride_for_col]</code>).</li> </ol> <p>It can calculate the 1D <strong>offset</strong> from the <code class="language-plaintext highlighter-rouge">data</code> pointer to your desired element. The formula is a sum of products:</p> <p><code class="language-plaintext highlighter-rouge">offset = (index_dim0 * stride_dim0) + (index_dim1 * stride_dim1) + ... + (index_dimN-1 * stride_dimN-1)</code></p> <p>Let’s use our 2x3 matrix <code class="language-plaintext highlighter-rouge">A</code> again:</p> <ul> <li><code class="language-plaintext highlighter-rouge">data</code> points to where <code class="language-plaintext highlighter-rouge">a</code> is stored.</li> <li>Shape <code class="language-plaintext highlighter-rouge">[2, 3]</code>.</li> <li>Strides <code class="language-plaintext highlighter-rouge">[3, 1]</code>. (i.e., <code class="language-plaintext highlighter-rouge">stride_row = 3</code>, <code class="language-plaintext highlighter-rouge">stride_col = 1</code>)</li> </ul> <p>Suppose we want to find element <code class="language-plaintext highlighter-rouge">A[1, 2]</code> (this is element <code class="language-plaintext highlighter-rouge">f</code> in <code class="language-plaintext highlighter-rouge">[[a,b,c], [d,e,f]]</code>). The N-D index is <code class="language-plaintext highlighter-rouge">[1, 2]</code>.</p> <ul> <li><code class="language-plaintext highlighter-rouge">row_idx = 1</code></li> <li><code class="language-plaintext highlighter-rouge">col_idx = 2</code></li> </ul> <p><code class="language-plaintext highlighter-rouge">offset = (row_idx * stride_row) + (col_idx * stride_col)</code> <code class="language-plaintext highlighter-rouge">offset = (1 * 3) + (2 * 1)</code> <code class="language-plaintext highlighter-rouge">offset = 3 + 2</code> <code class="language-plaintext highlighter-rouge">offset = 5</code></p> <p>This means element <code class="language-plaintext highlighter-rouge">A[1, 2]</code> is 5 memory spots away from the start (<code class="language-plaintext highlighter-rouge">data</code>). If <code class="language-plaintext highlighter-rouge">data</code> points to memory location <code class="language-plaintext highlighter-rouge">P</code>:</p> <ul> <li><code class="language-plaintext highlighter-rouge">P+0</code>: <code class="language-plaintext highlighter-rouge">a</code> (<code class="language-plaintext highlighter-rouge">A[0,0]</code>)</li> <li><code class="language-plaintext highlighter-rouge">P+1</code>: <code class="language-plaintext highlighter-rouge">b</code> (<code class="language-plaintext highlighter-rouge">A[0,1]</code>)</li> <li><code class="language-plaintext highlighter-rouge">P+2</code>: <code class="language-plaintext highlighter-rouge">c</code> (<code class="language-plaintext highlighter-rouge">A[0,2]</code>)</li> <li><code class="language-plaintext highlighter-rouge">P+3</code>: <code class="language-plaintext highlighter-rouge">d</code> (<code class="language-plaintext highlighter-rouge">A[1,0]</code>)</li> <li><code class="language-plaintext highlighter-rouge">P+4</code>: <code class="language-plaintext highlighter-rouge">e</code> (<code class="language-plaintext highlighter-rouge">A[1,1]</code>)</li> <li><code class="language-plaintext highlighter-rouge">P+5</code>: <code class="language-plaintext highlighter-rouge">f</code> (<code class="language-plaintext highlighter-rouge">A[1,2]</code>) &lt;– We found it!</li> </ul> <p>The <code class="language-plaintext highlighter-rouge">NDBuffer</code> method <code class="language-plaintext highlighter-rouge">_offset()</code> uses the helper function <code class="language-plaintext highlighter-rouge">_compute_ndbuffer_offset</code> to do exactly this. Here’s a simplified look at <code class="language-plaintext highlighter-rouge">_compute_ndbuffer_offset</code> from <code class="language-plaintext highlighter-rouge">buffer.mojo</code>:</p><pre><code class="language-mojo">@always_inline
fn _compute_ndbuffer_offset(
    buf: NDBuffer,
    index: VariadicList[Int], // Could also be StaticTuple or IndexList
) -&gt; Int:
    """Computes the NDBuffer's offset using the index positions provided.
    ...
    """
    // ... (rank 0 and 32-bit indexing checks omitted for simplicity) ...

    var result: Int = 0
    @parameter
    for i in range(buf.rank):
        // buf.stride[i]() gets the stride for the i-th dimension
        // index[i] gets the index for the i-th dimension
        // fma(a, b, c) is "fused multiply-add", calculates (a*b) + c efficiently
        result = fma(buf.stride[i](), index[i], result)
    return result
</code></pre><p>This function iterates through each dimension, multiplies the index for that dimension by its corresponding stride, and adds it to the accumulating <code class="language-plaintext highlighter-rouge">result</code>. This is the heart of how <code class="language-plaintext highlighter-rouge">NDBuffer</code> navigates its data.</p> <h2 id="the-power-of-strides-more-than-just-contiguous"> <a href="#the-power-of-strides-more-than-just-contiguous" class="anchor-heading" aria-labelledby="the-power-of-strides-more-than-just-contiguous"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Power of Strides: More Than Just Contiguous </h2> <p>The really cool thing about strides is that they aren’t limited to describing just standard row-major (or column-major) layouts. By manually defining or manipulating the strides, an <code class="language-plaintext highlighter-rouge">NDBuffer</code> can represent many different views of the same underlying memory <em>without copying any data</em>.</p> <ol> <li><strong>Column-Major Order (Fortran-style)</strong>: For our 2x3 matrix <code class="language-plaintext highlighter-rouge">A</code>, if it were stored column-by-column (<code class="language-plaintext highlighter-rouge">a, d, b, e, c, f</code>), the strides would be <code class="language-plaintext highlighter-rouge">[1, 2]</code>. <ul> <li><code class="language-plaintext highlighter-rouge">stride_row = 1</code>: To get to the next row in the same column, jump 1 spot.</li> <li><code class="language-plaintext highlighter-rouge">stride_col = 2</code>: To get to the next column, jump 2 spots (the length of a column).</li> </ul> </li> <li><strong>Slices (Views of Data)</strong>: Imagine you have a large 10x10 matrix, but you only want to work with a 3x3 sub-section of it (a slice). You can create a new <code class="language-plaintext highlighter-rouge">NDBuffer</code> for this 3x3 slice. This new <code class="language-plaintext highlighter-rouge">NDBuffer</code> would: <ul> <li>Have its <code class="language-plaintext highlighter-rouge">data</code> pointer offset to the start of the 3x3 region within the original 10x10 data.</li> <li>Have a <code class="language-plaintext highlighter-rouge">shape</code> of <code class="language-plaintext highlighter-rouge">[3, 3]</code>.</li> <li>Use the <strong>same strides</strong> as the original 10x10 matrix! No data is copied; the slice is just a different “lens” on the existing memory.</li> </ul> </li> <li> <p><strong>Transposed Matrices</strong>: You can “transpose” a matrix (swap its rows and columns) simply by changing its shape and strides, without moving data. If matrix <code class="language-plaintext highlighter-rouge">M</code> has shape <code class="language-plaintext highlighter-rouge">[R, C]</code> and strides <code class="language-plaintext highlighter-rouge">[stride_R, stride_C]</code>. Its transpose <code class="language-plaintext highlighter-rouge">M_T</code> will have shape <code class="language-plaintext highlighter-rouge">[C, R]</code> and strides <code class="language-plaintext highlighter-rouge">[stride_C, stride_R]</code>. Again, it’s a new view on the same data.</p> </li> <li><strong>Broadcasting</strong>: Sometimes in numerical computing, you want to operate between arrays of different shapes (e.g., adding a vector to each row of a matrix). Strides can help represent this. If a dimension has a stride of <code class="language-plaintext highlighter-rouge">0</code>, accessing any index along that “broadcasted” dimension will always return data from the same memory location(s). This effectively makes that dimension appear to repeat its data.</li> </ol> <p>This flexibility to represent various data layouts and views through strides makes <code class="language-plaintext highlighter-rouge">NDBuffer</code> incredibly efficient and powerful for tasks in scientific computing, machine learning, and data analysis, where avoiding data copies is crucial for performance.</p> <h2 id="key-takeaways-for-chapter-4"> <a href="#key-takeaways-for-chapter-4" class="anchor-heading" aria-labelledby="key-takeaways-for-chapter-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Key Takeaways for Chapter 4 </h2> <ul> <li><strong>Strides</strong> define how many memory items to skip to advance one step along each dimension of an <code class="language-plaintext highlighter-rouge">NDBuffer</code>.</li> <li><code class="language-plaintext highlighter-rouge">NDBuffer</code> uses the N-D index provided by you (e.g., <code class="language-plaintext highlighter-rouge">my_buffer[r,c]</code>) and its internal <code class="language-plaintext highlighter-rouge">dynamic_stride</code> values to calculate a 1D <strong>offset</strong> from its base <code class="language-plaintext highlighter-rouge">data</code> pointer.</li> <li>The function <code class="language-plaintext highlighter-rouge">_compute_ndbuffer_stride</code> (in <code class="language-plaintext highlighter-rouge">stdlib/src/buffer/buffer.mojo</code>) can calculate default strides for a contiguous, row-major memory layout based on the <code class="language-plaintext highlighter-rouge">NDBuffer</code>’s shape.</li> <li>The function <code class="language-plaintext highlighter-rouge">_compute_ndbuffer_offset</code> (in <code class="language-plaintext highlighter-rouge">stdlib/src/buffer/buffer.mojo</code>) performs the actual calculation: <code class="language-plaintext highlighter-rouge">offset = sum(index_dim_i * stride_dim_i)</code>.</li> <li>Strides are powerful because they allow <code class="language-plaintext highlighter-rouge">NDBuffer</code> to represent various memory layouts (row-major, column-major, slices, transposes, broadcasted arrays) efficiently, often without needing to copy the underlying data.</li> </ul> <h2 id="whats-next"> <a href="#whats-next" class="anchor-heading" aria-labelledby="whats-next"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> What’s Next? </h2> <p>We now understand how <code class="language-plaintext highlighter-rouge">NDBuffer</code> can pinpoint any individual element within its N-dimensional view. But in high-performance computing, we often want to read or write <em>multiple</em> elements at once to take advantage of modern CPU capabilities. This is where SIMD (Single Instruction, Multiple Data) operations come in.</p> <p>In the next chapter, <a href="05_simd_data_access_.md">Chapter 5: SIMD Data Access</a>, we’ll explore how <code class="language-plaintext highlighter-rouge">NDBuffer</code> allows you to load and store data in chunks, further boosting performance.</p><hr /> <p><em>Navigation</em></p> <ol> <li><a href="01_unsafepointer__as_used_by_ndbuffer__.md">UnsafePointer (as used by NDBuffer)</a></li> <li><a href="02_dimlist_and_dim_.md">DimList and Dim</a></li> <li><a href="03_ndbuffer_.md">NDBuffer</a></li> <li><strong>Strides and Offset Computation (You are here)</strong></li> <li><a href="05_simd_data_access_.md">SIMD Data Access</a> ```</li> </ol><hr /> <p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p> </main> </div> </div> <div class="search-overlay"></div> </div> <script type="module"> import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.esm.min.mjs'; var config = {} ; mermaid.initialize(config); mermaid.run({ querySelector: '.language-mermaid', }); </script> </body> </html>
